<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timetable - HangarPlanner</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Early apply saved dark mode to avoid flicker and ensure persistence on subpages -->
    <script>
      (function(){
        try {
          var isDark = false;
          try { var t = (localStorage.getItem('hangar.theme')||'').toLowerCase(); if (t==='dark') isDark = true; if (t==='light') isDark = false; } catch(e) {}
          if (!isDark) {
            var raw = localStorage.getItem('displayOptions');
            if (raw) {
              var parsed = JSON.parse(raw);
              if (parsed && parsed.darkMode) { isDark = true; }
            }
          }
          if (isDark) {
            document.documentElement.classList.add('dark-mode');
            var applyBody = function(){ if (document.body) document.body.classList.add('dark-mode'); };
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', applyBody);
            } else {
              applyBody();
            }
          }
        } catch (e) {}
      })();
    </script>

    <!-- Bestehende CSS-Dateien (wie Fleet Database) -->
    <link rel="stylesheet" href="css/hangarplanner-ui.css" />
    <link rel="stylesheet" href="css/info-widget.css" />
    <link rel="stylesheet" href="css/weather-widget.css" />
    <link rel="stylesheet" href="css/userinfo-widget.css" />
    <link rel="stylesheet" href="css/dark-mode-zoom.css" />
    <link rel="stylesheet" href="css/fleet-database.css" />

    <!-- Tailwind Konfiguration (wie Fleet Database) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "industrial-dark": "#2d3748",
              "industrial-medium": "#4a5568",
              "industrial-light": "#718096",
              "industrial-accent": "#ff7043",
            },
          },
        },
      };
    </script>

    <!-- Compact button overrides for small screens -->
    <style>
      @media (max-width: 768px) {
        #showAirportFlightsBtn {
          padding: 6px 10px !important;
          font-size: 0.875rem !important;
          line-height: 1.25rem !important;
        }
      }
    </style>
    <script>
      // Apply saved dark mode on subpage load
      document.addEventListener('DOMContentLoaded', function(){
        try {
          const raw = localStorage.getItem('displayOptions');
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && parsed.darkMode) {
              document.body.classList.add('dark-mode');
            }
          }
        } catch (e) {}
      });
    </script>
  </head>
  <body class="bg-industrial-dark text-white font-sans">
    <div class="flex h-screen">
      <!-- Hauptbereich im gleichen Stil wie Fleet Database -->
      <div class="flex-grow flex flex-col content-container">
        <!-- Header mit Zurück-Button -->
        <header class="bg-white p-4 shadow-md fleet-database-header">
          <div class="flex items-center space-x-4">
            <button id="backToMain" class="bg-industrial-accent text-white px-4 py-2 rounded hover:bg-industrial-medium transition-colors flex items-center">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
Back
            </button>
            <h1 class="text-xl font-bold text-industrial-dark">Timetable</h1>
          </div>
        </header>

        <!-- Inhalt in weißem Container mit Padding -->
        <div class="flex-grow bg-white p-4 overflow-auto hangar-container">
          <!-- Airport Flights Controls (im Fleet-Filter-Stil) -->
          <div class="mb-6 bg-gray-50 p-4 rounded-lg fleet-filters-enhanced">
            <h2 id="airportFlightsHeading" class="text-lg font-semibold text-industrial-dark mb-3">Flights on Station MUC</h2>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
              <!-- Airport -->
              <div>
                <label for="airportCodeInput" class="block text-sm font-medium text-gray-800 mb-1 whitespace-nowrap">Airport (IATA)</label>
                <input id="airportCodeInput" type="text" maxlength="3" value="MUC" placeholder="e.g., MUC" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white text-gray-900 uppercase focus:ring-2 focus:ring-industrial-accent focus:border-industrial-accent" style="text-transform: uppercase" />
              </div>
              <!-- Date -->
              <div>
                <label for="flightDateInput" class="block text-sm font-medium text-gray-800 mb-1 whitespace-nowrap">Date</label>
                <input id="flightDateInput" type="date" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white text-gray-900 focus:ring-2 focus:ring-industrial-accent focus:border-industrial-accent" />
              </div>
              <!-- Registration filter -->
              <div>
                <label for="flightRegFilter" class="block text-sm font-medium text-gray-800 mb-1 whitespace-nowrap">Registration</label>
                <input id="flightRegFilter" type="text" placeholder="e.g., D-AIZZ" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white text-gray-900 placeholder-gray-600 focus:ring-2 focus:ring-industrial-accent focus:border-industrial-accent" />
              </div>
              <!-- Flight number filter -->
              <div>
                <label for="flightNumberFilter" class="block text-sm font-medium text-gray-800 mb-1 whitespace-nowrap">Flight number</label>
                <input id="flightNumberFilter" type="text" placeholder="e.g., LH1234" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white text-gray-900 placeholder-gray-600 focus:ring-2 focus:ring-industrial-accent focus:border-industrial-accent" />
              </div>
              <!-- Airline Code (optional) -->
              <div id="operatorFilterContainer">
                <label for="operatorCodeInput" class="block text-sm font-medium text-gray-800 mb-1 whitespace-nowrap">Airline Code (optional)</label>
                <input id="operatorCodeInput" type="text" maxlength="3" value="LH" placeholder="e.g., LH, DLH" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white text-gray-900 uppercase placeholder-gray-600 focus:ring-2 focus:ring-industrial-accent focus:border-industrial-accent" style="text-transform: uppercase" />
              </div>
              <!-- Action -->
              <div class="flex items-end justify-end">
                <button id="showAirportFlightsBtn" class="fleet-action-btn-enhanced fleet-action-btn-primary self-end">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  Reload
                </button>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2">Enter an ICAO/IATA code to filter by airline</p>
            <div class="text-sm text-gray-600 mt-2">Ready to load flight data…</div>

            <!-- Seed Registration Cache (CSV) -->
            <div class="mt-4 p-3 rounded border border-gray-200 bg-white/60">
              <div class="flex items-center gap-3 flex-wrap">
                <span class="text-sm font-medium text-gray-800">Seed Registration Cache (CSV)</span>
                <input id="seedCsvInput" type="file" accept=".csv,text/csv" class="text-sm" />
                <button id="downloadCsvTemplate" class="px-2 py-1 text-sm rounded bg-gray-100 hover:bg-gray-200 text-gray-800 border border-gray-300">Template</button>
                <span id="seedCsvStatus" class="text-xs text-gray-600"></span>
              </div>
              <p class="text-xs text-gray-500 mt-2">CSV columns: flightNumber,date,registration (header optional). Example: LH1917,2025-09-06,D-AILD</p>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- JavaScript-Dateien (wie Fleet Database + Timetable spezifisch) -->
    <script src="js/helpers.js"></script>
    <script src="js/aerodatabox-api.js"></script>
    <script src="js/goflightlabs-api.js"></script>
    <script src="js/flight-registration-lookup.js"></script>
    <script src="js/fleet-database-manager.js"></script>
    <script src="js/airport-flights.js"></script>
    <script src="js/timetable-reload-adapter.js"></script>

    <!-- Back Button und einfache Filterlogik -->
    <script>
      // Navigation zurück zur Hauptseite
      document.getElementById('backToMain')?.addEventListener('click', function(){
        window.location.href = 'index.html';
      });

      // Update Heading with selected station
      function updateAirportFlightsHeading(){
        const code = (document.getElementById('airportCodeInput')?.value || '---').toUpperCase();
        const h = document.getElementById('airportFlightsHeading');
        if (h) h.textContent = `Flights on Station ${code}`;
      }
      document.getElementById('airportCodeInput')?.addEventListener('input', updateAirportFlightsHeading);
      // Default date today
      const dateEl = document.getElementById('flightDateInput');
      if (dateEl && !dateEl.value) {
        dateEl.value = new Date().toISOString().split('T')[0];
      }
      updateAirportFlightsHeading();

      // Einfache Client-Filter für Airport Flights Tabellen
      function applyAirportFlightsFilters() {
        const regFilter = (document.getElementById('flightRegFilter')?.value || '').trim().toUpperCase();
        const fnFilter = (document.getElementById('flightNumberFilter')?.value || '').trim().toUpperCase();
        const opFilter = (document.getElementById('operatorCodeInput')?.value || '').trim().toUpperCase();
        const container = document.getElementById('airport-flights-container');
        if (!container) return;
        const rows = container.querySelectorAll('table tbody tr');
        rows.forEach(row => {
          const regCell = row.querySelector('.flight-reg');
          const numCell = row.querySelector('.flight-number');
          const regText = (regCell?.textContent || '').toUpperCase();
          const numText = (numCell?.textContent || '').toUpperCase();
          const airlineIata = (row.dataset.airlineIata || '').toUpperCase();
          const airlineIcao = (row.dataset.airlineIcao || '').toUpperCase();
          const matchesReg = !regFilter || regText.includes(regFilter);
          const matchesNum = !fnFilter || numText.includes(fnFilter);
          const matchesOp = !opFilter || airlineIata.includes(opFilter) || airlineIcao.includes(opFilter) || numText.startsWith(opFilter);
          row.style.display = (matchesReg && matchesNum && matchesOp) ? '' : 'none';
        });
      }
      ['flightRegFilter', 'flightNumberFilter', 'operatorCodeInput'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', applyAirportFlightsFilters);
      });
      const flightsObserver = new MutationObserver(() => applyAirportFlightsFilters());
      const observeTargetInit = () => {
        const target = document.getElementById('airport-flights-container');
        if (target) flightsObserver.observe(target, { childList: true, subtree: true });
      };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', observeTargetInit);
      } else {
        observeTargetInit();
      }

      // CSV seeding logic
      (function setupCsvSeeding(){
        const statusEl = () => document.getElementById('seedCsvStatus');
        const setStatus = (msg, ok=true) => { const el=statusEl(); if (el){ el.textContent=msg; el.className= ok? 'text-xs text-green-700' : 'text-xs text-red-700'; } };
        function downloadTemplate(){
          const csv = 'flightNumber,date,registration\nLH1917,2025-09-06,D-AILD\nLH118,2025-09-06,D-AILB\n';
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'tail-cache-template.csv'; a.click();
          setTimeout(() => URL.revokeObjectURL(url), 500);
        }
        function parseCsv(text){
          const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
          if (!lines.length) return [];
          const sep = lines[0].includes(';') && !lines[0].includes(',') ? ';' : ',';
          let start = 0; let idxFlight=0, idxDate=1, idxReg=2;
          const header = lines[0].split(sep).map(s=>s.trim().toLowerCase());
          if (header.some(h=>['flight','flightnumber','number'].includes(h)) || header.includes('date') || header.includes('registration')){
            idxFlight = header.findIndex(h=>['flight','flightnumber','number'].includes(h));
            idxDate = header.findIndex(h=>h==='date');
            idxReg = header.findIndex(h=>['registration','reg','tail'].includes(h));
            start = 1;
          }
          const out=[];
          for (let i=start;i<lines.length;i++){
            const parts = lines[i].split(sep);
            const flight = (parts[idxFlight]||'').replace(/\s+/g,'').toUpperCase();
            const date = (parts[idxDate]||'').trim();
            const reg = (parts[idxReg]||'').trim().toUpperCase();
            if (flight && date && reg) out.push({flight, date, reg});
          }
          return out;
        }
        function applyToRenderedTable(){
          try{
            const container = document.getElementById('airport-flights-container');
            if (!container) return;
            const rows = container.querySelectorAll('table tbody tr');
            rows.forEach(tr=>{
              const numEl = tr.querySelector('.flight-number');
              const regCell = tr.querySelector('.flight-reg');
              if (!numEl || !regCell) return;
              const flight = (numEl.textContent||'').replace(/\s+/g,'').toUpperCase();
              const date = (document.getElementById('flightDateInput')?.value)|| new Date().toISOString().substring(0,10);
              const cached = window.FlightRegistrationLookup?.getCachedRegistration?.(flight, date);
              if (cached && (regCell.textContent||'').trim().length===0 || (regCell.textContent||'')==='-----' || (regCell.textContent||'')==='—'){
                regCell.textContent = cached;
              }
            });
          }catch(e){}
        }
        async function onCsvSelected(ev){
          try{
            const file = ev.target.files && ev.target.files[0];
            if (!file) return;
            const text = await file.text();
            const rows = parseCsv(text);
            if (!rows.length) { setStatus('No valid rows found', false); return; }
            let added=0;
            rows.forEach(r=>{
              const ok = window.FlightRegistrationLookup?.putCachedRegistration?.(r.flight, r.date, r.reg, 'csv');
              if (ok) added++;
            });
            setStatus(`Cached ${added}/${rows.length} entries`);
            applyToRenderedTable();
          } catch (e) {
            setStatus(`CSV import failed: ${e?.message||e}`, false);
          } finally {
            ev.target.value = '';
          }
        }
        document.getElementById('seedCsvInput')?.addEventListener('change', onCsvSelected);
        document.getElementById('downloadCsvTemplate')?.addEventListener('click', downloadTemplate);
      })();
    </script>
  </body>
</html>

