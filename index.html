<!DOCTYPE html>
<html lang="de">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Hangar Planner - Aircraft Management</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<!-- Inter font -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
		<!-- PDF Export Library -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
		<script>
			// Robuste Tailwind-Konfiguration mit Fallback
			function configureTailwind() {
				if (typeof tailwind !== "undefined") {
					tailwind.config = {
						theme: {
							extend: {
								fontFamily: { sans: ["Inter", "ui-sans-serif"] },
								colors: {
									industrial: {
										dark: "#3A4354",
										medium: "#5D6B89",
										light: "#D1D5DB",
										accent: "#FF7043",
									},
									status: {
										green: "#22C55E",
										yellow: "#F59E0B",
										red: "#EF4444",
									},
								},
							},
						},
					};
					console.log("✅ Tailwind konfiguriert");
				} else {
					console.log("⚠️ Tailwind nicht verfügbar - verwende CSS-Variablen");
					// CSS-Variablen als Fallback setzen
					document.documentElement.style.setProperty(
						"--industrial-dark",
						"#3A4354"
					);
					document.documentElement.style.setProperty(
						"--industrial-medium",
						"#5D6B89"
					);
					document.documentElement.style.setProperty(
						"--industrial-accent",
						"#FF7043"
					);
				}
			}

			// Verwende zentrale Initialisierung statt separate DOMContentLoaded Events
			window.hangarInitQueue = window.hangarInitQueue || [];
			window.hangarInitQueue.push(function () {
				configureTailwind();
			});

			// Sofort-Konfiguration falls Tailwind bereits verfügbar
			if (typeof tailwind !== "undefined") {
				configureTailwind();
			}
		</script>
		<link rel="stylesheet" href="css/hangarplanner-ui.css" />
		<link rel="stylesheet" href="css/dark-mode-zoom.css" />
		<link rel="stylesheet" href="css/weather-widget.css" />
		<link rel="stylesheet" href="css/info-widget.css" />
		<link rel="stylesheet" href="css/flight-data-status.css" />
		<!-- Early apply saved dark mode to avoid flicker and ensure persistence -->
		<script>
			(function(){
				try {
					var isDark = false;
					try { var t = (localStorage.getItem('hangar.theme')||'').toLowerCase(); if (t==='dark') isDark = true; if (t==='light') isDark = false; } catch(e) {}
					if (!isDark) {
						var raw = localStorage.getItem('displayOptions');
						if (raw) {
							var parsed = JSON.parse(raw);
							if (parsed && parsed.darkMode) { isDark = true; }
						}
					}
					if (isDark) {
						// Apply dark-mode to <html> immediately so generic .dark-mode selectors take effect
						document.documentElement.classList.add('dark-mode');
						// Ensure body also has dark-mode when available
						var applyBody = function(){ if (document.body) document.body.classList.add('dark-mode'); };
						if (document.readyState === 'loading') {
							document.addEventListener('DOMContentLoaded', applyBody);
						} else {
							applyBody();
						}
					}
				} catch (e) {}
			})();
		</script>
		<!-- Neue separate CSS-Datei -->
		<style>
			.status-neutral {
				background-color: white;
				border: 1px solid #ccc;
			}

			.tow-neutral {
				background-color: white;
				color: #333333;
			}

			/* Inline unit suffix for inputs like the Update interval field */
			.input-with-suffix {
				position: relative;
			}
			.input-with-suffix .input-suffix {
				position: absolute;
				right: 10px;
				top: 50%;
				transform: translateY(-50%);
				color: #6b7280; /* subtle grey */
				font-size: 12px;
				pointer-events: none;
			}
			.input-with-suffix .has-suffix {
				padding-right: 70px; /* space for 'Minutes' */
			}

			/* Utility: force-hide header widgets from Display toggles */
			.hide-weather-widget #weather-widget { display: none !important; }
			.hide-time-widget #time-widget { display: none !important; }

			/* Small reminder icon next to Tow Status */
			.tow-badge {
				display: inline-block;
				margin-left: 6px;
				line-height: 1;
				vertical-align: middle;
			}
			.tow-badge svg {
				width: 14px;
				height: 14px;
				stroke: #ef4444; /* red */
				fill: none;
				stroke-width: 2;
				stroke-linecap: round;
				stroke-linejoin: round;
				display: inline-block;
				vertical-align: middle;
			}

			/* Header badge inside Tow Reminder widget */
			.reminder-active-badge {
				display: inline-block;
				font-size: 12px;
				font-weight: 600;
				background: none;
				border: none;
				padding: 0;
			}
			.reminder-active-badge.active { color: #0d9488; }
			.reminder-active-badge.inactive { color: #6b7280; }

			/* Ensure Tow Reminder matches other header widget fonts and stays on one row */
			#towing-reminder-widget .status-row {
				display: flex;
				flex-wrap: nowrap;
				align-items: center;
				white-space: nowrap;
			}
			/* Align Tow widget typography to Status widget; overdue list styled via class */
			#towing-reminder-widget .status-label { color: #3a4354; font-weight: 500; }
			#towing-reminder-widget .status-label-value { color: #64748b; font-weight: 600; margin-left: 8px; }
			/* Second row (list) always red */
			#towingReminderList { color: #ef4444 !important; font-weight: 700; }
			.dark-mode #towing-reminder-widget .status-label { color: var(--text-secondary); }
			.dark-mode #towing-reminder-widget .status-label-value { color: #cbd5e1; }
			.dark-mode #towingReminderList { color: #ef4444 !important; }
		/* --- Schedule UI minimal styles (header tabs) --- */
		.tile-schedule-ui { margin-top: 0; border: none; border-radius: 0; padding: 0; flex: 1 1 auto; }
		.tile-schedule-ui .tile-tabbar { display: flex; gap: 6px; margin-bottom: 6px; justify-content: center; align-items: center; }
		.tile-schedule-ui .tile-tabbar .tab-btn { font-size: 12px; padding: 4px 10px; line-height: 1.4; border-radius: 0; border: none; color: #6b7280; background: transparent; border-bottom: 2px solid transparent; }
		.tile-schedule-ui .tile-tabbar .tab-btn[aria-selected="true"] { color: #111827; border-bottom-color: var(--menu-accent); }
		.tile-schedule-ui .tile-tabbar .tab-btn.time-active::after { content: " · Active"; font-weight: 600; color: #059669; }
		.tile-schedule-ui .tile-tabbar .tab-btn.time-next::after { content: " · Next"; font-weight: 600; color: #2563eb; }
		.tile-schedule-ui .booking-rows { }
		.tile-schedule-ui .booking-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; align-items: center; margin-bottom: 6px; }
		.tile-schedule-ui .booking-row:last-child { margin-bottom: 0; }
		.tile-schedule-ui .booking-row.is-active { background: rgba(34,197,94,0.08); outline: 1px solid rgba(34,197,94,0.35); border-radius: 4px; }
		.tile-schedule-ui .booking-row.is-next { background: rgba(59,130,246,0.06); outline: 1px dashed rgba(59,130,246,0.35); border-radius: 4px; }
		.tile-schedule-ui.is-conflict { border-left: 3px solid #ef4444; }
		.tile-schedule-ui input[type="text"], .tile-schedule-ui input[type="datetime-local"] { font-size: 12px; padding: 4px 6px; border: 1px solid #e5e7eb; border-radius: 4px; }
		.dark-mode .tile-schedule-ui { border-color: #374151; }
.dark-mode .tile-schedule-ui .tile-tabbar .tab-btn { background: transparent; color: var(--text-secondary); border: none; border-bottom: 2px solid transparent; }
.dark-mode .tile-schedule-ui .tile-tabbar .tab-btn[aria-selected="true"] { color: #ffffff; border-bottom-color: var(--menu-accent); }
		.dark-mode .tile-schedule-ui .tile-tabbar .tab-btn.time-active::after { color: #34d399; }
		.dark-mode .tile-schedule-ui .tile-tabbar .tab-btn.time-next::after { color: #60a5fa; }
		.dark-mode .tile-schedule-ui .booking-row.is-active { background: rgba(16,185,129,0.08); outline-color: rgba(16,185,129,0.45); }
		.dark-mode .tile-schedule-ui .booking-row.is-next { background: rgba(59,130,246,0.08); outline-color: rgba(59,130,246,0.45); }
		.dark-mode .tile-schedule-ui input[type="text"], .dark-mode .tile-schedule-ui input[type="datetime-local"] { background: #0b1220; color: #e5e7eb; border-color: #273449; }

		/* Global vertical schedule panel (inside planner grid) */
		#panel-planner .planner-grid { display: grid; grid-template-columns: minmax(0,1fr) 260px; gap: 12px; align-items: start; }
		#globalSchedulePanel { position: sticky; top: 8px; width: 100%; max-height: calc(100vh - 120px); overflow-y: auto; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); padding: 10px; }
		#globalSchedulePanel .panel-title { font-weight: 700; font-size: 13px; color: #374151; margin-bottom: 6px; }
		#globalScheduleList { display: flex; flex-direction: column; gap: 6px; }
		.schedule-item { display: grid; grid-template-columns: 64px 1fr; gap: 8px; align-items: center; padding: 6px 8px; border: 1px solid #e5e7eb; border-radius: 8px; }
		.schedule-item .time { font-weight: 700; color: #111827; }
		.schedule-item .meta { color: #6b7280; font-size: 12px; }
		.schedule-item.conflict { border-color: #ef4444; background: #fff1f2; }
		.dark-mode #globalSchedulePanel { background: var(--bg-primary); border-color: var(--border-color); box-shadow: none; }
		.dark-mode #globalSchedulePanel .panel-title { color: #e5e7eb; }
		.dark-mode .schedule-item { border-color: var(--border-color); background: var(--bg-secondary); }
		.dark-mode .schedule-item .time { color: #ffffff; }
		.dark-mode .schedule-item .meta { color: var(--text-secondary); }
		.dark-mode .schedule-item.conflict { border-color: #ef4444; background: rgba(239,68,68,0.08); }
		</style>
<script>
// Early auth guard: redirect unauthenticated users to /login.html
(function(){
  try {
    var xhr = new XMLHttpRequest();
xhr.open('GET', 'sync/auth.php?action=session', false); // synchronous, very early
    xhr.send(null);
    var ok = false;
    if (xhr.status === 200) {
      try { var data = JSON.parse(xhr.responseText||'{}'); ok = !!(data && data.success && data.user); } catch(e){}
    }
    if (!ok) {
window.location.replace('login.html');
    }
  } catch(e) { /* ignore; if it fails, page continues */ }
})();
</script>
</head>
<body class="bg-industrial-dark text-white font-sans edit-mode with-tabs">
		<div class="flex h-screen">
			<!-- Neue linke Hauptnavigation -->
			<nav id="leftMenu" class="left-menu">
				<button class="menu-item" data-menu="project" title="Project">
					<svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M3 6h14" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M17 4v4" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M3 12h18" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M13 10v4" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M3 18h10" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M9 16v4" />
					</svg>
					<span class="menu-label">Project</span>
				</button>
				<button class="menu-item" data-menu="display" title="Display">
					<svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16v10H4z" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M12 16v4" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M8 20h8" />
					</svg>
					<span class="menu-label">Display</span>
				</button>
				<button class="menu-item" data-menu="sync" title="Sync">
					<svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M3 12h18" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M7 8l-4 4 4 4" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4-4-4" />
					</svg>
					<span class="menu-label">Sync</span>
				</button>
				<button class="menu-item" data-menu="update" title="Update">
					<svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M20 20v-6h-6" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M5 20a9 9 0 0014-7" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M19 4a9 9 0 00-14 7" />
					</svg>
					<span class="menu-label">Update</span>
				</button>
				<button class="menu-item" data-menu="export" title="Export">
					<svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M12 3v12" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M8 11l4 4 4-4" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M4 21h16" />
					</svg>
					<span class="menu-label">Export</span>
				</button>
			</nav>

			<!-- Click-blocking scrim for submenu drawer -->
			<div id="submenu-scrim" class="submenu-scrim hidden" aria-hidden="true"></div>

			<!-- Platzhalter für Submenus (werden im nächsten Schritt befüllt) -->
			<div id="submenu-update" class="submenu-panel hidden" data-for="update">
				<div class="submenu-title">Update</div>
				<div class="update-description">For scheduled update set time interval and activate</div>
				<div class="sidebar-form-group">
					<div class="sidebar-form-row">
						<label for="airportCodeInput">Airport IATA Code</label>
						<div class="input-container">
							<input type="text" id="airportCodeInput" name="airportCode" maxlength="3" value="MUC" class="sidebar-form-control" style="text-transform: uppercase;" />
						</div>
					</div>
				</div>
				<div class="sidebar-form-group">
					<div class="sidebar-form-row">
						<label for="currentDateInput">Arrival Date</label>
						<div class="input-container">
							<input type="date" id="currentDateInput" class="sidebar-form-control" />
						</div>
					</div>
				</div>
				<div class="sidebar-form-group">
					<div class="sidebar-form-row">
						<label for="updateIntervalInput">Time interval</label>
						<div class="input-container input-with-suffix">
							<input type="number" id="updateIntervalInput" class="sidebar-form-control has-suffix" min="1" value="15" placeholder="" title="Minutes" />
							<span class="input-suffix">Minutes</span>
						</div>
					</div>
				</div>
				<div class="sidebar-form-group">
					<div class="sidebar-form-row">
						<label for="scheduledUpdateToggle">Set active</label>
						<div class="input-container">
							<label class="modern-toggle-switch" aria-label="Scheduled Update Active">
								<input type="checkbox" id="scheduledUpdateToggle" />
								<span class="modern-toggle-slider"></span>
							</label>
						</div>
					</div>
				</div>
				<button id="fetchFlightData" class="sidebar-btn sidebar-btn-primary w-full">Update</button>
				<div class="text-sm text-center">Ready to update overnight flights</div>
				<div id="overnightFlightsStatus" class="text-sm text-center mt-2 p-2 rounded" style="background-color: #f0f9ff; border: 1px solid #0ea5e9; color: #0369a1; display: none;">
					<div class="font-semibold">Overnight Flights Processing</div>
					<div id="overnightFlightsMessage">Ready for overnight flight analysis</div>
				</div>
			</div>

				<div id="submenu-sync" class="submenu-panel hidden" data-for="sync">
					<div class="submenu-title">Sync Settings</div>
					<div class="sync-mode-description">Configure how your data syncs with the server</div>
					<div class="sync-toggle-row">
						<div class="sync-toggle-info">
							<div class="sync-toggle-title">Mode</div>
							<div class="sync-toggle-desc">Choose Standalone, Sync (read-only), or Master</div>
						</div>
						<div class="sync-toggle-control">
							<select id="syncModeControl" class="sidebar-form-select" aria-label="Sync Mode" onchange="try{ if(window.sharingManager && typeof window.sharingManager.handleModeControlChange==='function'){ window.sharingManager.handleModeControlChange(this.value); } }catch(e){}">
								<option value="standalone">Standalone</option>
								<option value="sync">Sync (Read-Only)</option>
								<option value="master">Master (Read+Write)</option>
							</select>
						</div>
					</div>
					<div class="panel-divider"></div>
<button id="manualSyncBtn" class="sidebar-btn sidebar-btn-primary w-full" title="Trigger a one-time sync now">Manual Sync</button>
					<div class="text-sm text-center" style="margin-top: 6px; color: #64748b;">Trigger a one-time sync now</div>
<div id="syncPollingInfo" class="text-sm text-center" style="margin-top: 4px; color: #94a3b8;">Receiving updates every 3s</div>

				</div>

			<div id="submenu-display" class="submenu-panel hidden" data-for="display">
				<div class="submenu-title">Display Settings</div>
				<div class="sidebar-form-group">
					<div class="sidebar-form-row">
						<label for="darkModeToggle">Darkmode</label>
						<div class="input-container">
							<div class="mode-toggle">
								<label class="toggle-switch">
									<input type="checkbox" id="darkModeToggle" />
									<span class="toggle-slider"></span>
								</label>
							</div>
						</div>
					</div>
				</div>
				<div class="sidebar-form-group">
					<div class="sidebar-form-row">
						<label for="viewModeToggle">Board/Row</label>
						<div class="input-container">
							<div class="mode-toggle">
								<label class="toggle-switch">
									<input type="checkbox" id="viewModeToggle" />
									<span class="toggle-slider"></span>
								</label>
							</div>
						</div>
					</div>
				</div>
					<!-- New toggles: Weather & Time widgets -->
					<div class="sidebar-form-group">
						<div class="sidebar-form-row">
							<label for="weatherWidgetToggle">Weather Widget</label>
							<div class="input-container">
								<div class="mode-toggle">
									<label class="toggle-switch">
										<input type="checkbox" id="weatherWidgetToggle" checked />
										<span class="toggle-slider"></span>
									</label>
								</div>
							</div>
						</div>
					</div>
					<div class="sidebar-form-group">
						<div class="sidebar-form-row">
							<label for="timeWidgetToggle">Time Widget</label>
							<div class="input-container">
								<div class="mode-toggle">
									<label class="toggle-switch">
										<input type="checkbox" id="timeWidgetToggle" checked />
										<span class="toggle-slider"></span>
									</label>
								</div>
							</div>
						</div>
					</div>
					<div class="sidebar-form-group">
						<div class="sidebar-form-row">
							<label for="tilesCount">Primary Tiles</label>
							<div class="input-container">
								<input type="number" id="tilesCount" min="1" max="12" class="sidebar-form-control" />
							</div>
						</div>
					</div>
					<div class="sidebar-form-group">
						<div class="sidebar-form-row">
							<label for="secondaryTilesCount">Secondary Tiles</label>
							<div class="input-container">
								<input type="number" id="secondaryTilesCount" min="0" max="12" class="sidebar-form-control" />
							</div>
						</div>
					</div>
					<div class="sidebar-form-group">
						<div class="sidebar-form-row">
							<label for="layoutType">Layout</label>
							<div class="input-container">
								<select id="layoutType" class="sidebar-form-select">
									<option value="1">1 Column</option>
									<option value="2">2 Columns</option>
									<option value="3">3 Columns</option>
									<option value="4" selected>4 Columns</option>
								</select>
							</div>
						</div>
					</div>

					<!-- Reset Screen control -->
					<div class="sidebar-form-group">
						<div class="sidebar-form-row">
							<label>Utilities</label>
							<div class="input-container">
								<button id="resetScreenBtn" class="sidebar-btn sidebar-btn-primary" title="Clear all tile inputs (except Hangar Position) and update timestamps">Reset screen</button>
							</div>
						</div>
					</div>
			</div>

			<div id="submenu-export" class="submenu-panel hidden" data-for="export">
				<div class="submenu-title">Export</div>
				<div class="sidebar-form-group">
					<label for="pdfFilename">File name:</label>
					<input type="text" id="pdfFilename" value="Hangar_Plan" class="sidebar-form-control" />
				</div>
				<div class="sidebar-form-group">
					<div class="flex items-center">
						<input type="checkbox" id="landscapeMode" checked class="mr-2" />
						<label for="landscapeMode">Landscape Mode</label>
					</div>
				</div>
				<div class="sidebar-form-group">
					<label class="sidebar-section-subtitle">Export Fields:</label>
					<div style="margin-left: 10px">
						<div class="flex items-center" style="margin-bottom: 5px">
							<input type="checkbox" id="exportAircraft" checked class="mr-2" />
							<label for="exportAircraft">Aircraft ID (AC-ID)</label>
						</div>
						<div class="flex items-center" style="margin-bottom: 5px">
							<input type="checkbox" id="exportArrival" checked class="mr-2" />
							<label for="exportArrival">Arrival Time (Arr)</label>
						</div>
						<div class="flex items-center" style="margin-bottom: 5px">
							<input type="checkbox" id="exportDeparture" checked class="mr-2" />
							<label for="exportDeparture">Departure Time (Dep)</label>
						</div>
						<div class="flex items-center" style="margin-bottom: 5px">
							<input type="checkbox" id="exportPosition" class="mr-2" />
							<label for="exportPosition">Position/Route (Pos)</label>
						</div>
						<div class="flex items-center" style="margin-bottom: 5px">
							<input type="checkbox" id="exportHangarPosition" checked class="mr-2" />
							<label for="exportHangarPosition">Hangar Position</label>
						</div>
						<div class="flex items-center" style="margin-bottom: 5px">
							<input type="checkbox" id="exportStatus" class="mr-2" />
							<label for="exportStatus">Status</label>
						</div>
						<div class="flex items-center" style="margin-bottom: 5px">
							<input type="checkbox" id="exportTowStatus" class="mr-2" />
							<label for="exportTowStatus">Tow Status</label>
						</div>
						<div class="flex items-center" style="margin-bottom: 5px">
							<input type="checkbox" id="exportNotes" class="mr-2" />
							<label for="exportNotes">Notes</label>
						</div>
					</div>
				</div>
				<button id="exportPdfBtn" class="sidebar-btn sidebar-btn-primary w-full">Export PDF</button>
			</div>

			<div id="submenu-project" class="submenu-panel hidden" data-for="project">
				<div class="submenu-title">Projekt Settings</div>
				<div class="sidebar-form-group">
					<div class="sidebar-form-row">
						<label for="modeToggle">View/Edit Mode:</label>
						<div class="input-container">
							<div class="mode-toggle">
								<span class="mode-toggle-label">View</span>
								<label class="toggle-switch" aria-label="View/Edit Mode">
									<input type="checkbox" id="modeToggle" checked />
									<span class="toggle-slider"></span>
								</label>
								<span class="mode-toggle-label">Edit</span>
							</div>
						</div>
					</div>
				</div>
				<div class="sidebar-form-group">
					<label for="projectName">Project Name:</label>
					<input id="projectName" type="text" placeholder="Project Name" class="sidebar-form-control" />
					<input type="hidden" id="projectId" value="" />
				</div>
				<div class="sidebar-input-group">
					<button id="saveBtn" class="sidebar-btn sidebar-btn-primary flex-1">Save</button>
					<button id="loadBtn" class="sidebar-btn sidebar-btn-secondary flex-1">Load</button>
				</div>
				<div class="panel-divider"></div>
				<div class="sync-mode-description">Configure how you want to be reminded for towing</div>

				<!-- Towing Reminder Settings -->
				<div class="sidebar-form-group">
					<div class="sidebar-form-row">
						<label for="towingReminderMinutesInput">Set Time to Reminder</label>
						<div class="input-container input-with-suffix">
							<input type="number" id="towingReminderMinutesInput" class="sidebar-form-control has-suffix" min="1" value="15" placeholder="" title="Minutes" />
							<span class="input-suffix">Minutes</span>
						</div>
					</div>
				</div>
				<div class="sidebar-form-group">
					<div class="sidebar-form-row">
						<label for="towingReminderToggle">Activate</label>
						<div class="input-container">
							<label class="modern-toggle-switch" aria-label="Towing Reminder Active">
								<input type="checkbox" id="towingReminderToggle" />
								<span class="modern-toggle-slider"></span>
							</label>
						</div>
					</div>
				</div>

				<!-- Change Log section -->
				<div class="panel-divider"></div>
				<div class="sync-mode-description">Change Log records user edits to tiles on this device. Entries are saved locally and include time, username, and a quick link to the edited field.</div>
				<div class="sidebar-form-group" id="projectChangeLog">
					<div class="sidebar-form-row" style="justify-content: space-between; align-items: center;">
						<label style="margin: 0;">Change Log</label>
						<div class="input-container" style="gap: 6px; justify-content: flex-end;">
							<button id="changeLogClearBtn" class="sidebar-btn sidebar-btn-secondary" title="Clear the change log" style="min-height: 28px; font-size: 12px; padding: 0 10px;">Clear</button>
						</div>
					</div>
					<div id="changeLogList" style="max-height: 240px; overflow-y: auto; background: transparent; border-radius: 8px; padding: 8px;">
						<!-- Entries rendered here -->
					</div>
				</div>
			</div>

			<!-- Hauptbereich mit Hangar-Kacheln -->
			<div class="flex-grow flex flex-col content-container">
				<!-- Header mit Titel und Aktionen -->
					<header
						class="bg-white p-4 shadow-md flex justify-between gap-16">
						<!-- Wetter-Widget unverändert lassen -->
						<div class="flex-grow"></div>
						<div id="weather-widget">
							<div class="weather-primary">
								<div class="weather-airport">MUC</div>
								<div class="weather-data">
									<span id="weather-temp">12°C</span>
									<div id="weather-icon">
										<svg
											class="w-5 h-5"
											xmlns="http://www.w3.org/2000/svg"
											fill="none"
											viewBox="0 0 24 24"
											stroke="currentColor">
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
										</svg>
									</div>
								</div>
							</div>
							<div class="weather-secondary">
								<span id="weather-wind" class="weather-wind-tooltip">
									<span class="weather-wind-icon" style="transform: rotate(0deg)">→</span>
									S 9 km/h
								</span>
								<span id="weather-description" class="weather-description-text">Clear</span>
								<span id="weather-visibility">Vis: 9.7km</span>
							</div>
						</div>

						<!-- Neuer Zeit-Widget: zwei Zeilen (UTC und LOC) -->
						<div id="time-widget">
							<div class="time-display-row">
								<span class="time-label">UTC:</span>
								<span id="utc-time" class="time-value">17:17</span>
							</div>
							<div class="time-display-row">
								<span class="time-label">LOC:</span>
								<span id="local-time" class="time-value">19:17</span>
							</div>
						</div>

						<!-- Tow Reminder Header Widget (between time and status) -->
						<div id="towing-reminder-widget">
							<div class="status-row" data-open-submenu="project" title="Open Project settings">
                                <span class="status-label">Tow Alert:</span>
								<span class="status-label-value">
									<span id="towingReminderActiveBadge" class="reminder-active-badge inactive">Inactive</span>
								</span>
							</div>
							<div class="status-row" data-open-submenu="project" title="Open Project settings">
								<span class="status-label"></span>
								<span class="status-label-value" id="towingReminderList"></span>
							</div>
						</div>

						<!-- Neuer Status-Widget: gebündelte Einstellungen -->
						<div id="status-widget">
							<!-- Row 1: Mode label with last-load time (pill) in read-only -->
							<div class="status-row" data-open-submenu="sync" title="Open Sync settings">
								<span class="status-label">Mode:</span>
								<div class="status-value-group">
									<span id="sync-mode" class="status-label-value">Standalone</span>
									<span id="headerLastLoad" class="header-time-badge" title="Last data load" style="display:none"></span>
								</div>
							</div>
							<!-- Row 2: Update status label from submenu settings (no pill) -->
							<div class="status-row" data-open-submenu="update" title="Open Update settings">
								<span class="status-label">Update:</span>
								<div class="status-value-group">
									<span id="headerUpdateStatus" class="status-label-value" title="Scheduled Update">Inactive</span>
									<span id="headerUpdateMeta" class="status-meta" title="Schedule details"></span>
								</div>
							</div>
							</div>


    <div id="presence-widget">
      <div class="status-row" title="Active users">
        <span class="status-label">Users:</span>
        <span class="status-label-value" id="presenceNames"></span>
      </div>
      <div class="status-row" title="Your display name">
        <span class="status-label">Me:</span>
        <span class="status-value-group">
          <input id="presenceNameInput" type="text" class="presence-name-input" placeholder="Set your name" />
        </span>
      </div>
    </div>
</header>

<!-- Header Status-Widget Initialisierung -->
<script>
(function(){
	function initHeaderStatusWidget(){
		const container = document.getElementById('status-widget');
		if(!container) return;

		// Utility: detect Read-only Sync mode
		function isReadOnlySync(){
			try {
				if (window.sharingManager && typeof window.sharingManager.syncMode === 'string') {
					return window.sharingManager.syncMode === 'sync';
				}
				const read = !!document.getElementById('readDataToggle')?.checked;
				const write = !!document.getElementById('writeDataToggle')?.checked;
				return read && !write;
			} catch(e){ return false; }
		}
		function fmtHHmm(ts){
			try {
				const d = (typeof ts === 'number') ? new Date(ts) : (ts instanceof Date ? ts : null);
				if (!d) return '';
				return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
			} catch(e){ return ''; }
		}
		function isReadEnabled(){
			try {
				if (window.sharingManager && typeof window.sharingManager.syncMode === 'string') {
					return window.sharingManager.syncMode === 'sync' || window.sharingManager.syncMode === 'master';
				}
				const read = !!document.getElementById('readDataToggle')?.checked;
				return !!read;
			} catch(e){ return false; }
		}
		function updateHeaderLastLoad(){
			const el = document.getElementById('headerLastLoad');
			if (!el) return;
			// Ensure correct class for pill styling
			el.className = 'header-time-badge';
			if (!isReadEnabled()) { el.textContent=''; el.style.display='none'; return; }
			const loadedAt = (window.serverSync && window.serverSync.lastLoadedAt) ? window.serverSync.lastLoadedAt : null;
			if (loadedAt) {
				el.textContent = fmtHHmm(loadedAt);
				el.style.display='';
			} else {
				el.textContent='';
				el.style.display='none';
			}
		}

		// Force-refresh header mode label when mode changes
		function refreshHeaderModeLabel(){
			try {
				const el = document.getElementById('sync-mode');
				if (!el) return;
				function getStoredMode(){
					try { const raw = localStorage.getItem('hangarSyncSettings'); if (!raw) return null; const s = JSON.parse(raw||'{}'); return typeof s?.syncMode === 'string' ? s.syncMode : null; } catch(_e){ return null; }
				}
				let mode = (window.sharingManager && window.sharingManager.syncMode) || getStoredMode() || 'standalone';
				el.classList.remove('master','slave','standalone');
				if (mode === 'master') { el.textContent = 'Master'; el.classList.add('master'); }
				else if (mode === 'sync') { el.textContent = 'Sync Read only'; el.classList.add('slave'); }
				else { el.textContent = 'Standalone'; el.classList.add('standalone'); }
			} catch(e){}
		}

		// Öffne linke Submenüs bei Klick auf Status-Zeilen
		container.querySelectorAll('.status-row[data-open-submenu]').forEach(row => {
			row.addEventListener('click', () => {
				const key = row.getAttribute('data-open-submenu');
				const btn = document.querySelector(`#leftMenu .menu-item[data-menu="${key}"]`);
				if (btn) btn.click();
			});
		});

					// Update status label: open Update submenu on right-click
					const updateLabel = container.querySelector('#headerUpdateStatus');
					if (updateLabel) {
						const openUpdate = (e) => {
							if (e) { e.preventDefault(); e.stopPropagation(); }
							const btn = document.querySelector('#leftMenu .menu-item[data-menu="update"]');
							if (btn) btn.click();
						};
						updateLabel.addEventListener('contextmenu', openUpdate);
						updateLabel.addEventListener('click', openUpdate);
					}
					const updateMeta = container.querySelector('#headerUpdateMeta');
					if (updateMeta) {
						updateMeta.addEventListener('click', (e) => {
							e.preventDefault();
							e.stopPropagation();
							const btn = document.querySelector('#leftMenu .menu-item[data-menu="update"]');
							if (btn) btn.click();
						});
					}
					const syncLabel = container.querySelector('#sync-mode');
					if (syncLabel) {
						syncLabel.addEventListener('click', (e) => {
							e.preventDefault();
							e.stopPropagation();
							const btn = document.querySelector('#leftMenu .menu-item[data-menu="sync"]');
							if (btn) btn.click();
						});
					}

		// Update status label mirrors sidebar toggle state (read-only label)
		const updateStatusEl = document.getElementById('headerUpdateStatus');
		const sideToggle = document.getElementById('scheduledUpdateToggle');
		function updateHeaderUpdateStatus(){
			if (!updateStatusEl) return;
			const isActive = !!sideToggle?.checked;
			updateStatusEl.textContent = isActive ? 'Active' : 'Inactive';
			updateStatusEl.className = `status-label-value ${isActive ? 'active' : 'inactive'}`;
		}
		if (sideToggle) {
			updateHeaderUpdateStatus();
			sideToggle.addEventListener('change', updateHeaderUpdateStatus);
		}
		// Also reflect interval
		const intervalInput = document.getElementById('updateIntervalInput');
		function updateHeaderUpdateMeta(){
			const meta = document.getElementById('headerUpdateMeta');
			if (!meta) return;
			const minutes = parseInt(intervalInput?.value || '15', 10);
			meta.textContent = minutes ? `every ${minutes} min` : '';
		}
		if (intervalInput) {
			updateHeaderUpdateMeta();
			intervalInput.addEventListener('change', updateHeaderUpdateMeta);
		}

		// Keep last-load timestamp updated
		document.addEventListener('serverDataLoaded', updateHeaderLastLoad);
		const readToggleForLoad = document.getElementById('readDataToggle');
		const writeToggleForLoad = document.getElementById('writeDataToggle');
		if (readToggleForLoad) readToggleForLoad.addEventListener('change', updateHeaderLastLoad);
		if (writeToggleForLoad) writeToggleForLoad.addEventListener('change', updateHeaderLastLoad);
		setTimeout(updateHeaderLastLoad, 0);
		// Listen to mode changes and refresh header label
		document.addEventListener('syncModeChanged', refreshHeaderModeLabel);
		const modeCtlHeader = document.getElementById('syncModeControl');
		if (modeCtlHeader) modeCtlHeader.addEventListener('change', () => setTimeout(refreshHeaderModeLabel, 0));
		setTimeout(refreshHeaderModeLabel, 0);

		// Optional coupling retained (no project label to update); guard for missing elements.
		let couplingInProgress = false;
		function updateProjectFromSync(){
			if (couplingInProgress) return;
			const modeToggle = document.getElementById('modeToggle');
			if (!modeToggle) return;
			let isReadOnly = false;
			try {
				if (window.sharingManager && typeof window.sharingManager.syncMode === 'string') {
					isReadOnly = (window.sharingManager.syncMode === 'sync');
				} else {
					const readToggle = document.getElementById('readDataToggle');
					const writeToggle = document.getElementById('writeDataToggle');
					const read = !!(readToggle && readToggle.checked);
					const write = !!(writeToggle && writeToggle.checked);
					isReadOnly = read && !write;
				}
			} catch(e) {}
			if (isReadOnly && modeToggle.checked) {
				couplingInProgress = true;
				modeToggle.checked = false; // View
				modeToggle.dispatchEvent(new Event('change', { bubbles: true }));
				couplingInProgress = false;
			} else if (!isReadOnly && !modeToggle.checked) {
				couplingInProgress = true;
				modeToggle.checked = true; // Edit
				modeToggle.dispatchEvent(new Event('change', { bubbles: true }));
				couplingInProgress = false;
			}
		}
		function updateSyncFromProject(){
			if (couplingInProgress) return;
			const modeToggle = document.getElementById('modeToggle');
			if (!modeToggle) return;
			const wantEdit = !!modeToggle.checked;
			try {
				couplingInProgress = true;
				const modeCtl = document.getElementById('syncModeControl');
				if (window.sharingManager && typeof window.sharingManager.updateSyncMode === 'function' && modeCtl) {
					if (!wantEdit) {
						// View mode → Sync (read-only)
						modeCtl.value = 'sync';
						modeCtl.dispatchEvent(new Event('change', { bubbles: true }));
					} else {
						// Edit mode → Master (read+write)
						modeCtl.value = 'master';
						modeCtl.dispatchEvent(new Event('change', { bubbles: true }));
					}
				} else if (window.sharingManager && typeof window.sharingManager.enableSyncMode === 'function') {
					// Fallback if mode control not present: call manager directly
					if (!wantEdit) {
						window.sharingManager.enableSyncMode();
					} else if (typeof window.sharingManager.enableMasterMode === 'function') {
						window.sharingManager.enableMasterMode();
					}
				}
			} finally {
				couplingInProgress = false;
			}
		}
		const modeToggle = document.getElementById('modeToggle');
		if (modeToggle) modeToggle.addEventListener('change', updateSyncFromProject);
		const readToggle = document.getElementById('readDataToggle');
		const writeToggle = document.getElementById('writeDataToggle');
		if (readToggle) readToggle.addEventListener('change', updateProjectFromSync);
		if (writeToggle) writeToggle.addEventListener('change', updateProjectFromSync);
		updateProjectFromSync();
	}

	window.hangarInitQueue = window.hangarInitQueue || [];
							window.hangarInitQueue.push(initHeaderStatusWidget);
})();
</script>

<!-- Presence Client (frontend-only) -->
<script>
(function(){
  function initPresenceClient(){
    try {
      // Elements
      const namesEl = document.getElementById('presenceNames');
      const nameInput = document.getElementById('presenceNameInput');
      if (!namesEl || !nameInput) {
        console.warn('Presence: widget elements not found');
        return;
      }

      // Resolve presence endpoint from serverSync (fallback to same-origin)
      function getPresenceUrl(){
        try {
          let base = (window.serverSync && typeof window.serverSync.getServerUrl === 'function' && window.serverSync.getServerUrl()) || (window.serverSync && window.serverSync.serverSyncUrl) || (window.location.origin + '/sync/data.php');
          if (typeof base !== 'string' || !base.length) base = window.location.origin + '/sync/data.php';
          const url = base.replace(/data\.php(?:\?.*)?$/i, 'presence.php');
          return /presence\.php/i.test(url) ? url : (window.location.origin + '/sync/presence.php');
        } catch(e){
          return window.location.origin + '/sync/presence.php';
        }
      }

      const presence = {
        url: getPresenceUrl(),
        sessionId: '',
        displayName: '',
        heartbeatId: null,
        listId: null,
      };

      // Stable sessionId
      try {
        presence.sessionId = localStorage.getItem('presence.sessionId');
        if (!presence.sessionId) {
          presence.sessionId = Math.random().toString(36).slice(2) + Date.now().toString(36);
          localStorage.setItem('presence.sessionId', presence.sessionId);
        }
      } catch(e){
        presence.sessionId = Math.random().toString(36).slice(2) + Date.now().toString(36);
      }

      // Load/save display name
      try { presence.displayName = localStorage.getItem('presence.displayName') || ''; } catch(e){ presence.displayName = ''; }
      nameInput.value = presence.displayName || '';
      const saveName = () => {
        presence.displayName = (nameInput.value || '').trim().slice(0, 64);
        try { localStorage.setItem('presence.displayName', presence.displayName); } catch(e){}
        heartbeat().catch(()=>{});
        fetchList().catch(()=>{});
      };
      nameInput.addEventListener('change', saveName);
      nameInput.addEventListener('blur', saveName);
      nameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); nameInput.blur(); } });

		  function currentRole(){
			try {
			  if (window.sharingManager && typeof window.sharingManager.syncMode === 'string') {
				  return window.sharingManager.syncMode;
			  }
			  const read = !!document.getElementById('readDataToggle')?.checked;
			  const write = !!document.getElementById('writeDataToggle')?.checked;
			  if (write) return 'master';
			  if (read) return 'sync';
			  return 'standalone';
			} catch(e){ return 'standalone'; }
		  }

      async function heartbeat(){
        try {
          const body = { action: 'heartbeat', sessionId: presence.sessionId, displayName: presence.displayName || '', role: currentRole(), page: location.pathname };
          await fetch(presence.url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        } catch(e){}
      }

      async function fetchList(){
        try {
          const res = await fetch(presence.url + '?action=list', { method: 'GET', headers: { 'Accept': 'application/json' } });
          if (!res.ok) return;
          const data = await res.json();
          if (!data || !Array.isArray(data.users)) return;
          renderList(data.users);
        } catch(e){}
      }

      function renderList(users){
        try {
          const me = presence.sessionId;
          const roleMap = { master: 'Master', sync: 'Sync', standalone: 'Standalone' };
          const fmtLogin = (secs) => {
            try {
              const v = (typeof secs === 'number') ? secs : parseInt(secs, 10);
              if (!isFinite(v) || v <= 0) return '';
              const d = new Date(v * 1000);
              return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch(_) { return ''; }
          };
          const parts = [];
          const others = (users || []).filter(u => u && u.sessionId !== me);
          others.forEach(u => {
            const name = (u.displayName || '').replace(/[<>]/g, '');
            const r = (u.role || 'standalone').toLowerCase();
            const label = roleMap[r] || 'Standalone';
            const css = r === 'master' ? 'mode-master' : (r === 'sync' ? 'mode-sync' : 'standalone');
            const loginPart = fmtLogin(u.loginAt);
            const tooltip = loginPart ? `${label} • Login: ${loginPart}` : `${label}`;
            if (name.length) parts.push(`<span class=\"sync-mode-badge compact presence-chip ${css}\" title=\"${tooltip}\">${name}</span>`);
          });
          namesEl.innerHTML = parts.join(' ');
          namesEl.title = others.map(u => {
            const nm = (u.displayName||'').replace(/[<>]/g, '');
            const lbl = roleMap[(u.role||'standalone').toLowerCase()]||'Standalone';
            const lt = fmtLogin(u.loginAt);
            return lt ? `${nm} (${lbl}) — Login: ${lt}` : `${nm} (${lbl})`;
          }).join(', ');
        } catch(e){}
      }

      // Start loops
      heartbeat();
      fetchList();
      if (presence.heartbeatId) clearInterval(presence.heartbeatId);
      presence.heartbeatId = setInterval(heartbeat, 30000);
      if (presence.listId) clearInterval(presence.listId);
      presence.listId = setInterval(fetchList, 30000);

      // Refresh on tab visible
      document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') { heartbeat(); fetchList(); } });

      // Best-effort leave notification
      window.addEventListener('beforeunload', () => {
        try {
          const payload = JSON.stringify({ action: 'leave', sessionId: presence.sessionId, displayName: presence.displayName || '', role: currentRole(), page: location.pathname });
          navigator.sendBeacon(presence.url, new Blob([payload], { type: 'application/json' }));
        } catch(e){}
      });

      console.log('👥 Presence client initialized:', presence.url);
    } catch(e){ console.warn('Presence init failed', e); }
  }

  // Queue via central init
  window.hangarInitQueue = window.hangarInitQueue || [];
  window.hangarInitQueue.push(initPresenceClient);
})();
</script>

<!-- Towing Reminder Logic (UTC-based time comparison) -->
<script>
(function(){
  const STORAGE_KEY = 'towingReminder';
  let timerId = null;

  // Persist one-time reminder flags per tile+aircraft to avoid duplicates
  const FLAGS_KEY = 'towingReminder.flags';
  function readFlags(){
    try { const raw = localStorage.getItem(FLAGS_KEY); return raw ? (JSON.parse(raw) || {}) : {}; } catch(e){ return {}; }
  }
  function saveFlags(flags){
    try { localStorage.setItem(FLAGS_KEY, JSON.stringify(flags || {})); } catch(e){}
  }
  function isTriggered(cellId, reg){
    if (!reg) return false;
    const flags = readFlags();
    return !!(flags && Object.prototype.hasOwnProperty.call(flags, cellId) && flags[cellId] === reg);
  }
  function markTriggered(entries){
    if (!entries || !entries.length) return;
    const flags = readFlags();
    let changed = false;
    entries.forEach(e => {
      if (!flags[e.cellId] || flags[e.cellId] !== e.reg){
        flags[e.cellId] = e.reg;
        changed = true;
      }
    });
    if (changed) saveFlags(flags);
  }
  function clearFlagForCell(cellId){
    const flags = readFlags();
    if (flags && Object.prototype.hasOwnProperty.call(flags, cellId)){
      delete flags[cellId];
      saveFlags(flags);
    }
  }

  function readConfig(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw){
        const cfg = JSON.parse(raw);
        const minutes = Math.max(1, parseInt(cfg.minutes||15,10)||15);
        const active = !!cfg.active;
        return { minutes, active };
      }
    } catch(e) { console.warn('towingReminder read failed', e); }
    return { minutes: 15, active: false };
  }
  function saveConfig(cfg){
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ minutes: cfg.minutes, active: !!cfg.active })); } catch(e){}
  }
  function pad2(n){ return String(n).padStart(2,'0'); }
  // Parse ISO local (YYYY-MM-DDTHH:mm) as UTC epoch ms
  function parseISOAsUTC(iso){
    if (typeof iso !== 'string' || !/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(iso)) return NaN;
    const [date, time] = iso.split('T');
    const [y,m,d] = date.split('-').map(Number);
    const [hh,mm] = time.split(':').map(Number);
    return Date.UTC(y, (m||1)-1, d||1, hh||0, mm||0, 0, 0);
  }
  function getISOFromField(field, fieldId){
    const raw = (field?.dataset?.iso || field?.value || '').trim();
    if (raw && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(raw)) return raw;
    if (window.helpers && typeof window.helpers.canonicalizeDateTimeFieldValue === 'function'){
      const iso = window.helpers.canonicalizeDateTimeFieldValue(fieldId, raw);
      if (iso && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(iso)) return iso;
    }
    return '';
  }
  function formatHHmmUTC(ms){
    if (!isFinite(ms)) return '';
    const d = new Date(ms);
    return pad2(d.getUTCHours()) + ':' + pad2(d.getUTCMinutes());
  }
  function collectEligible(minutes){
    const nowMs = Date.now();
    const cutoffMs = nowMs + minutes * 60000; // include upcoming within window
    const result = [];
    document.querySelectorAll("select[id^='tow-status-']").forEach(sel => {
      if (!sel) return;
      const m = sel.id.match(/^tow-status-(\d+)$/);
      if (!m) return;
      const cellId = parseInt(m[1],10);
      if (sel.value !== 'on-position') return;
      const depField = document.getElementById(`departure-time-${cellId}`);
      if (!depField) return;
      const iso = getISOFromField(depField, `departure-time-${cellId}`);
      if (!iso) return;
      const depMs = parseISOAsUTC(iso);
      if (!isFinite(depMs)) return;
      if (depMs <= cutoffMs){
        // Prefer Hangar Position, fall back to Pos field if empty
        const hangarPosRaw = (document.getElementById(`hangar-position-${cellId}`)?.value || '').trim();
        const posRaw = (document.getElementById(`position-${cellId}`)?.value || '').trim();
        const displayPos = hangarPosRaw || posRaw;
        result.push({ cellId, depMs, hhmm: formatHHmmUTC(depMs), hangarPos: displayPos, overdue: depMs <= nowMs });
      }
    });
    result.sort((a,b)=> a.depMs - b.depMs);
    return result;
  }
  function ensureBadge(cellId, present){
    const sel = document.getElementById(`tow-status-${cellId}`);
    if (!sel) return;
    // Find existing indicator immediately after the select
    const sib = sel.nextElementSibling;
    const isDot = sib && sib.classList && sib.classList.contains('tow-dot');
    const isOld = sib && sib.classList && sib.classList.contains('tow-badge');
    if (present){
      if (isDot) return; // already correct
      if (isOld) { sib.remove(); }
      const dot = document.createElement('span');
      dot.className = 'tow-dot';
      dot.title = 'Tow reminder';
      sel.insertAdjacentElement('afterend', dot);
    } else {
      if (isDot || isOld) sib.remove();
    }
  }
  function updateBadges(eligible){
    const keep = new Set(eligible.map(x=>x.cellId));
    document.querySelectorAll("select[id^='tow-status-']").forEach(sel => {
      const m = sel.id.match(/^tow-status-(\d+)$/);
      if (!m) return;
      ensureBadge(parseInt(m[1],10), keep.has(parseInt(m[1],10)));
    });
  }
  function setWidgetVisibility(active){
    // Always visible; badge reflects active/inactive state
    const w = document.getElementById('towing-reminder-widget');
    if (!w) return;
    w.hidden = false;
    w.style.display = '';
    w.removeAttribute('hidden');
  }
  function updateActiveBadge(active){
    const b = document.getElementById('towingReminderActiveBadge');
    if (!b) return;
    b.hidden = false;
    b.style.display = 'inline-block';
    b.textContent = active ? 'Active' : 'Inactive';
    b.classList.remove('active','inactive');
    b.classList.add(active ? 'active' : 'inactive');
  }
  function renderHeader(overdueItems){
    const listEl = document.getElementById('towingReminderList');
    if (!listEl) return;
    const positions = (overdueItems || [])
      .map(x => (x.hangarPos || '').trim())
      .filter(Boolean);
    listEl.textContent = positions.join(', ');

    // Toggle styling for second-row presence
    const container = document.getElementById('towing-reminder-widget');
    if (container) {
      if (positions.length) {
        container.classList.add('has-second-row');
      } else {
        container.classList.remove('has-second-row');
      }
    }

    if (positions.length) {
      listEl.classList.add('tow-overdue');
    } else {
      listEl.classList.remove('tow-overdue');
    }
  }
  function runOnce(){
    const cfg = readConfig();
    setWidgetVisibility(cfg.active);
    updateActiveBadge(cfg.active);
    const eligibleAll = cfg.active ? collectEligible(cfg.minutes) : [];
    const overdueOnly = cfg.active ? eligibleAll.filter(x => x.overdue && x.hangarPos && x.hangarPos.length) : [];
    // Show all eligible items (within window), not only overdue
    renderHeader(eligibleAll);
    updateBadges(eligibleAll);
  }
  function start(){
    stop();
    runOnce();
    timerId = setInterval(runOnce, 60*1000);
  }
  function stop(){
    if (timerId){ clearInterval(timerId); timerId = null; }
    renderHeader([]);
    updateBadges([]);
  }
  function initControls(){
    const minutesInput = document.getElementById('towingReminderMinutesInput');
    const toggle = document.getElementById('towingReminderToggle');
    const cfg = readConfig();
    if (minutesInput){
      minutesInput.value = cfg.minutes;
      let t = null;
      const apply = ()=>{
        let v = parseInt(minutesInput.value,10);
        if (!isFinite(v) || v < 1) v = 1;
        minutesInput.value = v;
        const newCfg = { minutes: v, active: !!(toggle && toggle.checked) };
        saveConfig(newCfg);
        if (newCfg.active) runOnce();
      };
      minutesInput.addEventListener('input', ()=>{ clearTimeout(t); t = setTimeout(apply, 200); });
      minutesInput.addEventListener('change', apply);
    }
    if (toggle){
      toggle.checked = !!cfg.active;
      toggle.addEventListener('change', ()=>{
        const minutes = parseInt(document.getElementById('towingReminderMinutesInput')?.value,10) || cfg.minutes || 15;
        const newCfg = { minutes, active: !!toggle.checked };
        saveConfig(newCfg);
        setWidgetVisibility(newCfg.active);
        updateActiveBadge(newCfg.active);
        if (newCfg.active) start(); else stop();
      });
    }
    setWidgetVisibility(cfg.active);
    updateActiveBadge(cfg.active);
    if (cfg.active) start(); else stop();

    // Reset one-time reminder flag only when user sets Tow Status away from "on-position"
    document.addEventListener('change', function(e){
      const el = e.target;
      if (el && el.matches("select[id^='tow-status-']")){
        const m = el.id.match(/^tow-status-(\d+)$/);
        if (m && el.value !== 'on-position'){
          clearFlagForCell(parseInt(m[1],10));
        }
      }
    });
  }
  function initHeaderWidget(){
    const container = document.getElementById('towing-reminder-widget');
    if (!container) return;
    // Mirror Status widget behavior: open left submenu based on data-open-submenu
    container.querySelectorAll('.status-row[data-open-submenu]').forEach(row => {
      row.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const key = row.getAttribute('data-open-submenu') || 'project';
        const btn = document.querySelector(`#leftMenu .menu-item[data-menu="${key}"]`);
        if (btn) btn.click();
      });
    });
  }
  window.hangarInitQueue = window.hangarInitQueue || [];
  window.hangarInitQueue.push(function(){
    try { initControls(); } catch(e){}
    try { initHeaderWidget(); } catch(e){}
  });
})();
</script>

<!-- Per-tile header delete button (hover-only) -->
<script>
(function(){
  function isReadOnlySync(){
    try {
      if (window.sharingManager && typeof window.sharingManager.syncMode === 'string') {
        return window.sharingManager.syncMode === 'sync';
      }
      const read = !!document.getElementById('readDataToggle')?.checked;
      const write = !!document.getElementById('writeDataToggle')?.checked;
      return read && !write; // Sync (read-only)
    } catch(e){ return false; }
  }
  function getCellIdFromTile(tile){
    if (!tile) return null;
    // Prefer status select id pattern
    const sel = tile.querySelector('select[id^="status-"]');
    if (sel) { const m = sel.id.match(/^(?:status|tow-status)-(\d+)$/) || sel.id.match(/-(\d+)$/); if (m) return parseInt(m[1],10); }
    // Fallback: hangar-position input in header
    const pos = tile.querySelector('input[id^="hangar-position-"]');
    if (pos) { const m = pos.id.match(/-(\d+)$/); if (m) return parseInt(m[1],10); }
    // Final fallback: any field id with trailing number
    const any = tile.querySelector('[id*="-"]');
    if (any) { const m = any.id.match(/-(\d+)$/); if (m) return parseInt(m[1],10); }
    return null;
  }
  function clearSingleTile(cellId){
    try {
      if (!cellId && cellId !== 0) return false;
      // Locate the tile host (primary or secondary)
      let tile = document.querySelector(`[data-cell-id="${cellId}"]`);
      if (!tile) {
        // Try by proximity to known inputs
        const aircraft = document.getElementById(`aircraft-${cellId}`);
        tile = aircraft?.closest('.hangar-cell') || null;
      }
      // Clear Aircraft ID
      const ac = document.getElementById(`aircraft-${cellId}`);
      if (ac) ac.value = '';
      // Clear times + dataset.iso
      const arr = document.getElementById(`arrival-time-${cellId}`);
      if (arr) { arr.value = ''; try { delete arr.dataset.iso; } catch(e){} }
      const dep = document.getElementById(`departure-time-${cellId}`);
      if (dep) { dep.value = ''; try { delete dep.dataset.iso; } catch(e){} }
      // Clear Pos (route Position in info grid)
      const posInfo = document.getElementById(`position-${cellId}`);
      if (posInfo) posInfo.value = '';
      // Keep Hangar Position (header) untouched intentionally
      // Clear Notes
      const notes = document.getElementById(`notes-${cellId}`);
      if (notes) notes.value = '';
      // Tow -> neutral + styling
      const tow = document.getElementById(`tow-status-${cellId}`);
      if (tow) { tow.value = 'neutral'; if (typeof updateTowStatusStyles === 'function') updateTowStatusStyles(tow); }
      // Status -> neutral + status light
      const status = document.getElementById(`status-${cellId}`);
      if (status) { status.value = 'neutral'; if (typeof updateStatusLight === 'function') updateStatusLight(status); }
      // Remove Last Update badge (and persisted record)
      try { if (window.LastUpdateBadges && typeof window.LastUpdateBadges.remove === 'function') { window.LastUpdateBadges.remove(parseInt(cellId,10)); } } catch(e){}
      return true;
    } catch(e){ console.warn('clearSingleTile failed', e); return false; }
  }
  function injectDeleteIntoTile(tile){
    try {
      if (!tile || tile.__deleteInjected) return;
      const header = tile.querySelector('.card-header');
      if (!header) return;
      const cellId = getCellIdFromTile(tile);
      if (!cellId && cellId !== 0) return;
      const btn = document.createElement('button');
      btn.className = 'tile-delete-btn';
      btn.type = 'button';
      btn.title = 'Clear tile';
      btn.setAttribute('aria-label','Clear tile');
      // Trash icon (stroke currentColor)
      btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>';
      const applyReadonly = ()=>{ if (isReadOnlySync()) { btn.setAttribute('aria-disabled','true'); } else { btn.removeAttribute('aria-disabled'); } };
      applyReadonly();
      btn.addEventListener('click', async (e)=>{
        e.preventDefault(); e.stopPropagation();
        if (isReadOnlySync()) return; // No action in read-only
        const ss = window.serverSync;
        try { if (ss && typeof ss.suspendReads === 'function') ss.suspendReads(); } catch(_e) {}
        const ok = clearSingleTile(cellId);
          try {
            if (ok && window.serverSync?.isMaster) {
              const updates = {};
              try {
                updates[`aircraft-${cellId}`] = '';
                updates[`arrival-time-${cellId}`] = '';
                updates[`departure-time-${cellId}`] = '';
                updates[`position-${cellId}`] = '';
                updates[`notes-${cellId}`] = '';
                updates[`status-${cellId}`] = 'neutral';
                updates[`tow-status-${cellId}`] = 'neutral';
              } catch(_e) {}
              if (typeof window.serverSync.syncFieldUpdates === 'function') {
                await window.serverSync.syncFieldUpdates(updates);
              } else {
                await window.serverSync.syncWithServer();
              }
            }
          } catch(err) {
            console.warn('Tile clear sync failed:', err);
          } finally {
            try { if (ss && typeof ss.resumeReads === 'function') ss.resumeReads(true); } catch(_e) {}
          }
      });
      header.appendChild(btn);
      tile.__deleteInjected = true;
    } catch(e){ console.warn('injectDeleteIntoTile failed', e); }
  }
  function injectAll(){
    document.querySelectorAll('#hangarGrid .hangar-cell, #secondaryHangarGrid .hangar-cell').forEach(injectDeleteIntoTile);
  }
  function hookSyncToggles(){
    const r = document.getElementById('readDataToggle');
    const w = document.getElementById('writeDataToggle');
    const apply = ()=>{
      const ro = isReadOnlySync();
      document.querySelectorAll('.tile-delete-btn').forEach(btn=>{
        if (ro) btn.setAttribute('aria-disabled','true'); else btn.removeAttribute('aria-disabled');
      });
    };
    if (r) r.addEventListener('change', apply);
    if (w) w.addEventListener('change', apply);
    apply();
  }
  function init(){ injectAll(); hookSyncToggles(); }
  window.hangarInitQueue = window.hangarInitQueue || [];
  window.hangarInitQueue.push(init);
  document.addEventListener('secondaryTilesCreated', function(){ setTimeout(injectAll, 50); setTimeout(hookSyncToggles, 60); });
  // Expose for potential reuse
  window.clearSingleTile = clearSingleTile;
})();
</script>

<!-- Schedule (dual booking) injection and runtime logic -->
<script>
(function(){
  function getCellIdFromTile(tile){
    if (!tile) return null;
    const sel = tile.querySelector('select[id^="status-"]') || tile.querySelector('select[id^="tow-status-"]');
    if (sel){ const m = sel.id.match(/-(\d+)$/); if (m) return parseInt(m[1],10); }
    const pos = tile.querySelector('input[id^="hangar-position-"]') || tile.querySelector('input[id^="position-"]');
    if (pos){ const m = pos.id.match(/-(\d+)$/); if (m) return parseInt(m[1],10); }
    const ac = tile.querySelector('input[id^="aircraft-"]');
    if (ac){ const m = ac.id.match(/-(\d+)$/); if (m) return parseInt(m[1],10); }
    return null;
  }
  function toMs(iso){
    if (typeof iso !== 'string' || !/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(iso)) return NaN;
    const [date,time] = iso.split('T');
    const [y,m,d] = date.split('-').map(Number);
    const [hh,mm] = time.split(':').map(Number);
    return Date.UTC(y,(m||1)-1,d||1,hh||0,mm||0,0,0);
  }
  function pickActive(bookings, nowMs){
    const items = (bookings||[]).map((b,i)=>({i,b,arr:toMs(b.arr),dep:toMs(b.dep)})).filter(x=>isFinite(x.arr)&&isFinite(x.dep));
    const active = items.find(x=> x.arr <= nowMs && nowMs < x.dep);
    if (active) return { type:'active', index: active.i };
    const next = items.filter(x=> x.arr > nowMs).sort((a,b)=> a.arr - b.arr)[0];
    if (next) return { type:'next', index: next.i };
    return { type:'none', index:-1 };
  }
  function hasConflict(a,b){
    if (!a || !b) return false; const aA=toMs(a.arr), aD=toMs(a.dep), bA=toMs(b.arr), bD=toMs(b.dep);
    if (![aA,aD,bA,bD].every(isFinite)) return false; return (aA < bD) && (bA < aD);
  }
  function readSchedule(cellId){
    try { const el = document.getElementById(`schedule-${cellId}`); if (!el) return []; const val = el.value||'[]'; const parsed = JSON.parse(val); return Array.isArray(parsed) ? parsed : []; } catch(_e){ return []; }
  }
  function writeSchedule(cellId, bookings){
    const el = document.getElementById(`schedule-${cellId}`); if (!el) return;
    const arr = (bookings||[]).slice(0,2).map(x=>({ reg:(x.reg||'').trim(), arr:(x.arr||''), dep:(x.dep||''), pos:(x.pos||'') }));
    el.value = JSON.stringify(arr);
    try { if (window.hangarEventManager && typeof window.hangarEventManager.debouncedFieldUpdate==='function'){ window.hangarEventManager.debouncedFieldUpdate(`schedule-${cellId}`, el.value, 150, { flushDelayMs: 150 }); } } catch(_e){}
  }
  function buildScheduleUI(cellId){
    const wrapper = document.createElement('div');
    wrapper.className = 'tile-schedule-ui';
    wrapper.innerHTML = `
      <div class="tile-tabbar" role="tablist" aria-label="Planning tabs">
        <button type="button" class="tab-btn" data-b="0" role="tab" aria-selected="true" title="Plan 1">+</button>
        <button type="button" class="tab-btn" data-b="1" role="tab" aria-selected="false" title="Plan 2">+</button>
      </div>`;
    // tab click -> persist selection and mirror plan into main fields
    wrapper.querySelectorAll('.tile-tabbar .tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const sel = parseInt(btn.getAttribute('data-b'),10)||0;
        try {
          if (window.scheduleHelpers){
            window.scheduleHelpers.setSelectedPlanIndex(cellId, sel);
            window.scheduleHelpers.applySelectedPlanToTile(cellId);
          }
        } catch(_e){}
        // update aria-selected locally
        wrapper.querySelectorAll('.tile-tabbar .tab-btn').forEach(b=> b.setAttribute('aria-selected', b===btn ? 'true' : 'false'));
      });
    });
    return wrapper;
  }
  function renderScheduleUI(cellId){
    try {
      const host = (function(){
        let t = document.querySelector(`[data-cell-id="${cellId}"]`);
        if (!t) t = document.querySelector(`#hangarGrid .hangar-cell:nth-child(${cellId})`);
        return t;
      })();
      if (!host) return;
      const ui = host.querySelector('.tile-schedule-ui');
      if (!ui) return;
      // compute active/next from stored plans
      const plans = readPlans(cellId);
      const now = Date.now();
      function shortReg(s){ try { const t = (s||'').toUpperCase().replace(/[^A-Z0-9]/g,''); return t.length ? t.slice(-3) : '+'; } catch(_e){ return '+'; } }
      function planTimes(p){
        try {
          const f = (p && p.fields) ? p.fields : {};
          const a = f[`arrival-time-${cellId}`] || '';
          const d = f[`departure-time-${cellId}`] || '';
          const isoA = (window.helpers && typeof window.helpers.canonicalizeDateTimeFieldValue==='function') ? window.helpers.canonicalizeDateTimeFieldValue(`arrival-time-${cellId}`, a) : a;
          const isoD = (window.helpers && typeof window.helpers.canonicalizeDateTimeFieldValue==='function') ? window.helpers.canonicalizeDateTimeFieldValue(`departure-time-${cellId}`, d) : d;
          return { a: toMs(isoA||''), d: toMs(isoD||'') };
        } catch(_e){ return { a: NaN, d: NaN }; }
      }
      const t0 = planTimes(plans[0]||{});
      const t1 = planTimes(plans[1]||{});
      function stateFromTimes(t){ if (!isFinite(t.a) || !isFinite(t.d)) return 'none'; if (t.a <= now && now < t.d) return 'active'; if (t.a > now) return 'next'; return 'none'; }
      const s0 = stateFromTimes(t0);
      const s1 = stateFromTimes(t1);
      // labels + badges
      const tabs = ui.querySelectorAll('.tile-tabbar .tab-btn');
      // Set labels from Aircraft ID per plan, fallback to '+'
      const reg0 = ((plans[0]?.fields?.[`aircraft-${cellId}`]) || '').trim();
      const reg1 = ((plans[1]?.fields?.[`aircraft-${cellId}`]) || '').trim();
      const b0 = ui.querySelector('.tile-tabbar .tab-btn[data-b="0"]');
      const b1 = ui.querySelector('.tile-tabbar .tab-btn[data-b="1"]');
      if (b0) { b0.textContent = reg0.length ? shortReg(reg0) : '+'; }
      if (b1) { b1.textContent = reg1.length ? shortReg(reg1) : '+'; }
      tabs.forEach((btn,i)=>{ btn.classList.remove('time-active','time-next'); });
      if (s0==='active'){ if (b0) b0.classList.add('time-active'); }
      else if (s0==='next'){ if (b0) b0.classList.add('time-next'); }
      if (s1==='active'){ if (b1) b1.classList.add('time-active'); }
      else if (s1==='next'){ if (b1) b1.classList.add('time-next'); }
      // conflict marker if both present and overlap
      const conflict = (isFinite(t0.a)&&isFinite(t0.d)&&isFinite(t1.a)&&isFinite(t1.d) && (t0.a < t1.d) && (t1.a < t0.d));
      ui.classList.toggle('is-conflict', !!conflict);
      // reflect persisted selected tab aria-selected
      try {
        const sel = getSelectedPlanIndex(cellId);
        tabs.forEach(btn => { const idx = parseInt(btn.getAttribute('data-b'),10)||0; btn.setAttribute('aria-selected', idx===sel ? 'true' : 'false'); });
      } catch(_e){}
    } catch(_e){}
  }
  function tileHasMeaningfulDom(cellId){
    const get = (id)=> (document.getElementById(id)?.value || '').trim();
    try {
      const aircraft = get(`aircraft-${cellId}`);
      const arr = get(`arrival-time-${cellId}`);
      const dep = get(`departure-time-${cellId}`);
      const pos = get(`position-${cellId}`) || get(`hangar-position-${cellId}`);
      const notes = get(`notes-${cellId}`);
      const status = get(`status-${cellId}`);
      const tow = get(`tow-status-${cellId}`);
      const hasStatus = !!(status && status !== 'neutral');
      const hasTow = !!(tow && tow !== 'neutral');
      return !!(aircraft || arr || dep || pos || notes || hasStatus || hasTow);
    } catch(_e){ return false; }
  }

  function ensureScheduleForTile(tile){
    const cellId = getCellIdFromTile(tile);
    if (!cellId && cellId !== 0) return;
    // hidden input (anywhere in tile)
    let hidden = tile.querySelector(`#schedule-${cellId}`);
    if (!hidden){
      hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.id = `schedule-${cellId}`;
      tile.appendChild(hidden);
    }
    // UI in header, centered between left and right blocks
    const header = tile.querySelector('.card-header');
    if (!header) return;
    const headerEls = header.querySelector('.header-elements') || header;
    const rightBlock = headerEls.querySelector('.position-container');
    let ui = tile.querySelector('.tile-schedule-ui');
    if (!ui){
      ui = buildScheduleUI(cellId);
      if (rightBlock && rightBlock.parentNode === headerEls){ headerEls.insertBefore(ui, rightBlock); } else { headerEls.appendChild(ui); }
    } else if (!headerEls.contains(ui)) {
      if (rightBlock && rightBlock.parentNode === headerEls){ headerEls.insertBefore(ui, rightBlock); } else { headerEls.appendChild(ui); }
    }
    // install mirroring of tile fields into selected plan
    try { installFieldMirroring(tile, cellId); } catch(_e){}
    // seed plans if needed and apply selected plan (only if DOM is effectively empty)
    try {
      seedInitialPlansIfEmpty(cellId);
      if (!tileHasMeaningfulDom(cellId)) {
        applySelectedPlanToTile(cellId);
      }
    } catch(_e){}
    renderScheduleUI(cellId);
  }
  function initAll(){
    try {
      document.querySelectorAll('#hangarGrid .hangar-cell, #secondaryHangarGrid .hangar-cell').forEach(ensureScheduleForTile);
    } catch(_e){}
  }
  // Re-render highlights periodically
  function tick(){ try { document.querySelectorAll('#hangarGrid .hangar-cell, #secondaryHangarGrid .hangar-cell').forEach(tile=>{ const id = getCellIdFromTile(tile); if (isFinite(id)) renderScheduleUI(id); }); } catch(_e){} }
  setInterval(tick, 60000);

  // expose minimal helpers
  // Persistent selected plan index per tile
  function getSelectedPlanIndex(cellId){
    try { const raw = localStorage.getItem('tile.plan.selected') || '{}'; const obj = JSON.parse(raw)||{}; const v = obj[String(cellId)]; return (v===0||v===1) ? v : 0; } catch(_e){ return 0; }
  }
  function setSelectedPlanIndex(cellId, idx){
    try { const raw = localStorage.getItem('tile.plan.selected') || '{}'; const obj = JSON.parse(raw)||{}; obj[String(cellId)] = (idx===1?1:0); localStorage.setItem('tile.plan.selected', JSON.stringify(obj)); } catch(_e){}
  }
  // Plans store: snapshot actual tile fields for two plans
  function readPlans(cellId){
    try { const raw = localStorage.getItem('tile.plans') || '{}'; const obj = JSON.parse(raw)||{}; const v = obj[String(cellId)]; if (!Array.isArray(v)) return [{fields:{}},{fields:{}}]; return [v[0]||{fields:{}}, v[1]||{fields:{}}]; } catch(_e){ return [{fields:{}},{fields:{}}]; }
  }
  function writePlans(cellId, plans){
    try { const raw = localStorage.getItem('tile.plans') || '{}'; const obj = JSON.parse(raw)||{}; obj[String(cellId)] = plans.map(p=>({ fields: p.fields||{} })); localStorage.setItem('tile.plans', JSON.stringify(obj)); } catch(_e){}
  }
  function snapshotCurrentTileFields(cellId){
    const fields = {};
    const ids = [
      `aircraft-${cellId}`,
      `arrival-time-${cellId}`,
      `departure-time-${cellId}`,
      `position-${cellId}`,
      `hangar-position-${cellId}`,
      `notes-${cellId}`,
      `status-${cellId}`,
      `tow-status-${cellId}`,
    ];
    ids.forEach(id=>{ const el = document.getElementById(id); if (el) fields[id] = el.value || ''; });
    return fields;
  }
  function applyFieldsToTile(cellId, fields){
    Object.entries(fields||{}).forEach(([id,val])=>{
      const el = document.getElementById(id);
      if (!el) return;
      const prev = el.value;
      if (prev === val) return;
      el.value = val || '';
      try { el.dispatchEvent(new Event('input', { bubbles: true })); el.dispatchEvent(new Event('change', { bubbles: true })); } catch(_e){}
    });
  }
  function seedInitialPlansIfEmpty(cellId){
    const plans = readPlans(cellId);
    const empty0 = !plans[0] || !plans[0].fields || Object.keys(plans[0].fields).length===0;
    const empty1 = !plans[1] || !plans[1].fields || Object.keys(plans[1].fields).length===0;
    if (empty0){ plans[0] = { fields: snapshotCurrentTileFields(cellId) }; }
    if (empty1){ plans[1] = { fields: snapshotCurrentTileFields(cellId) }; }
    writePlans(cellId, plans);
  }
  function applySelectedPlanToTile(cellId){
    const sel = getSelectedPlanIndex(cellId);
    const plans = readPlans(cellId);
    const fields = (plans[sel] && plans[sel].fields) ? plans[sel].fields : {};
    applyFieldsToTile(cellId, fields);
    renderScheduleUI(cellId);
    try { if (typeof window.refreshGlobalSchedule === 'function') window.refreshGlobalSchedule(); } catch(_e){}
  }
  function installFieldMirroring(tile, cellId){
    const relevant = tile.querySelectorAll(`#aircraft-${cellId}, #arrival-time-${cellId}, #departure-time-${cellId}, #position-${cellId}, #hangar-position-${cellId}, #notes-${cellId}, #status-${cellId}, #tow-status-${cellId}`);
    relevant.forEach(el => {
      if (el.__planMirrorInstalled) return;
      const handler = ()=>{
        const sel = getSelectedPlanIndex(cellId);
        const plans = readPlans(cellId);
        const fields = (plans[sel] && plans[sel].fields) ? plans[sel].fields : {};
        fields[el.id] = el.value || '';
        plans[sel] = { fields };
        writePlans(cellId, plans);
        // also reflect to schedule JSON for timetable logic (optional, based on Arr/Dep only)
        try {
          const reg = (document.getElementById(`aircraft-${cellId}`)?.value||'').trim();
          const arr = fields[`arrival-time-${cellId}`] || '';
          const dep = fields[`departure-time-${cellId}`] || '';
          const current = readSchedule(cellId) || [];
          current[sel] = { reg, arr, dep };
          writeSchedule(cellId, current);
        } catch(_e){}
        renderScheduleUI(cellId);
      };
      el.addEventListener('input', handler);
      el.addEventListener('change', handler);
      el.__planMirrorInstalled = true;
    });
  }

  window.scheduleHelpers = { readSchedule, writeSchedule, renderScheduleUI, setSelectedPlanIndex, getSelectedPlanIndex, applySelectedPlanToTile };
  window.renderScheduleUI = renderScheduleUI;

  window.hangarInitQueue = window.hangarInitQueue || [];
  window.hangarInitQueue.push(initAll);
  document.addEventListener('secondaryTilesCreated', ()=> setTimeout(initAll, 60));
  // On load, restore selected plan index and apply (skip if DOM already has meaningful content)
  try { setTimeout(()=>{ try { document.querySelectorAll('[data-cell-id]').forEach(el=>{ const id = parseInt(el.getAttribute('data-cell-id')||'',10); if (!isFinite(id)) return; if (!tileHasMeaningfulDom(id)) applySelectedPlanToTile(id); }); } catch(_e){} }, 300); } catch(_e){}

  // Sync integration: keep per-tile plans and tab UI in sync after server loads
  // This mirrors the freshly applied DOM values into the currently selected plan
  // without emitting input/change events (so it won't write to the server).
  document.addEventListener('serverDataLoaded', function(){
    // small delay to allow any trailing DOM updates (lights/styles) to settle
    setTimeout(function(){
      try {
        const tiles = document.querySelectorAll('#hangarGrid .hangar-cell, #secondaryHangarGrid .hangar-cell');
        tiles.forEach(tile => {
          const cellId = getCellIdFromTile(tile);
          if (!Number.isFinite(cellId)) return;
          const plans = readPlans(cellId);
          // Read current DOM values after sync
          const get = (id) => (document.getElementById(id)?.value || '').trim();
          const dom = {
            aircraft: get(`aircraft-${cellId}`),
            arrIso: (function(){ try { const raw = get(`arrival-time-${cellId}`); return (window.helpers && typeof window.helpers.canonicalizeDateTimeFieldValue==='function') ? (window.helpers.canonicalizeDateTimeFieldValue(`arrival-time-${cellId}`, raw)||'') : raw; } catch(_e){ return get(`arrival-time-${cellId}`); } })(),
            depIso: (function(){ try { const raw = get(`departure-time-${cellId}`); return (window.helpers && typeof window.helpers.canonicalizeDateTimeFieldValue==='function') ? (window.helpers.canonicalizeDateTimeFieldValue(`departure-time-${cellId}`, raw)||'') : raw; } catch(_e){ return get(`departure-time-${cellId}`); } })(),
            pos: get(`position-${cellId}`),
            hangarPos: get(`hangar-position-${cellId}`),
            status: get(`status-${cellId}`),
            tow: get(`tow-status-${cellId}`)
          };

          // Decide which plan to update by comparing DOM times to stored plans
          const toMinutes = (iso)=>{ const ms = toMs(iso||''); return isFinite(ms) ? ms/60000 : NaN; };
          const diff = (a,b)=>{ if (!isFinite(a) || !isFinite(b)) return 1e9; return Math.abs(a-b); };
          function planTime(pl){
            const f = (pl && pl.fields) ? pl.fields : {};
            const a = f[`arrival-time-${cellId}`] || '';
            const d = f[`departure-time-${cellId}`] || '';
            // canonicalize in case stored values are compact
            let aIso=a, dIso=d;
            try { if (window.helpers && typeof window.helpers.canonicalizeDateTimeFieldValue==='function'){ aIso = a ? (window.helpers.canonicalizeDateTimeFieldValue(`arrival-time-${cellId}`, a)||a) : ''; dIso = d ? (window.helpers.canonicalizeDateTimeFieldValue(`departure-time-${cellId}`, d)||d) : ''; } } catch(_e){}
            return { aMin: toMinutes(aIso), dMin: toMinutes(dIso), aIso: aIso||'', dIso: dIso||'' };
          }
          function isEmptyPlan(pl){
            try {
              const f = (pl && pl.fields) ? pl.fields : {};
              return !Object.keys(f).some(k => (f[k]||'').trim().length);
            } catch(_e){ return true; }
          }

          const p0 = planTime(plans[0]);
          const p1 = planTime(plans[1]);
          const domA = toMinutes(dom.arrIso), domD = toMinutes(dom.depIso);
          const score0 = diff(domA, p0.aMin) + diff(domD, p0.dMin);
          const score1 = diff(domA, p1.aMin) + diff(domD, p1.dMin);
          const THRESH = 10; // minutes tolerance per field (sum threshold)

          let idxToUpdate = null;
          if (isFinite(domA) || isFinite(domD)){
            // Choose the closer plan if within tolerance; otherwise prefer empty plan
            if (score0 + 1e-6 < score1 && score0 < THRESH*2){ idxToUpdate = 0; }
            else if (score1 + 1e-6 < score0 && score1 < THRESH*2){ idxToUpdate = 1; }
            else if (isEmptyPlan(plans[0]) && !isEmptyPlan(plans[1])) { idxToUpdate = 0; }
            else if (isEmptyPlan(plans[1]) && !isEmptyPlan(plans[0])) { idxToUpdate = 1; }
          } else {
            // No times to compare → avoid overwriting; only seed into empty plan if one exists
            if (isEmptyPlan(plans[0]) && !isEmptyPlan(plans[1])) idxToUpdate = 0;
            else if (isEmptyPlan(plans[1]) && !isEmptyPlan(plans[0])) idxToUpdate = 1;
          }

          if (idxToUpdate !== null){
            const fields = (plans[idxToUpdate] && plans[idxToUpdate].fields) ? plans[idxToUpdate].fields : {};
            fields[`aircraft-${cellId}`] = dom.aircraft;
            fields[`arrival-time-${cellId}`] = dom.arrIso || '';
            fields[`departure-time-${cellId}`] = dom.depIso || '';
            fields[`position-${cellId}`] = dom.pos;
            fields[`hangar-position-${cellId}`] = dom.hangarPos;
            fields[`status-${cellId}`] = dom.status || fields[`status-${cellId}`] || '';
            fields[`tow-status-${cellId}`] = dom.tow || fields[`tow-status-${cellId}`] || '';
            plans[idxToUpdate] = { fields };
            writePlans(cellId, plans);
          }

          // Always refresh tab labels and active/next badges for this tile
          renderScheduleUI(cellId);
        });
        // Refresh the global schedule panel as well
        try { if (typeof window.refreshGlobalSchedule === 'function') window.refreshGlobalSchedule(); } catch(_e){}
      } catch(_e){}
    }, 50);
  });
})();
</script>

<!-- Global vertical schedule logic -->
<script>
(function(){
  function shortReg(s){ try { const t = (s||'').toUpperCase().replace(/[^A-Z0-9]/g,''); return t.length ? t.slice(-3) : '+'; } catch(_e){ return '+'; } }
  function toMs(iso){
    if (typeof iso !== 'string' || !/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(iso)) return NaN;
    const [d,t] = iso.split('T'); const [y,m,day]=d.split('-').map(Number); const [hh,mm]=t.split(':').map(Number);
    return Date.UTC(y,(m||1)-1,day||1,hh||0,mm||0,0,0);
  }
  function canon(id, val){ try { return (window.helpers && typeof window.helpers.canonicalizeDateTimeFieldValue==='function') ? (window.helpers.canonicalizeDateTimeFieldValue(id, val)||'') : (val||''); } catch(_e){ return val||''; } }
  function readPlans(cellId){ try { const raw = localStorage.getItem('tile.plans') || '{}'; const obj = JSON.parse(raw)||{}; const v = obj[String(cellId)]; return Array.isArray(v) ? v : []; } catch(_e){ return []; } }
  function writePlans(cellId, plans){ try { const raw = localStorage.getItem('tile.plans') || '{}'; const obj = JSON.parse(raw)||{}; obj[String(cellId)] = plans; localStorage.setItem('tile.plans', JSON.stringify(obj)); } catch(_e){} }
  function snapshotDomFields(cellId){
    const ids = [`aircraft-${cellId}`, `arrival-time-${cellId}`, `departure-time-${cellId}`, `hangar-position-${cellId}`, `position-${cellId}`, `notes-${cellId}`, `status-${cellId}`, `tow-status-${cellId}`];
    const fields = {};
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (id.startsWith('arrival-time-') || id.startsWith('departure-time-')){
        const raw = (el.dataset && el.dataset.iso) ? el.dataset.iso : (el.value || '');
        fields[id] = raw || '';
      } else {
        fields[id] = el.value || '';
      }
    });
    return fields;
  }
  function ensurePlansSeededFromDom(){
    const aircraftInputs = document.querySelectorAll('#hangarGrid .hangar-cell input[id^="aircraft-"], #secondaryHangarGrid .hangar-cell input[id^="aircraft-"]');
    aircraftInputs.forEach(inp=>{
      const m = inp.id.match(/aircraft-(\d+)/); if (!m) return; const cellId = parseInt(m[1],10); if (!isFinite(cellId)) return;
      let plans = readPlans(cellId);
      if (!Array.isArray(plans) || plans.length === 0) plans = [{fields:{}},{fields:{}}];
      const empty0 = !plans[0]?.fields || Object.keys(plans[0].fields).length===0;
      const empty1 = !plans[1]?.fields || Object.keys(plans[1].fields).length===0;
      if (empty0 && empty1){
        const snap = snapshotDomFields(cellId);
        const hasData = Object.keys(snap).some(k=> (snap[k]||'').trim().length);
        if (hasData){ plans[0] = { fields: snap }; writePlans(cellId, plans); }
      }
    });
  }
  function collectEntries(){
    ensurePlansSeededFromDom();
    const out = [];
    try {
      const raw = localStorage.getItem('tile.plans') || '{}';
      const obj = JSON.parse(raw)||{};
      Object.keys(obj).forEach(k=>{
        const cellId = parseInt(k,10); if (!isFinite(cellId)) return;
        const plans = Array.isArray(obj[k]) ? obj[k] : [];
        plans.forEach((p,idx)=>{
          const f = (p && p.fields) ? p.fields : {};
          const reg = (f[`aircraft-${cellId}`]||'').trim();
          const arrIso = canon(`arrival-time-${cellId}`, f[`arrival-time-${cellId}`]||'');
          const depIso = canon(`departure-time-${cellId}`, f[`departure-time-${cellId}`]||'');
          const pos = (f[`hangar-position-${cellId}`]||'').trim();
          const arrMs = toMs(arrIso), depMs = toMs(depIso);
          if (!reg && !isFinite(arrMs) && !isFinite(depMs)) return; // skip empty
          out.push({ cellId, idx, reg, regShort: shortReg(reg), arrIso, depIso, arrMs, depMs, pos });
        });
      });
    } catch(_e){}
    // Fallback: if still empty, read current DOM values to display at least current tiles
    if (!out.length){
      const aircraftInputs = document.querySelectorAll('#hangarGrid .hangar-cell input[id^="aircraft-"], #secondaryHangarGrid .hangar-cell input[id^="aircraft-"]');
      aircraftInputs.forEach(inp=>{
        const m = inp.id.match(/aircraft-(\d+)/); if (!m) return; const cellId = parseInt(m[1],10); if (!isFinite(cellId)) return;
        const f = snapshotDomFields(cellId);
        const reg = (f[`aircraft-${cellId}`]||'').trim();
        const arrIso = canon(`arrival-time-${cellId}`, f[`arrival-time-${cellId}`]||'');
        const depIso = canon(`departure-time-${cellId}`, f[`departure-time-${cellId}`]||'');
        const pos = (f[`hangar-position-${cellId}`]||'').trim();
        const arrMs = toMs(arrIso), depMs = toMs(depIso);
        if (!reg && !isFinite(arrMs) && !isFinite(depMs)) return;
        out.push({ cellId, idx: 0, reg, regShort: shortReg(reg), arrIso, depIso, arrMs, depMs, pos });
      });
    }
    // sort by Arr then Dep
    out.sort((a,b)=>{
      const aKey = isFinite(a.arrMs) ? a.arrMs : Number.MAX_SAFE_INTEGER;
      const bKey = isFinite(b.arrMs) ? b.arrMs : Number.MAX_SAFE_INTEGER;
      if (aKey !== bKey) return aKey - bKey;
      const aD = isFinite(a.depMs) ? a.depMs : Number.MAX_SAFE_INTEGER;
      const bD = isFinite(b.depMs) ? b.depMs : Number.MAX_SAFE_INTEGER;
      return aD - bD;
    });
    // mark conflicts: overlapping times for same hangar position (case-insensitive) OR same cellId
    const groups = new Map();
    out.forEach(e=>{ const key = (e.pos||'').toUpperCase() || `CELL-${e.cellId}`; if(!groups.has(key)) groups.set(key, []); groups.get(key).push(e); });
    groups.forEach(list => {
      list.forEach((a,i)=>{ a.conflict = false; for (let j=0;j<list.length;j++){ if (i===j) continue; const b=list[j]; if (isFinite(a.arrMs)&&isFinite(a.depMs)&&isFinite(b.arrMs)&&isFinite(b.depMs)){ if (a.arrMs < b.depMs && b.arrMs < a.depMs) { a.conflict = true; break; } } }); });
    });
    return out;
  }
  function fmtHHmm(iso){ try { if (!iso) return ''; const d = new Date(toMs(iso)); if (!isFinite(d)) return ''; return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); } catch(_e){ return ''; } }
  function render(){
    const host = document.getElementById('globalScheduleList'); if (!host) return;
    const data = collectEntries();
    try { console.debug('Schedule entries:', data); } catch(_e){}
    host.innerHTML = data.map(e=>{
      const time = `${fmtHHmm(e.arrIso)}${e.arrIso?'–':''}${fmtHHmm(e.depIso)}`;
      const meta = `${e.reg || ''}${e.pos? ' • '+e.pos : ''}`;
      const cls = `schedule-item${e.conflict?' conflict':''}`;
      return `<div class="${cls}" title="Tile ${e.cellId} • Plan ${e.idx+1}"><div class="time">${time}</div><div class="meta">${e.regShort} ${meta ? ('— '+meta) : ''}</div></div>`;
    }).join('');
  }
  function installLive(){
    const throttled = (()=>{ let t=null; return ()=>{ clearTimeout(t); t=setTimeout(render, 120); }; })();
    document.addEventListener('input', throttled, { passive:true });
    document.addEventListener('change', throttled, { passive:true });
    document.addEventListener('dataLoaded', throttled);
    document.addEventListener('aircraftDataUpdated', throttled);
    document.addEventListener('serverDataLoaded', throttled);
    setInterval(render, 60000);
  }
  window.refreshGlobalSchedule = render;
  window.hangarInitQueue = window.hangarInitQueue || [];
  window.hangarInitQueue.push(function(){ try { render(); installLive(); } catch(_e){} });
})();
</script>


				<!-- Enhanced submenu behavior for left rail (Step B) -->
				<script>
				(function(){
					const leftMenu = document.getElementById('leftMenu');
					if(!leftMenu) return;
					const scrim = document.getElementById('submenu-scrim');
					const panelNodes = document.querySelectorAll('.submenu-panel');
					const panels = {};
					panelNodes.forEach(p => { const k = p.getAttribute('data-for'); if(k) panels[k] = p; });
					const buttons = leftMenu.querySelectorAll('.menu-item[data-menu]');
					let current = null; // current open key
					let pinned = false;
					let closeTimer = null;

					function clearCloseTimer(){ if(closeTimer){ clearTimeout(closeTimer); closeTimer = null; } }
					function hideAll(){
						Object.values(panels).forEach(p=> p.classList.add('hidden'));
						buttons.forEach(btn=> { btn.classList.remove('active'); btn.setAttribute('aria-expanded','false'); });
						if (scrim) scrim.classList.add('hidden');
					}
					function show(key){
						if(!panels[key]) return;
						hideAll();
						panels[key].classList.remove('hidden');
						// Ensure display submenu reflects current persisted settings
						if (key === 'display' && window.displayOptions && typeof window.displayOptions.updateUI === 'function'){
							try {
								window.displayOptions.updateUI();
								// Ensure dark-mode class stays consistent on both <html> and <body>
								try {
									const html = document.documentElement;
									const body = document.body;
									const isDark = html.classList.contains('dark-mode') || body.classList.contains('dark-mode');
									html.classList.toggle('dark-mode', !!isDark);
									body.classList.toggle('dark-mode', !!isDark);
								} catch(_e){}
								// Refresh Tow select styling in case any UI updates affected class precedence
								try {
									const els = document.querySelectorAll('.tow-status-selector');
									els.forEach((el)=>{
										if (typeof window.updateTowStatusStyles === 'function') window.updateTowStatusStyles(el);
										else if (typeof updateTowStatusStyles === 'function') updateTowStatusStyles(el);
									});
								} catch(_e){}
							} catch(e){}
						}
						buttons.forEach(btn => { if(btn.getAttribute('data-menu')===key){ btn.classList.add('active'); btn.setAttribute('aria-expanded','true'); } });
						current = key;
					}
					function closeIfNotPinned(){ if(!pinned){ hideAll(); current = null; } }

					// Hover to preview (when not pinned)
					buttons.forEach(btn => {
						const key = btn.getAttribute('data-menu');
						btn.addEventListener('mouseenter', () => { if(!pinned){ clearCloseTimer(); show(key); } });
						btn.addEventListener('focus', () => { if(!pinned){ show(key); } });
						btn.addEventListener('click', (e) => {
							e.preventDefault();
							if(!pinned){
								pinned = true; show(key);
								if (scrim) scrim.classList.remove('hidden');
							}else{
								if(current === key){ // toggle off
									pinned = false; hideAll(); current = null;
								}else{ // switch pinned panel
									pinned = true; show(key);
									if (scrim) scrim.classList.remove('hidden');
								}
							}
						});
					});

					// Keep open while hovering panel
					Object.entries(panels).forEach(([key,panel]) => {
						panel.addEventListener('mouseenter', clearCloseTimer);
						panel.addEventListener('mouseleave', () => { if(!pinned){ closeTimer = setTimeout(() => closeIfNotPinned(), 150); } });
					});

					// Leaving menu when not pinned -> close after short delay unless entering panel
					leftMenu.addEventListener('mouseleave', () => { if(!pinned){ closeTimer = setTimeout(() => closeIfNotPinned(), 150); } });
					leftMenu.addEventListener('mouseenter', clearCloseTimer);

					// Click outside (or on scrim) always closes
					document.addEventListener('click', (e) => {
						const inMenu = leftMenu.contains(e.target);
						const inPanel = current && panels[current] && panels[current].contains(e.target);
						const clickedScrim = scrim && scrim.contains(e.target);
						if (clickedScrim) {
							pinned = false; hideAll(); current = null; return;
						}
						if(!inMenu && !inPanel){ pinned = false; hideAll(); current = null; }
					});

					// Explicit scrim handler
					if (scrim) {
						scrim.addEventListener('click', (e) => {
							e.stopPropagation();
							pinned = false; hideAll(); current = null;
						});
					}

					// ESC always closes and unpins
					document.addEventListener('keydown', (e) => {
						if(e.key === 'Escape'){
							pinned = false;
							hideAll();
							current = null;
						}
					});

					// Initialize ARIA
					buttons.forEach(btn => btn.setAttribute('aria-expanded','false'));
				})();
				</script>

				<div class="flex-grow bg-white p-3 overflow-auto hangar-container">
					<!-- Top Tabs -->
					<div id="topTabs" class="flex gap-2 mb-1" role="tablist" aria-label="Sections" style="position: sticky; top: 0; z-index: 20;">
						<button id="tab-planner" class="tab-btn" data-tab="planner" role="tab" aria-controls="panel-planner" aria-selected="true" title="Hangar Planner">Planner</button>
						<button id="tab-timetable" class="tab-btn" data-tab="timetable" role="tab" aria-controls="panel-timetable" aria-selected="false" title="Timetable">Timetable</button>
						<button id="tab-database" class="tab-btn" data-tab="database" role="tab" aria-controls="panel-database" aria-selected="false" title="Database">Database</button>
					</div>

					<!-- Panels -->
					<div id="panel-planner" class="tab-panel" role="tabpanel" aria-labelledby="tab-planner">
						<div class="planner-grid" id="plannerTwoCol">
							<div id="plannerMainCol">
								<!-- Abschnitt 1 Container -->
								<div class="section-container">
						<div id="hangarGrid" class="grid grid-cols-4 gap-4">
							<!-- 8 Hangar-Kacheln hier -->
							<!-- Kachel 1 - NEU GESTALTET -->
							<div
								class="hangar-cell bg-white rounded-lg shadow-md flex flex-col">
								<!-- Header mit Statuslicht und Status-Dropdown -->
								<div class="card-header">
									<div class="header-elements">
										<!-- Statuslicht und Dropdown -->
										<div class="status-dropdown-container">
											<span
												class="status-light status-neutral"
												data-cell="1"
												data-status="neutral"></span>
											<select
												id="status-1"
												class="status-selector"
												title="Aircraft Status">
												<option value="neutral" selected></option>
												<option value="ready">Ready</option>
												<option value="maintenance">MX</option>
												<option value="aog">AOG</option>
											</select>
										</div>

										<!-- Position -->
										<div class="position-container">
											<input
												type="text"
												placeholder="1A"
												id="hangar-position-1"
												class="position-input"
												title="Hangar Position" />
										</div>
									</div>
								</div>

								<!-- Hauptbereich -->
								<div class="p-3 flex-grow flex flex-col">
									<input
										type="text"
										id="aircraft-1"
										placeholder="Aircraft ID"
										class="aircraft-id" />

									<!-- Einheitliche Ausrichtung für Infos -->
									<div class="info-grid mb-3">
										<div class="info-label">Arr:</div>
										<input
											type="datetime-local"
											id="arrival-time-1"
											class="info-input"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm" />

										<div class="info-label">Dep:</div>
										<input
											type="datetime-local"
											id="departure-time-1"
											class="info-input"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm" />

										<div class="info-label">Pos:</div>
										<input
											type="text"
											id="position-1"
											class="info-input"
											placeholder=""
											maxlength="10"
											title="Aircraft position" />

										<div class="info-label">Tow:</div>
										<div class="tow-status-container">
											<select id="tow-status-1" class="tow-status-selector">
												<option value="neutral" selected></option>
												<option value="initiated" class="tow-initiated">
													Initiated
												</option>
												<option value="ongoing" class="tow-ongoing">
													In Progress
												</option>
												<option value="on-position" class="tow-on-position">
													On Position
												</option>
											</select>
										</div>
									</div>

									<!-- Notizen mit einer Zeile -->
									<div class="notes-container">
										<textarea
											id="notes-1"
											placeholder="Enter notes..."
											class="notes-textarea"></textarea>
									</div>
								</div>
							</div>

							<!-- Kachel 2 mit neuem Layout -->
							<div
								class="hangar-cell bg-white rounded-lg shadow-md flex flex-col">
								<!-- Header mit Statuslicht und Status-Dropdown -->
								<div class="card-header">
									<div class="header-elements">
										<!-- Statuslicht und Dropdown -->
										<div class="status-dropdown-container">
											<span
												class="status-light status-neutral"
												data-cell="2"
												data-status="neutral"></span>
											<select
												id="status-2"
												class="status-selector"
												title="Aircraft Status">
												<option value="neutral" selected></option>
												<option value="ready">Ready</option>
												<option value="maintenance">MX</option>
												<option value="aog">AOG</option>
											</select>
										</div>

										<!-- Position -->
										<div class="position-container">
											<input
												type="text"
												placeholder="1B"
												id="hangar-position-2"
												class="position-input"
												title="Hangar Position" />
										</div>
									</div>
								</div>

								<div class="p-3 flex-grow flex flex-col">
									<input
										type="text"
										id="aircraft-2"
										placeholder="Aircraft ID"
										class="aircraft-id" />

									<!-- Einheitliche Ausrichtung für Infos -->
									<div class="info-grid mb-3">
										<div class="info-label">Arr:</div>
										<input
											type="datetime-local"
											id="arrival-time-2"
											class="info-input"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm" />

										<div class="info-label">Dep:</div>
										<input
											type="datetime-local"
											id="departure-time-2"
											class="info-input"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm" />

										<div class="info-label">Pos:</div>
										<input
											type="text"
											id="position-2"
											class="info-input"
											placeholder=""
											maxlength="10"
											title="Aircraft position" />

										<div class="info-label">Tow:</div>
										<div class="tow-status-container">
											<select id="tow-status-2" class="tow-status-selector">
												<option value="neutral" selected></option>
												<option value="initiated" class="tow-initiated">
													Initiated
												</option>
												<option value="ongoing" class="tow-ongoing">
													In Progress
												</option>
												<option value="on-position" class="tow-on-position">
													On Position
												</option>
											</select>
										</div>
									</div>

									<!-- Notizen mit einer Zeile -->
									<div class="notes-container">
										<textarea
											id="notes-2"
											placeholder="Enter notes..."
											class="notes-textarea"></textarea>
									</div>
								</div>
							</div>

							<!-- Kachel 3 mit neuem Layout -->
							<div
								class="hangar-cell bg-white rounded-lg shadow-md flex flex-col">
								<!-- Header mit Statuslicht und Status-Dropdown -->
								<div class="card-header">
									<div class="header-elements">
										<!-- Statuslicht und Dropdown -->
										<div class="status-dropdown-container">
											<span
												class="status-light status-neutral"
												data-cell="3"
												data-status="neutral"></span>
											<select
												id="status-3"
												class="status-selector"
												title="Aircraft Status">
												<option value="neutral" selected></option>
												<option value="ready">Ready</option>
												<option value="maintenance">MX</option>
												<option value="aog">AOG</option>
											</select>
										</div>

										<!-- Position -->
										<div class="position-container">
											<input
												type="text"
												placeholder="2A"
												id="hangar-position-3"
												class="position-input"
												title="Hangar Position" />
										</div>
									</div>
								</div>

								<div class="p-3 flex-grow flex flex-col">
									<input
										type="text"
										id="aircraft-3"
										placeholder="Aircraft ID"
										class="aircraft-id" />

									<!-- Einheitliche Ausrichtung für Infos -->
									<div class="info-grid mb-3">
										<div class="info-label">Arr:</div>
										<input
type="datetime-local"
											id="arrival-time-3"
											title="Date/Time (UTC)"
placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />

										<div class="info-label">Dep:</div>
										<input
type="datetime-local"
											id="departure-time-3"
											title="Date/Time (UTC)"
         placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />

										<div class="info-label">Pos:</div>
										<input
											type="text"
											id="position-3"
											class="info-input"
											placeholder=""
											maxlength="10"
											title="Aircraft position" />

										<div class="info-label">Tow:</div>
										<div class="tow-status-container">
											<select id="tow-status-3" class="tow-status-selector">
												<option value="neutral" selected></option>
												<option value="initiated" class="tow-initiated">
													Initiated
												</option>
												<option value="ongoing" class="tow-ongoing">
													In Progress
												</option>
												<option value="on-position" class="tow-on-position">
													On Position
												</option>
											</select>
										</div>
									</div>

									<!-- Notizen mit einer Zeile -->
									<div class="notes-container">
										<textarea
											id="notes-3"
											placeholder="Enter notes..."
											class="notes-textarea"></textarea>
									</div>
								</div>
							</div>

							<!-- Kachel 4 mit neuem Layout + Notizfeld -->
							<div
								class="hangar-cell bg-white rounded-lg shadow-md flex flex-col">
								<!-- Header mit Statuslicht und Status-Dropdown -->
								<div class="card-header">
									<div class="header-elements">
										<!-- Statuslicht und Dropdown -->
										<div class="status-dropdown-container">
											<span
												class="status-light status-neutral"
												data-cell="4"
												data-status="neutral"></span>
											<select
												id="status-4"
												class="status-selector"
												title="Aircraft Status">
												<option value="neutral" selected></option>
												<option value="ready">Ready</option>
												<option value="maintenance">MX</option>
												<option value="aog">AOG</option>
											</select>
										</div>

										<!-- Position -->
										<div class="position-container">
											<input
												type="text"
												placeholder="2B"
												id="hangar-position-4"
												class="position-input"
												title="Hangar Position" />
										</div>
									</div>
								</div>

								<div class="p-3 flex-grow flex flex-col">
									<input
										type="text"
										id="aircraft-4"
										placeholder="Aircraft ID"
										class="aircraft-id" />

									<!-- Einheitliche Ausrichtung für Infos -->
									<div class="info-grid mb-3">
										<div class="info-label">Arr:</div>
										<input
type="datetime-local"
											id="arrival-time-4"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />

										<div class="info-label">Dep:</div>
										<input
type="datetime-local"
											id="departure-time-4"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />

										<div class="info-label">Pos:</div>
										<input
											type="text"
											id="position-4"
											class="info-input"
											placeholder=""
											maxlength="10"
											title="Aircraft position" />

										<div class="info-label">Tow:</div>
										<div class="tow-status-container">
											<select id="tow-status-4" class="tow-status-selector">
												<option value="neutral" selected></option>
												<option value="initiated" class="tow-initiated">
													Initiated
												</option>
												<option value="ongoing" class="tow-ongoing">
													In Progress
												</option>
												<option value="on-position" class="tow-on-position">
													On Position
												</option>
											</select>
										</div>
									</div>

									<!-- Notizen mit einer Zeile -->
									<div class="notes-container">
										<textarea
											id="notes-4"
											placeholder="Enter notes..."
											class="notes-textarea"></textarea>
									</div>
								</div>
							</div>

							<!-- Kachel 5-8 mit dem gleichen optimierten Layout -->
							<!-- Kachel 5 -->
							<div
								class="hangar-cell bg-white rounded-lg shadow-md flex flex-col">
								<!-- Header mit Statuslicht und Status-Dropdown -->
								<div class="card-header">
									<div class="header-elements">
										<!-- Statuslicht und Dropdown -->
										<div class="status-dropdown-container">
											<span
												class="status-light status-neutral"
												data-cell="5"
												data-status="neutral"></span>
											<select
												id="status-5"
												class="status-selector"
												title="Aircraft Status">
												<option value="neutral" selected></option>
												<option value="ready">Ready</option>
												<option value="maintenance">MX</option>
												<option value="aog">AOG</option>
											</select>
										</div>

										<!-- Position -->
										<div class="position-container">
											<input
												type="text"
												placeholder="2C"
												id="hangar-position-5"
												class="position-input"
												title="Hangar Position" />
										</div>
									</div>
								</div>

								<!-- Hauptbereich mit Infos und Notizfeld -->
								<div class="p-3 flex-grow flex flex-col">
									<input
										type="text"
										id="aircraft-5"
										placeholder="Aircraft ID"
										class="aircraft-id" />

									<div class="info-grid mb-3">
										<div class="info-label">Arr:</div>
										<input
type="datetime-local"
											id="arrival-time-5"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Dep:</div>
										<input
type="datetime-local"
											id="departure-time-5"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Pos:</div>
										<input
											type="text"
											id="position-5"
											class="info-input"
											placeholder=""
											maxlength="10"
											title="Aircraft position" />
										<div class="info-label">Tow:</div>
										<div class="tow-status-container">
											<select id="tow-status-5" class="tow-status-selector">
												<option value="neutral" selected></option>
												<option value="initiated" class="tow-initiated">
													Initiated
												</option>
												<option value="ongoing" class="tow-ongoing">
													In Progress
												</option>
												<option value="on-position" class="tow-on-position">
													On Position
												</option>
											</select>
										</div>
									</div>

									<!-- Notizfeld einzeilig -->
									<div class="notes-container">
										<textarea
											id="notes-5"
											placeholder="Enter notes..."
											class="notes-textarea"></textarea>
									</div>
								</div>
							</div>

							<!-- Kachel 6 mit neuem Design -->
							<div
								class="hangar-cell bg-white rounded-lg shadow-md flex flex-col">
								<!-- Header mit Statuslicht und Status-Dropdown -->
								<div class="card-header">
									<div class="header-elements">
										<!-- Statuslicht und Dropdown -->
										<div class="status-dropdown-container">
											<span
												class="status-light status-neutral"
												data-cell="6"
												data-status="neutral"></span>
											<select
												id="status-6"
												class="status-selector"
												title="Aircraft Status">
												<option value="neutral" selected></option>
												<option value="ready">Ready</option>
												<option value="maintenance">MX</option>
												<option value="aog">AOG</option>
											</select>
										</div>

										<!-- Position -->
										<div class="position-container">
											<input
												type="text"
												placeholder="3A"
												id="hangar-position-6"
												class="position-input"
												title="Hangar Position" />
										</div>
									</div>
								</div>

								<!-- Hauptbereich -->
								<div class="p-3 flex-grow flex flex-col">
									<input
										type="text"
										id="aircraft-6"
										placeholder="Aircraft ID"
										class="aircraft-id" />

									<div class="info-grid mb-3">
										<div class="info-label">Arr:</div>
										<input
type="datetime-local"
											id="arrival-time-6"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Dep:</div>
										<input
type="datetime-local"
											id="departure-time-6"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Pos:</div>
										<input
											type="text"
											id="position-6"
											class="info-input"
											placeholder=""
											maxlength="10"
											title="Aircraft position" />
										<div class="info-label">Tow:</div>
										<div class="tow-status-container">
											<select id="tow-status-6" class="tow-status-selector">
												<option value="neutral" selected></option>
												<option value="initiated" class="tow-initiated">
													Initiated
												</option>
												<option value="ongoing" class="tow-ongoing">
													In Progress
												</option>
												<option value="on-position" class="tow-on-position">
													On Position
												</option>
											</select>
										</div>
									</div>

									<!-- Notizen einzeilig -->
									<div class="notes-container">
										<textarea
											id="notes-6"
											placeholder="Enter notes..."
											class="notes-textarea"></textarea>
									</div>
								</div>
							</div>

							<!-- Kachel 7 mit neuem Design -->
							<div
								class="hangar-cell bg-white rounded-lg shadow-md flex flex-col">
								<!-- Header mit Statuslicht und Status-Dropdown -->
								<div class="card-header">
									<div class="header-elements">
										<!-- Statuslicht und Dropdown -->
										<div class="status-dropdown-container">
											<span
												class="status-light status-neutral"
												data-cell="7"
												data-status="neutral"></span>
											<select
												id="status-7"
												class="status-selector"
												title="Aircraft Status">
												<option value="neutral" selected></option>
												<option value="ready">Ready</option>
												<option value="maintenance">MX</option>
												<option value="aog">AOG</option>
											</select>
										</div>

										<!-- Position -->
										<div class="position-container">
											<input
												type="text"
												placeholder="3B"
												id="hangar-position-7"
												class="position-input"
												title="Hangar Position" />
										</div>
									</div>
								</div>

								<!-- Hauptbereich -->
								<div class="p-3 flex-grow flex flex-col">
									<input
										type="text"
										id="aircraft-7"
										placeholder="Aircraft ID"
										class="aircraft-id" />

									<div class="info-grid mb-3">
										<div class="info-label">Arr:</div>
										<input
type="datetime-local"
											id="arrival-time-7"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Dep:</div>
										<input
type="datetime-local"
											id="departure-time-7"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Pos:</div>
										<input
											type="text"
											id="position-7"
											class="info-input"
											placeholder=""
											maxlength="10"
											title="Aircraft position" />

										<div class="info-label">Tow:</div>
										<div class="tow-status-container">
											<select id="tow-status-7" class="tow-status-selector">
												<option value="neutral" selected></option>
												<option value="initiated" class="tow-initiated">
													Initiated
												</option>
												<option value="ongoing" class="tow-ongoing">
													In Progress
												</option>
												<option value="on-position" class="tow-on-position">
													On Position
												</option>
											</select>
										</div>
									</div>

									<!-- Notizen einzeilig -->
									<div class="notes-container">
										<textarea
											id="notes-7"
											placeholder="Enter notes..."
											class="notes-textarea"></textarea>
									</div>
								</div>
							</div>

							<!-- Kachel 8 mit neuem Design -->
							<div
								class="hangar-cell bg-white rounded-lg shadow-md flex flex-col">
								<!-- Header mit Statuslicht und Status-Dropdown -->
								<div class="card-header">
									<div class="header-elements">
										<!-- Statuslicht und Dropdown -->
										<div class="status-dropdown-container">
											<span
												class="status-light status-neutral"
												data-cell="8"
												data-status="neutral"></span>
											<select
												id="status-8"
												class="status-selector"
												title="Aircraft Status">
												<option value="neutral" selected></option>
												<option value="ready">Ready</option>
												<option value="maintenance">MX</option>
												<option value="aog">AOG</option>
											</select>
										</div>

										<!-- Position -->
										<div class="position-container">
											<input
												type="text"
												placeholder="4A"
												id="hangar-position-8"
												class="position-input"
												title="Hangar Position" />
										</div>
									</div>
								</div>

								<!-- Hauptbereich -->
								<div class="p-3 flex-grow flex flex-col">
									<input
										type="text"
										id="aircraft-8"
										placeholder="Aircraft ID"
										class="aircraft-id" />

									<div class="info-grid mb-3">
										<div class="info-label">Arr:</div>
										<input
type="datetime-local"
											id="arrival-time-8"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Dep:</div>
										<input
type="datetime-local"
											id="departure-time-8"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Pos:</div>
										<input
											type="text"
											id="position-8"
											class="info-input"
											placeholder=""
											maxlength="10"
											title="Aircraft position" />
										<div class="info-label">Tow:</div>
										<div class="tow-status-container">
											<select id="tow-status-8" class="tow-status-selector">
												<option value="neutral" selected></option>
												<option value="initiated" class="tow-initiated">
													Initiated
												</option>
												<option value="ongoing" class="tow-ongoing">
													In Progress
												</option>
												<option value="on-position" class="tow-on-position">
													On Position
												</option>
											</select>
										</div>
									</div>

									<!-- Notizen einzeilig -->
									<div class="notes-container">
										<textarea
											id="notes-8"
											placeholder="Enter notes..."
											class="notes-textarea"></textarea>
									</div>
								</div>
							</div>

							<!-- Kachel 9 -->
							<div
								class="hangar-cell bg-white rounded-lg shadow-md flex flex-col">
								<!-- Header mit Statuslicht und Status-Dropdown -->
								<div class="card-header">
									<div class="header-elements">
										<!-- Statuslicht und Dropdown -->
										<div class="status-dropdown-container">
											<span
												class="status-light status-neutral"
												data-cell="9"
												data-status="neutral"></span>
											<select
												id="status-9"
												class="status-selector"
												title="Aircraft Status">
												<option value="neutral" selected></option>
												<option value="ready">Ready</option>
												<option value="maintenance">MX</option>
												<option value="aog">AOG</option>
											</select>
										</div>

										<!-- Position -->
										<div class="position-container">
											<input
												type="text"
												placeholder="3A"
												id="hangar-position-9"
												class="position-input"
												title="Hangar Position" />
										</div>
									</div>
								</div>

								<div class="p-3 flex-grow flex flex-col">
									<input
										type="text"
										id="aircraft-9"
										placeholder="Aircraft ID"
										class="aircraft-id" />

									<div class="info-grid mb-3">
										<div class="info-label">Arr:</div>
										<input
type="datetime-local"
											id="arrival-time-9"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Dep:</div>
										<input
type="datetime-local"
											id="departure-time-9"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Pos:</div>
										<input
											type="text"
											id="position-9"
											class="info-input"
											placeholder=""
											maxlength="10"
											title="Aircraft position" />
										<div class="info-label">Tow:</div>
										<div class="tow-status-container">
											<select id="tow-status-9" class="tow-status-selector">
												<option value="neutral" selected></option>
												<option value="initiated" class="tow-initiated">
													Initiated
												</option>
												<option value="ongoing" class="tow-ongoing">
													In Progress
												</option>
												<option value="on-position" class="tow-on-position">
													On Position
												</option>
											</select>
										</div>
									</div>

									<div class="notes-container">
										<textarea
											id="notes-9"
											placeholder="Enter notes..."
											class="notes-textarea"></textarea>
									</div>
								</div>
							</div>

							<!-- Kachel 10 -->
							<div
								class="hangar-cell bg-white rounded-lg shadow-md flex flex-col">
								<!-- Header mit Statuslicht und Status-Dropdown -->
								<div class="card-header">
									<div class="header-elements">
										<!-- Statuslicht und Dropdown -->
										<div class="status-dropdown-container">
											<span
												class="status-light status-neutral"
												data-cell="10"
												data-status="neutral"></span>
											<select
												id="status-10"
												class="status-selector"
												title="Aircraft Status">
												<option value="neutral" selected></option>
												<option value="ready">Ready</option>
												<option value="maintenance">MX</option>
												<option value="aog">AOG</option>
											</select>
										</div>

										<!-- Position -->
										<div class="position-container">
											<input
												type="text"
												placeholder="3B"
												id="hangar-position-10"
												class="position-input"
												title="Hangar Position" />
										</div>
									</div>
								</div>

								<div class="p-3 flex-grow flex flex-col">
									<input
										type="text"
										id="aircraft-10"
										placeholder="Aircraft ID"
										class="aircraft-id" />

									<div class="info-grid mb-3">
										<div class="info-label">Arr:</div>
										<input
type="datetime-local"
											id="arrival-time-10"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Dep:</div>
										<input
type="datetime-local"
											id="departure-time-10"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Pos:</div>
										<input
											type="text"
											id="position-10"
											class="info-input"
											placeholder=""
											maxlength="10"
											title="Aircraft position" />
										<div class="info-label">Tow:</div>
										<div class="tow-status-container">
											<select id="tow-status-10" class="tow-status-selector">
												<option value="neutral" selected></option>
												<option value="initiated" class="tow-initiated">
													Initiated
												</option>
												<option value="ongoing" class="tow-ongoing">
													In Progress
												</option>
												<option value="on-position" class="tow-on-position">
													On Position
												</option>
											</select>
										</div>
									</div>

									<div class="notes-container">
										<textarea
											id="notes-10"
											placeholder="Enter notes..."
											class="notes-textarea"></textarea>
									</div>
								</div>
							</div>

							<!-- Kachel 11 -->
							<div
								class="hangar-cell bg-white rounded-lg shadow-md flex flex-col">
								<!-- Header mit Statuslicht und Status-Dropdown -->
								<div class="card-header">
									<div class="header-elements">
										<!-- Statuslicht und Dropdown -->
										<div class="status-dropdown-container">
											<span
												class="status-light status-neutral"
												data-cell="11"
												data-status="neutral"></span>
											<select
												id="status-11"
												class="status-selector"
												title="Aircraft Status">
												<option value="neutral" selected></option>
												<option value="ready">Ready</option>
												<option value="maintenance">MX</option>
												<option value="aog">AOG</option>
											</select>
										</div>

										<!-- Position -->
										<div class="position-container">
											<input
												type="text"
												placeholder="3C"
												id="hangar-position-11"
												class="position-input"
												title="Hangar Position" />
										</div>
									</div>
								</div>

								<div class="p-3 flex-grow flex flex-col">
									<input
										type="text"
										id="aircraft-11"
										placeholder="Aircraft ID"
										class="aircraft-id" />

									<div class="info-grid mb-3">
										<div class="info-label">Arr:</div>
										<input
type="datetime-local"
											id="arrival-time-11"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Dep:</div>
										<input
type="datetime-local"
											id="departure-time-11"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />

										<div class="info-label">Pos:</div>
										<input
											type="text"
											id="position-11"
											class="info-input"
											placeholder=""
											maxlength="10"
											title="Aircraft position" />

										<div class="info-label">Tow:</div>
										<div class="tow-status-container">
											<select id="tow-status-11" class="tow-status-selector">
												<option value="neutral" selected></option>
												<option value="initiated" class="tow-initiated">
													Initiated
												</option>
												<option value="ongoing" class="tow-ongoing">
													In Progress
												</option>
												<option value="on-position" class="tow-on-position">
													On Position
												</option>
											</select>
										</div>
									</div>

									<div class="notes-container">
										<textarea
											id="notes-11"
											placeholder="Enter notes..."
											class="notes-textarea"></textarea>
									</div>
								</div>
							</div>

							<!-- Kachel 12 -->
							<div
								class="hangar-cell bg-white rounded-lg shadow-md flex flex-col">
								<!-- Header mit Statuslicht und Status-Dropdown -->
								<div class="card-header">
									<div class="header-elements">
										<!-- Statuslicht und Dropdown -->
										<div class="status-dropdown-container">
											<span
												class="status-light status-neutral"
												data-cell="12"
												data-status="neutral"></span>
											<select
												id="status-12"
												class="status-selector"
												title="Aircraft Status">
												<option value="neutral" selected></option>
												<option value="ready">Ready</option>
												<option value="maintenance">MX</option>
												<option value="aog">AOG</option>
											</select>
										</div>

										<!-- Position -->
										<div class="position-container">
											<input
												type="text"
												placeholder="3D"
												id="hangar-position-12"
												class="position-input"
												title="Hangar Position" />
										</div>
									</div>
								</div>

								<div class="p-3 flex-grow flex flex-col">
									<input
										type="text"
										id="aircraft-12"
										placeholder="Aircraft ID"
										class="aircraft-id" />

									<div class="info-grid mb-3">
										<div class="info-label">Arr:</div>
										<input
type="datetime-local"
											id="arrival-time-12"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />
										<div class="info-label">Dep:</div>
										<input
type="datetime-local"
											id="departure-time-12"
											title="Date/Time (UTC)"
											placeholder="dd.mm.yy,HH:mm"
											class="info-input"
											title="Time" />

										<div class="info-label">Pos:</div>
										<input
											type="text"
											id="position-12"
											class="info-input"
											placeholder=""
											maxlength="10"
											title="Aircraft position" />

										<div class="info-label">Tow:</div>
										<div class="tow-status-container">
											<select id="tow-status-12" class="tow-status-selector">
												<option value="neutral" selected></option>
												<option value="initiated" class="tow-initiated">
													Initiated
												</option>
												<option value="ongoing" class="tow-ongoing">
													In Progress
												</option>
												<option value="on-position" class="tow-on-position">
													On Position
												</option>
											</select>
										</div>
									</div>

									<div class="notes-container">
										<textarea
											id="notes-12"
											placeholder="Enter notes..."
											class="notes-textarea"></textarea>
									</div>
								</div>
							</div>
							<!-- Kachel 12 schließender div-Tag hinzugefügt -->
						</div>
					</div>

							<!-- Horizontale Trennlinie mit gleichmäßigem Abstand -->
							<div class="section-divider"></div>

							<!-- Abschnitt 2 Container -->
							<div class="section-container">
								<div id="secondaryHangarGrid" class="grid grid-cols-4 gap-4">
									<!-- Hier werden dynamisch weitere Kacheln eingefügt -->
								</div>
							</div>
							</div> <!-- #plannerMainCol -->
							<!-- Right vertical schedule panel (inside grid) -->
							<aside id="globalSchedulePanel" aria-label="Global schedule">
								<div class="panel-title">Schedule</div>
								<div id="globalScheduleList"></div>
							</aside>
						</div> <!-- #plannerTwoCol -->

						</div> <!-- /panel-planner -->

					<!-- Timetable Panel -->
					<div id="panel-timetable" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-timetable" style="height: calc(100vh - 60px);">
						<iframe id="timetableFrame" src="timetable.html" title="Timetable"
							style="width:100%; height:100%; border:0; background: transparent;"></iframe>
					</div>

					<!-- Database Panel -->
					<div id="panel-database" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-database" style="height: calc(100vh - 60px);">
						<iframe id="databaseFrame" src="fleet-database.html" title="Fleet Database"
							style="width:100%; height:100%; border:0; background: transparent;"></iframe>
					</div>

				</div>
			</div>






				</div>

				<!-- Versteckte File-Input-Elemente -->
				<input type="file" id="jsonFileInput" accept=".json" class="hidden" />
				<input
					type="file"
					id="settingsFileInput"
					accept=".json"
					class="hidden" />
			</div>

			<!-- Modales Fenster für Laden -->
			<div
				id="loadModal"
				class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
				<div class="bg-industrial-medium rounded-lg p-6 w-96 max-w-full">
					<h2 class="text-xl font-bold mb-4">Load Hangar Plan</h2>
					<div class="mb-4">
						<input
							id="loadProjectName"
							type="text"
							placeholder="Enter Project Name"
							class="w-full bg-industrial-dark text-white px-3 py-2 rounded form-control" />
					</div>
					<div class="flex justify-end space-x-3">
						<button
							id="cancelLoad"
							class="px-4 py-2 bg-industrial-light text-industrial-dark rounded">
							Cancel
						</button>
						<button
							id="confirmLoad"
							class="px-4 py-2 bg-industrial-accent rounded">
							Load
						</button>
					</div>
				</div>
			</div>

				<!-- E-Mail-Erfolgsmeldung Modal -->
				<div
					id="emailSentModal"
					class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
					<div class="bg-industrial-medium rounded-lg p-6 w-96 max-w-full">
						<h2 class="text-xl font-bold mb-4">Email Sent</h2>
						<p class="mb-4">Your hangar plan has been sent successfully.</p>
						<div class="flex justify-end">
							<button
								id="emailOkBtn"
								class="px-4 py-2 bg-industrial-accent rounded">
								OK
							</button>
						</div>
					</div>
				</div>

				<!-- Reset confirmation modal (styled like other modals) -->
				<div id="resetConfirmModal" class="hp-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="resetConfirmTitle">
					<div class="hp-modal" role="document">
						<h2 id="resetConfirmTitle" class="hp-modal-title">Reset Screen</h2>
						<div class="hp-modal-body">
							This will clear all tile inputs (Aircraft, Arr/Dep, Pos/Route, Notes, Tow, Status). Hangar Position fields will be kept unchanged.
						</div>
						<div class="hp-modal-actions">
							<button id="resetCancelBtn" type="button" class="sidebar-btn sidebar-btn-secondary">Cancel</button>
							<button id="resetConfirmBtn" type="button" class="sidebar-btn sidebar-btn-primary">Reset</button>
						</div>
					</div>
				</div>

				<!-- Reset finished modal -->
				<div id="resetDoneModal" class="hp-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="resetDoneTitle">
					<div class="hp-modal" role="document">
						<h2 id="resetDoneTitle" class="hp-modal-title">Reset Completed</h2>
						<div class="hp-modal-body">All tile inputs have been cleared successfully.</div>
						<div class="hp-modal-actions" style="justify-content: flex-end;">
							<button id="resetDoneOkBtn" type="button" class="sidebar-btn sidebar-btn-primary">OK</button>
						</div>
					</div>
				</div>

			<!-- JavaScript-Dateien -->
			<script src="js/helpers.js"></script>
			<script src="js/global-initialization.js"></script>
			<script src="js/fileManager.js"></script>
			<script src="js/weather-api.js"></script>
			<script src="js/improved-event-manager.js"></script>
			<script src="js/hangar-ui.js"></script>
			<script src="js/hangar-data.js"></script>
			<script src="js/dynamic-api-loader.js"></script>
				<script src="js/aerodatabox-api.js"></script>
				<script src="js/flight-registration-lookup.js"></script>
				<script src="js/goflightlabs-api.js"></script>
			<script src="js/airport-flights.js"></script>
			<script src="js/api-facade.js"></script>
			<script src="js/hangar-events.js"></script>
			<script src="js/hangar-pdf.js"></script>
			<script src="js/hangar.js"></script>
			<script src="js/storage-browser.js"></script>
			<script src="js/sync-manager.js"></script>
			<script src="js/fleet-database-manager.js"></script>
			<script src="js/schedule-panel.js"></script>
						<script>
				// Ensure Sharing Manager initializes (binds sync toggles and manual sync button)
				window.hangarInitQueue = window.hangarInitQueue || [];
				window.hangarInitQueue.push(function(){
					try {
						if (window.sharingManager && !window.sharingManager.initialized) {
							window.sharingManager.init();
						}
					} catch (e) { console.warn('SharingManager init failed', e); }
				});
						</script>
						<script>
				// Minimal fallback if Sharing Manager script failed to load (ad blocker or network)
				(function(){
					function ensureSyncGlobals(){
						try {
							// Ensure serverSyncUrl and storageBrowser alias exist
							if (window.serverSync) {
								if (!window.serverSync.serverSyncUrl) {
									window.serverSync.serverSyncUrl = (function(){ try { return window.location.origin + '/sync/data.php'; } catch(_e){ return '/sync/data.php'; } })();
								}
								if (!window.storageBrowser) {
									window.storageBrowser = window.serverSync;
								}
							} else if (!window.storageBrowser) {
								// Install a minimal alias so improved-event-manager can proceed
								window.storageBrowser = {
									serverSyncUrl: (function(){ try { return window.location.origin + '/sync/data.php'; } catch(_e){ return '/sync/data.php'; } })(),
									syncWithServer: ()=> Promise.resolve(false)
								};
							}
							// Ensure window.serverSync points to the active sync object
							if (!window.serverSync && window.storageBrowser) {
								window.serverSync = window.storageBrowser;
							}
						} catch(_e){}
					}
					function installFallbackManager(){
						if (window.sharingManager) return;
						console.warn('SharingManager missing; installing minimal fallback');
window.sharingManager = {
							syncMode: 'master',
							initialized: true,
							serverSyncUrl: (function(){ try { return window.location.origin + '/sync/data.php'; } catch(_e){ return '/sync/data.php'; } })(),
updateAllSyncDisplays: function(){ try { const el = document.getElementById('sync-mode'); if (el){ const txt = this.syncMode==='master'?'Master':(this.syncMode==='sync'?'Sync':'Standalone'); el.textContent = txt; el.classList.remove('master','slave','standalone'); el.classList.add(this.syncMode==='master'?'master':(this.syncMode==='sync'?'slave':'standalone')); } } catch(e){} },
							applyReadOnlyUIState: function(isReadOnly){
								try {
									const ro = !!isReadOnly;
									document.body.classList.toggle('read-only', ro);
									const containers = [ document.getElementById('hangarGrid'), document.getElementById('secondaryHangarGrid') ];
									containers.forEach((container)=>{
										if (!container) return;
										const controls = container.querySelectorAll('input, textarea, select');
										controls.forEach((el)=>{
											if (ro){ if (!el.disabled){ el.setAttribute('data-readonly-disabled','true'); el.disabled = true; } }
											else { if (el.hasAttribute('data-readonly-disabled')){ el.disabled = false; el.removeAttribute('data-readonly-disabled'); } }
										});
									});
									// Simple modal on interaction with disabled controls (rate-limited)
									const ensureModal = function(){
									  let overlay = document.getElementById('readOnlyModalOverlay');
									  if (overlay) return overlay;
									  overlay = document.createElement('div');
									  overlay.id='readOnlyModalOverlay';
									  overlay.className = 'hp-modal-overlay';
									  const panel=document.createElement('div');
									  panel.id='readOnlyModalPanel';
									  panel.className = 'hp-modal';
									  panel.setAttribute('role','dialog');
									  panel.setAttribute('aria-modal','true');
									  panel.setAttribute('aria-labelledby','roModalTitle');
									  panel.innerHTML = '<div class="hp-modal-title" id="roModalTitle">Read-only mode is active<\/div><div class="hp-modal-body">You\'re in Sync (read-only). Edits are disabled and won\u2019t be saved to the server.<\/div><div class="hp-modal-actions"><button id="roModalSyncSettings" type="button" class="sidebar-btn sidebar-btn-secondary">Open Sync settings<\/button><button id="roModalOk" type="button" class="sidebar-btn sidebar-btn-primary">Got it<\/button><\/div>';
									  overlay.appendChild(panel); document.body.appendChild(overlay);
					  const okBtn = panel.querySelector('#roModalOk');
					  const openSyncBtn = panel.querySelector('#roModalSyncSettings');
					  const hide = () => { overlay.style.display='none'; document.removeEventListener('keydown', overlay.__escHandler, true); };
					  okBtn.addEventListener('click', hide);

					  function openSyncSubmenu(){
					    try {
					      const btn = document.querySelector('#leftMenu .menu-item[data-menu="sync"]');
					      const panel = document.getElementById('submenu-sync');
					      if (btn) {
					        btn.click();
					        setTimeout(()=>{
					          try {
					            const p = document.getElementById('submenu-sync');
					            if (p && p.classList.contains('hidden')){
					              p.classList.remove('hidden');
					              const scrim = document.getElementById('submenu-scrim');
					              if (scrim) scrim.classList.remove('hidden');
					              btn.classList.add('active');
					              btn.setAttribute('aria-expanded','true');
					            }
					          } catch(_e){}
					        }, 0);
					        return true;
					      }
					      if (panel){
					        panel.classList.remove('hidden');
					        const scrim = document.getElementById('submenu-scrim');
					        if (scrim) scrim.classList.remove('hidden');
					        return true;
					      }
					    } catch(_e){}
					    return false;
					  }

					  openSyncBtn.addEventListener('click', () => { openSyncSubmenu(); hide(); });
					  overlay.addEventListener('click', (e)=>{ if (e.target===overlay) hide(); });
					  overlay.__focusPrimary = () => { try { okBtn.focus(); } catch(_) {} };
					  overlay.__escHandler = (e) => { if (e.key==='Escape') hide(); };
									  return overlay;
									};
									if (ro && !this._roGuardHandler){
										this._roModalLast = this._roModalLast || 0;
										this._roGuardHandler = (ev)=>{
											try { const tgt = ev.target; if (!tgt) return; const control = tgt.closest('input, textarea, select, button'); if (!control) return; const blocked = control.disabled || control.getAttribute('aria-disabled')==='true'; if (blocked){ ev.preventDefault(); ev.stopPropagation(); const now=Date.now(); if (now-(this._roModalLast||0) > 3000){ this._roModalLast = now; ensureModal().style.display='flex'; } } } catch(_e){}
										};
										document.addEventListener('pointerdown', this._roGuardHandler, true);
									} else if (!ro && this._roGuardHandler){
										document.removeEventListener('pointerdown', this._roGuardHandler, true);
										this._roGuardHandler = null;
									}
								} catch(e){ console.warn('fallback applyReadOnlyUIState failed', e); }
							},
							enableStandaloneMode: function(){ try{ if (window.serverSync){ window.serverSync.isMaster=false; window.serverSync.isSlaveActive=false; if (typeof window.serverSync.stopPeriodicSync==='function') window.serverSync.stopPeriodicSync(); } this.syncMode='standalone'; this.updateAllSyncDisplays(); this.applyReadOnlyUIState(false); } catch(e){ console.warn(e); } },
							enableSyncMode: function(){ try{ if (window.serverSync){ window.serverSync.isMaster=false; window.serverSync.isSlaveActive=true; if (typeof window.serverSync.startSlaveMode==='function') window.serverSync.startSlaveMode(); } this.syncMode='sync'; this.updateAllSyncDisplays(); this.applyReadOnlyUIState(true); } catch(e){ console.warn(e); } },
							enableMasterMode: function(){ try{ if (window.serverSync){ window.serverSync.isMaster=true; window.serverSync.isSlaveActive=false; if (typeof window.serverSync.startMasterMode==='function') window.serverSync.startMasterMode(); } this.syncMode='master'; this.updateAllSyncDisplays(); this.applyReadOnlyUIState(false); } catch(e){ console.warn(e); } },
							handleModeControlChange: function(v){ if (v==='standalone') this.enableStandaloneMode(); else if (v==='sync') this.enableSyncMode(); else if (v==='master') this.enableMasterMode(); },
							performManualSync: async function(){ try{ if (!window.serverSync) return false; if (typeof window.serverSync.manualSync==='function') return await window.serverSync.manualSync(); if (typeof window.serverSync.syncWithServer==='function') return await window.serverSync.syncWithServer(); return false; } catch(e){ console.warn(e); return false; } }
						};
try { const modeCtl = document.getElementById('syncModeControl'); if (modeCtl){ modeCtl.value = 'master'; window.sharingManager.enableMasterMode(); modeCtl.addEventListener('change', (e)=>window.sharingManager.handleModeControlChange(e.target.value)); } } catch(_e){}
						console.log('Minimal Sync Manager fallback installed');
					}
					window.hangarInitQueue = window.hangarInitQueue || [];
					window.hangarInitQueue.push(function(){ setTimeout(function(){ ensureSyncGlobals(); installFallbackManager(); }, 400); });
					try { document.addEventListener('DOMContentLoaded', function(){ ensureSyncGlobals(); }, { once: true }); } catch(_e){}
				})();
						</script>

						<!-- Ensure Sync Debug URL is shown after init & add fallback debug helpers -->
						<script>
(function(){
							function getServerUrl(){ try { return (window.serverSync && typeof window.serverSync.getServerUrl==='function' && window.serverSync.getServerUrl()) || (window.serverSync && window.serverSync.serverSyncUrl) || (window.location.origin + '/sync/data.php'); } catch(e){ return window.location.origin + '/sync/data.php'; } }
							function log(line){ try { var el = document.getElementById('syncDebugLog'); var ts = new Date().toLocaleTimeString(); if (el){ var msg = '['+ts+'] '+line; el.textContent = (el.textContent ? el.textContent + '\n' : '') + msg; el.scrollTop = el.scrollHeight; } console.log(line); } catch(_e){} }
							function ensureSession(){ var sid = (window.serverSync && typeof window.serverSync.getSessionId==='function') ? window.serverSync.getSessionId() : (localStorage.getItem('serverSync.sessionId') || ''); if (!sid){ sid = Math.random().toString(36).slice(2) + Date.now().toString(36); try { localStorage.setItem('serverSync.sessionId', sid); } catch(_e){} } return sid; }
							function resetFlags(){ try { if (typeof window.resetSyncFlags==='function'){ window.resetSyncFlags(); } else { window.isApplyingServerData = false; } } catch(_e){} }
							// Fallback: collect tiles from DOM and POST directly when serverSync is unavailable
							function collectTilesFromDom(){
								var ids = new Set();
								try { document.querySelectorAll("[id^='aircraft-'], [id^='position-'], [id^='hangar-position-'], [id^='arrival-time-'], [id^='departure-time-'], [id^='status-'], [id^='tow-status-'], [id^='notes-']").forEach(function(el){ var m = el.id.match(/-(\d+)$/); if (m) ids.add(parseInt(m[1],10)); }); } catch(_e){}
								function getVal(prefix, id){ var el = document.getElementById(prefix+id); return el ? (el.value||'').trim() : ''; }
								function toTile(id){ var aircraftId = getVal('aircraft-', id); var pos = getVal('position-', id); var hpos = getVal('hangar-position-', id); var arr = getVal('arrival-time-', id); var dep = getVal('departure-time-', id); var status = getVal('status-', id) || 'neutral'; var tow = getVal('tow-status-', id) || 'neutral'; var notes = getVal('notes-', id); var has = !!(aircraftId || pos || hpos || arr || dep || notes || (status && status!=='neutral') || (tow && tow!=='neutral')); if (!has) return null; return { tileId: id, aircraftId: aircraftId, position: pos, hangarPosition: hpos, arrivalTime: arr, departureTime: dep, status: status, towStatus: tow, notes: notes }; }
								var all = Array.from(ids).sort(function(a,b){return a-b;});
								var primary = []; var secondary = [];
								all.forEach(function(id){ var t = toTile(id); if (!t) return; if (id>=100) secondary.push(t); else primary.push(t); });
								return { primary: primary, secondary: secondary };
							}
							async function fallbackSyncWrite(){
								try {
									var url = (window.serverSync && (window.serverSync.getServerUrl?.() || window.serverSync.serverSyncUrl)) || (window.storageBrowser && window.storageBrowser.serverSyncUrl) || (window.location.origin + '/sync/data.php');
									var dom = collectTilesFromDom();
									var body = { metadata: { timestamp: Date.now() }, settings: {}, primaryTiles: dom.primary, secondaryTiles: dom.secondary };
									var sid = (window.serverSync && typeof window.serverSync.getSessionId==='function') ? window.serverSync.getSessionId() : (localStorage.getItem('serverSync.sessionId') || '');
									var dname = (localStorage.getItem('presence.displayName') || '').trim();
									var res = await fetch(url, { method:'POST', headers: { 'Content-Type': 'application/json', 'X-Sync-Role':'master', 'X-Sync-Session': sid, 'X-Display-Name': dname }, body: JSON.stringify(body) });
									return res.ok;
								} catch(e){ console.warn('fallbackSyncWrite failed', e); return false; }
							}
							// Polyfill: applyTileData for older clients
							function polyfillApplyTileData(){ try {
								if (!window.serverSync || typeof window.serverSync.applyTileData==='function') return;
								window.serverSync.applyTileData = function(tiles, isSecondary){
									if (!Array.isArray(tiles)) return false;
									let applied = 0;
									tiles.forEach(function(t, idx){
										var id = parseInt(t && (t.tileId || (isSecondary? (101+idx):(1+idx))),10);
										if (!id) return;
										var setField = function(prefix, val){
											var el = document.getElementById(prefix+id);
											if (!el || val===undefined || val===null) return;
											if ('value' in el) { el.value = String(val); }
											else { el.textContent = String(val); }
											applied++;
										};
										// Aircraft (support multiple keys)
										var aircraftVal = (t.aircraft!==undefined? t.aircraft : (t.aircraftName!==undefined? t.aircraftName : (t.registration!==undefined? t.registration : t.aircraftId)));
										if (aircraftVal!==undefined) setField('aircraft-', aircraftVal);
										// Position
										var posVal = (t.position!==undefined? t.position : (t.hangarPosition!==undefined? t.hangarPosition : t.pos));
										if (posVal!==undefined){
											var pel = document.getElementById('position-'+id) || document.getElementById('hangar-position-'+id);
											if (pel){ if ('value' in pel) pel.value = String(posVal); else pel.textContent = String(posVal); applied++; }
										}
										// Notes
										if (t.notes!==undefined) setField('notes-', t.notes);
										// Times
										var arrVal = (t.arrivalTime!==undefined? t.arrivalTime : (t.arrTime!==undefined? t.arrTime : t.arrival));
										var depVal = (t.departureTime!==undefined? t.departureTime : (t.depTime!==undefined? t.depTime : t.departure));
										if (arrVal!==undefined) setField('arrival-time-', arrVal);
										if (depVal!==undefined) setField('departure-time-', depVal);
										// Status
										var statusVal = (t.status!==undefined? t.status : t.state);
										if (statusVal!==undefined) setField('status-', statusVal);
										// Tow
										var towVal = (t.towStatus!==undefined? t.towStatus : t.tow);
										if (towVal!==undefined) setField('tow-status-', towVal);
										// Route (if present)
										if (t.route!==undefined) setField('route-', t.route);
									});
									return applied>0;
								};
								log('Polyfilled serverSync.applyTileData');
							} catch(_e){}
							}
							// Debug-only: direct DOM apply if all other paths decline
							function debugApplyTiles(data){
								if (!data || (typeof data !== 'object')) return 0;
								var count = 0;
								function applyList(list, isSecondary){
									if (!Array.isArray(list)) return;
									list.forEach(function(t, idx){
										var id = parseInt(t && (t.tileId || t.id || (isSecondary? (101+idx):(1+idx))),10);
										if (!id) return;
										function setField(prefix, val){ var el = document.getElementById(prefix+id); if (!el || val===undefined || val===null) return; if ('value' in el) el.value = String(val); else el.textContent = String(val); count++; }
										var aircraftVal = (t.aircraftId ?? t.aircraft ?? t.aircraftName ?? t.registration);
										if (aircraftVal!==undefined) setField('aircraft-', aircraftVal);
										var posVal = (t.position ?? t.hangarPosition ?? t.pos);
										if (posVal!==undefined){ var pel = document.getElementById('position-'+id) || document.getElementById('hangar-position-'+id); if (pel){ if ('value' in pel) pel.value = String(posVal); else pel.textContent = String(posVal); count++; } }
										if (t.notes!==undefined) setField('notes-', t.notes);
										var arrVal = (t.arrivalTime ?? t.arrTime ?? t.arrival);
										var depVal = (t.departureTime ?? t.depTime ?? t.departure);
										if (arrVal!==undefined) setField('arrival-time-', arrVal);
										if (depVal!==undefined) setField('departure-time-', depVal);
										if (t.status!==undefined) setField('status-', t.status);
										var towVal = (t.towStatus ?? t.tow);
										if (towVal!==undefined) setField('tow-status-', towVal);
									});
								}
								applyList(data.primaryTiles, false);
								applyList(data.secondaryTiles, true);
								return count;
							}
							polyfillApplyTileData();
							window.syncDebugRead = async function(){ try { var url = getServerUrl(); log('GET '+url); var res = await fetch(url + (url.includes('?') ? '&' : '?') + 'action=load', { headers:{'Accept':'application/json'} }); log('GET status '+res.status); var text = await res.text(); log('Body (first 200): '+ text.slice(0,200)); try { var json = JSON.parse(text); resetFlags(); var tAS = (window.serverSync && typeof window.serverSync.applyServerData); var tAT = (window.serverSync && typeof window.serverSync.applyTileData); log('serverSync types: applyServerData='+tAS+', applyTileData='+tAT); if (window.serverSync && typeof window.serverSync.applyServerData==='function'){ var applied = await window.serverSync.applyServerData(json); if (!applied && typeof window.serverSync.applyTileData==='function'){ var a = window.serverSync.applyTileData(json.primaryTiles||[], false); var b = window.serverSync.applyTileData(json.secondaryTiles||[], true); applied = !!(a || b); } if (!applied){ var c = debugApplyTiles(json); log('debugApplyTiles applied count: '+c); applied = c>0; } log('applyServerData: '+applied); } } catch(_e){} } catch(e){ log('READ error: '+e.message); } };
							window.syncDebugWrite = async function(){ try { var url = getServerUrl(); var sid = ensureSession(); var dname = (localStorage.getItem('presence.displayName') || '').trim(); var body = { metadata:{ debugPing: new Date().toISOString(), timestamp: Math.round(Date.now()) } }; log('POST '+url); var res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json', 'X-Sync-Role':'master', 'X-Sync-Session': sid, 'X-Display-Name': dname }, body: JSON.stringify(body) }); log('POST status '+res.status); var text = await res.text(); log('Body (first 200): '+ text.slice(0,200)); await window.syncDebugRead(); } catch(e){ log('WRITE error: '+e.message); } };
							window.syncManual = async function(){ try { var btn = document.getElementById('manualSyncBtn'); if (btn){ btn.disabled = true; btn.textContent = 'Syncing...'; } var ok=false; try { if (window.serverSync && typeof window.serverSync.manualSync==='function'){ ok = await window.serverSync.manualSync(); } else if (window.serverSync && typeof window.serverSync.syncWithServer==='function'){ ok = await window.serverSync.syncWithServer(); } } catch(err){ log('manual sync call failed: '+err.message); ok=false; } if (!ok){ log('Manual sync falling back to direct POST'); ok = await fallbackSyncWrite(); } if (ok){ log('Manual sync OK'); try { await window.syncDebugRead(); } catch(_e){} } else { log('Manual sync failed'); } } finally { var btn2 = document.getElementById('manualSyncBtn'); if (btn2){ btn2.disabled=false; btn2.textContent='Manual Sync'; } } };
							window.hangarInitQueue = window.hangarInitQueue || [];
							window.hangarInitQueue.push(function(){ try{ var el = document.getElementById('syncDebugUrl'); if (el){ el.textContent = getServerUrl(); } polyfillApplyTileData(); }catch(e){} });
						})();
						</script>

			<!-- Timetable API Integration - NACH AeroDataBox API laden -->
			<script src="js/timetable-api-integration.js"></script>

			<!-- Debug-Script für API-Verfügbarkeit -->
			<script>
				// Debug-Funktion zur Überprüfung der API-Verfügbarkeit
				window.checkAPIs = function () {
					console.log("=== API VERFÜGBARKEITS-CHECK ===");
					console.log(
						"AeroDataBoxAPI:",
						typeof window.AeroDataBoxAPI !== "undefined"
							? "✅ Verfügbar"
							: "❌ Nicht verfügbar"
					);

					console.log(
						"FlightDataAPI:",
						typeof window.FlightDataAPI !== "undefined"
							? "✅ Verfügbar"
							: "❌ Nicht verfügbar"
					);

					return {
						aerodatabox: typeof window.AeroDataBoxAPI !== "undefined",
						aviationstack: typeof window.AviationstackAPI !== "undefined",
						facade: typeof window.FlightDataAPI !== "undefined",
					};
				};

				// Auto-Check nach dem Laden
				setTimeout(() => {
					console.log("🔍 Automatischer API-Check nach dem Laden:");
					window.checkAPIs();
				}, 1000);
			</script>


			<!-- Event-Handler für den "Info anzeigen"-Button -->
			<script>
				// Verwende zentrale Initialisierung statt separate DOMContentLoaded Events
				window.hangarInitQueue = window.hangarInitQueue || [];
				window.hangarInitQueue.push(function () {
					// Event-Handler für den Ordnerstruktur-Info-Button
					const showFolderInfoBtn =
						document.getElementById("showFolderInfoBtn");
					if (showFolderInfoBtn) {
						showFolderInfoBtn.addEventListener("click", function () {
							// Diese Funktion wird in folderManager.js definiert
							if (typeof window.folderManager !== "undefined") {
								window.folderManager.showFolderStructureInfo();
							} else {
								// Fallback, falls die Funktion nicht verfügbar ist
								alert(
									"Empfohlene Ordnerstruktur: HangarPlanner/Projekte/ für Projekte und HangarPlanner/Einstellungen/ für Einstellungen"
								);
							}
						});
					}

					// Initialisierung der UI, wenn Funktionen verfügbar sind
					if (typeof initializeUI === "function") {
						initializeUI();
					}

					if (typeof setupUIEventListeners === "function") {
						setupUIEventListeners();
					}
				});
			</script>

			<!-- Event-Handler für die neue Statusdarstellung -->
			<script>
				// Globale Funktion zum Aktualisieren des Statuslichts (für alle Kacheln)
				function updateStatusLight(select) {
					const cellId = select.id.split("-")[1];
					const statusValue = select.value;

					// Suche Status-Licht in primären ODER sekundären Kacheln
					let statusLight = document.querySelector(
						`.status-light[data-cell="${cellId}"]`
					);

					// Fallback: Suche in der nächsten Container-Hierarchie
					if (!statusLight) {
						const container = select.closest(".hangar-cell");
						if (container) {
							statusLight = container.querySelector(".status-light");
						}
					}

					if (statusLight) {
						// CSS-basierte Lösung: Nur data-status Attribut setzen
						statusLight.setAttribute("data-status", statusValue);
						statusLight.setAttribute("data-cell", cellId);

						// Legacy CSS-Klassen entfernen (für alte Browser)
						statusLight.classList.remove(
							"status-ready",
							"status-maintenance",
							"status-aog",
							"status-neutral"
						);
						// Neue CSS-Klasse hinzufügen (Fallback)
						statusLight.classList.add(`status-${statusValue}`);

						// console.log(`✅ Status-Licht für Kachel ${cellId} auf ${statusValue} gesetzt`);
					} else {
						console.warn(`❌ Status-Licht für Kachel ${cellId} nicht gefunden`);
					}
				}

				// Globale Funktion zum Aktualisieren ALLER Status-Lichter
				function updateAllStatusLights() {
					// console.log('🔄 Aktualisiere alle Status-Lichter...');
					const allStatusSelectors =
						document.querySelectorAll(".status-selector");
					let updated = 0;

					allStatusSelectors.forEach((select) => {
						if (select.value && select.value !== "neutral") {
							updateStatusLight(select);
							updated++;
						}
					});

					// console.log(`✅ ${updated} Status-Lichter aktualisiert`);
					return updated;
				}

				// NEUE FUNKTION: Aktualisiert Status-Lichter für alle Kacheln (auch leere)
				function updateAllStatusLightsForced() {
					console.log("🔄 Erzwinge Update aller Status-Lichter...");
					const allStatusSelectors =
						document.querySelectorAll(".status-selector");
					let updated = 0;

					allStatusSelectors.forEach((select) => {
						// Aktualisiere ALLE Status-Lichter, auch die mit "neutral" Wert
						updateStatusLight(select);
						updated++;
					});

					console.log(`✅ ${updated} Status-Lichter erzwungen aktualisiert`);
					return updated;
				}

				// Globale Funktion zum Aktualisieren eines spezifischen Status-Lichts nach Kachel-ID
				function updateStatusLightByCellId(cellId) {
					const statusSelect = document.getElementById(`status-${cellId}`);
					if (statusSelect) {
						updateStatusLight(statusSelect);
						return true;
					}
					return false;
				}

				// Verwende zentrale Initialisierung statt separate DOMContentLoaded Events
				window.hangarInitQueue = window.hangarInitQueue || [];

				// Mache Funktionen global verfügbar
				window.updateAllStatusLights = updateAllStatusLights;
				window.updateAllStatusLightsForced = updateAllStatusLightsForced;
				window.updateStatusLightByCellId = updateStatusLightByCellId;

				window.hangarInitQueue.push(function () {
					// Status-Dropdown-Handler für ALLE Kacheln (primäre UND sekundäre)
					function setupStatusHandlers() {
						document.querySelectorAll(".status-selector").forEach((select) => {
							// Prüfe ob Event-Listener bereits hinzugefügt wurde
							if (!select.hasAttribute("data-status-listener-added")) {
								// Initial Status setzen
								updateStatusLight(select);

								// Event-Listener für Änderungen
								select.addEventListener("change", function () {
									updateStatusLight(this);
								});

								// Markiere als verarbeitet
								select.setAttribute("data-status-listener-added", "true");
							}
						});
					}

					// Initial alle Status-Handler einrichten
					setupStatusHandlers();

					// Event-Listener für dynamisch erstellte sekundäre Kacheln
					document.addEventListener("secondaryTilesCreated", function (event) {
						// console.log('🎯 Sekundäre Kacheln erstellt, richte Status-Handler ein...');
						setTimeout(() => {
							setupStatusHandlers();
							// Erzwinge Update der Status-Lichter für sekundäre Kacheln
							updateAllStatusLightsForced();
						}, 100); // Kurze Verzögerung für DOM-Update
					});

					// Event-Listener für Daten-Updates (nach dem Laden von gespeicherten Daten)
					document.addEventListener("dataLoaded", function (event) {
						// console.log('📊 Daten geladen, aktualisiere alle Status-Lichter...');
						setTimeout(() => {
							updateAllStatusLightsForced(); // Erzwinge Update ALLER Lichter
						}, 200); // Verzögerung für DOM-Updates
					});
				});
			</script>

			<!-- Notizfelder in allen Kacheln auf Englisch ändern mit direktem DOM-Skript -->
			<script>
				// Verwende zentrale Initialisierung statt separate DOMContentLoaded Events
				window.hangarInitQueue = window.hangarInitQueue || [];
				window.hangarInitQueue.push(function () {
					// Alle Notizfelder auf Englisch umstellen
					document.querySelectorAll(".notes-textarea").forEach((textarea) => {
						if (
							textarea.getAttribute("placeholder") === "Notizen eingeben..." ||
							!textarea.getAttribute("placeholder")
						) {
							textarea.setAttribute("placeholder", "Enter notes...");
						}
					});

					// Status-Dropdowns Hintergrundfarbe forcieren
					document.querySelectorAll(".status-selector").forEach((select) => {
						select.style.backgroundColor = "#e6eaef";
					});
				});
			</script>

			<!-- Robustheitsskript für dynamisch erzeugte Elemente -->
			<script>
				// Zentrale Funktionen für UI-Updates
				function updateTextareasAndSelects() {
					// Alle Notizfelder auf Englisch umstellen
					document.querySelectorAll(".notes-textarea").forEach((textarea) => {
						if (
							textarea.getAttribute("placeholder") === "Notizen eingeben..." ||
							!textarea.getAttribute("placeholder")
						) {
							textarea.setAttribute("placeholder", "Enter notes...");
						}
					});

					// Status-Dropdowns Hintergrundfarbe forcieren
					document.querySelectorAll(".status-selector").forEach((select) => {
						select.style.backgroundColor = "#e6eaef";

						// Event-Listener für neue Status-Selektoren hinzufügen, falls noch nicht vorhanden
						if (!select.hasAttribute("data-listener-added")) {
							select.addEventListener("change", function () {
								updateStatusLight(this);
							});
							select.setAttribute("data-listener-added", "true");
							// Initial Status setzen
							updateStatusLight(select);
						}
					});
				}

				// Verwende zentrale Initialisierung
				window.hangarInitQueue = window.hangarInitQueue || [];
				window.hangarInitQueue.push(function () {
					// Sofort ausführen
					updateTextareasAndSelects();

					// Dann nochmal mit Verzögerungen
					setTimeout(updateTextareasAndSelects, 500);
					setTimeout(updateTextareasAndSelects, 1500);

					// Auch bei UI-Änderungen erneut ausführen
					document.addEventListener(
						"secondaryTilesCreated",
						updateTextareasAndSelects
					);
				});
			</script>

			<!-- Event-Handler für Aircraft ID Formatierung -->
			<script>
				// Zentrale Aircraft ID Formatierung
				function setupAircraftIdFormatting() {
					document
						.querySelectorAll('input[id^="aircraft-"]')
						.forEach((input) => {
							input.addEventListener("input", function (e) {
								formatAircraftId(e.target);
								// KORREKTUR: Aircraft ID Change Handler ENTFERNT vom input Event
								// API-Aufrufe sollen nur beim Verlassen des Feldes (blur) stattfinden
							});

							input.addEventListener("blur", function (e) {
								formatAircraftId(e.target);
								// KORREKTUR: Aircraft ID Change Handler NUR bei blur - API-Aufruf erst nach vollständiger Eingabe
								if (
									window.hangarEvents &&
									window.hangarEvents.handleAircraftIdChange
								) {
									window.hangarEvents.handleAircraftIdChange(
										e.target.id,
										e.target.value
									);
								}
							});
						});
				}

				// Formatierung: Erster Buchstabe + Bindestrich + Rest in Großbuchstaben
				function formatAircraftId(input) {
					let value = input.value.trim();
					if (value.length === 0) return;

					// Entferne alle Bindestriche und konvertiere zu Großbuchstaben
					let cleanValue = value.replace(/-/g, "").toUpperCase();

					if (cleanValue.length > 0) {
						// Erster Buchstabe + Bindestrich + Rest
						let formatted = cleanValue.charAt(0);
						if (cleanValue.length > 1) {
							formatted += "-" + cleanValue.substring(1);
						}

						input.value = formatted;
					}
				}
			</script>

			<!-- Event-Handler für Towing-Status Dropdowns -->
			<script>
				// Zentrale Towing-Status Verwaltung
				function setupTowStatusHandlers() {
					document
						.querySelectorAll(".tow-status-selector")
						.forEach((select) => {
							// Initial Status-Farbe setzen
							updateTowStatusStyles(select);

							// Event-Listener für Änderungen
							select.addEventListener("change", function () {
								updateTowStatusStyles(this);
							});
						});
				}

				// Funktion zum Aktualisieren der Towing-Status-Farben
				function updateTowStatusStyles(select) {
					// Nur Klassen steuern – keine Inline-Styles setzen (verhindert Überschreiben unserer CSS-Palette)
					select.classList.remove(
						"tow-neutral",
						"tow-initiated",
						"tow-ongoing",
						"tow-on-position"
					);
					const value = (select?.value || 'neutral').trim();
					select.classList.add(`tow-${value}`);
					// Sämtliche zuvor gesetzte Inline-Farben zurücksetzen, damit CSS greift
					select.style.backgroundColor = '';
					select.style.color = '';
					select.style.borderColor = '';
					select.style.borderLeftColor = '';
				}

				// Verwende zentrale Initialisierung
				window.hangarInitQueue = window.hangarInitQueue || [];
				window.hangarInitQueue.push(function () {
					// Initial ausführen
					setupTowStatusHandlers();

					// Aircraft ID Formatierung einrichten
					setupAircraftIdFormatting();

					// Auch bei UI-Updates ausführen
					document.addEventListener("secondaryTilesCreated", function () {
						setupTowStatusHandlers();
						setupAircraftIdFormatting();
					});

					// Mit Verzögerung nochmal ausführen, um dynamisch erstellte Elemente zu erfassen
					setTimeout(function () {
						setupTowStatusHandlers();
						setupAircraftIdFormatting();
					}, 500);
				});
			</script>

			<!-- Debug Script für Position-Klon-Problem -->
			<!-- OPTIMIERT: debug-position-clone.js entfernt -->

			<!-- Toast small utility -->
			<script src="js/toast.js"></script>

			<!-- Display Options Script -->
			<script src="js/display-options.js"></script>

			<!-- DEBUG: Uncomment for debugging Display Options -->
			<!-- <script src="js/debug/display-options-debug.js"></script> -->

			<!-- Zentrale Initialisierung - ersetzt alle separaten DOMContentLoaded Events -->
			<script>
				// Zentrale Initialisierungsqueue um Browser-Überlastung zu vermeiden
				window.hangarInitQueue = window.hangarInitQueue || [];

				// Einzelne zentrale Initialisierung statt 26 separate DOMContentLoaded Events
				document.addEventListener("DOMContentLoaded", function () {
					console.log("🚀 Starte zentrale Hangar-Initialisierung...");

					// Sequential execution statt parallel um Browser-Überlastung zu vermeiden
					let initIndex = 0;

					function executeNextInit() {
						if (initIndex < window.hangarInitQueue.length) {
							try {
								console.log(
									`📋 Führe Initialisierung ${initIndex + 1}/${
										window.hangarInitQueue.length
									} aus`
								);
								window.hangarInitQueue[initIndex]();
								initIndex++;
								// Kleine Verzögerung zwischen Initialisierungen um Browser zu entlasten
								setTimeout(executeNextInit, 10);
							} catch (error) {
								console.error(
									`❌ Fehler bei Initialisierung ${initIndex + 1}:`,
									error
								);
								initIndex++;
								setTimeout(executeNextInit, 10);
							}
						} else {
							console.log("✅ Zentrale Hangar-Initialisierung abgeschlossen");

							// FINAL: modeToggle Status korrigieren nach vollständiger Initialisierung
							setTimeout(() => {
								const modeToggle = document.getElementById("modeToggle");
								const body = document.body;
								if (modeToggle && body) {
									const isEditMode = body.classList.contains("edit-mode");
									modeToggle.checked = isEditMode;
									console.log(
										`🎛️ modeToggle Status korrigiert: ${
											isEditMode ? "Edit" : "View"
										}-Modus`
									);
								}
							}, 100);
						}
					}

					// Starte sequentielle Ausführung
					executeNextInit();
				});
            </script>

            <!-- Final late restore to override any late resets (theme + tiles) -->
            <script>
            (function(){
              function lateRestore(){
                try {
                  if (window.hangarData && typeof window.hangarData.loadFromLocalAutosave === 'function') {
                    window.hangarData.loadFromLocalAutosave();
                  }
                } catch(e){}
                try {
                  var t = (localStorage.getItem('hangar.theme')||'').toLowerCase();
                  var isDark = false;
                  if (t==='dark') isDark = true; else if (t==='light') isDark = false; else {
                    try {
                      var raw = localStorage.getItem('displayOptions');
                      if (raw) { var parsed = JSON.parse(raw); if (parsed && parsed.darkMode) isDark = true; }
                    } catch(e){}
                  }
                  document.documentElement.classList.toggle('dark-mode', !!isDark);
                  if (document.body) document.body.classList.toggle('dark-mode', !!isDark);
                  var toggle = document.getElementById('darkModeToggle');
                  if (toggle) toggle.checked = !!isDark;
                  if (window.displayOptions && window.displayOptions.current) {
                    window.displayOptions.current.darkMode = !!isDark;
                  }
                } catch(e){}
              }
              window.addEventListener('pageshow', function(){ setTimeout(lateRestore, 300); setTimeout(lateRestore, 1200); });
              document.addEventListener('DOMContentLoaded', function(){ setTimeout(lateRestore, 600); });
            })();
            </script>

            <!-- Change Log (Project submenu) -->
            <script>
            (function(){
              const KEY = 'hangar.changeLog.v1';
              const MAX_ENTRIES = 500;
              const FIELD_LABELS = {
                'aircraft': 'Aircraft ID',
                'arrival-time': 'Arrival',
                'departure-time': 'Departure',
                'position': 'Pos',
                'hangar-position': 'Hangar Position',
                'status': 'Status',
                'tow-status': 'Tow',
                'notes': 'Notes'
              };

              function parseFieldId(id){
                if (typeof id !== 'string') return null;
                const m = id.match(/^(aircraft|arrival-time|departure-time|position|hangar-position|notes|status|tow-status)-(\d+)$/);
                if (!m) return null;
                return { prefix: m[1], cellId: parseInt(m[2],10) };
              }

              function getUserName(){
                try {
                  const v = (localStorage.getItem('presence.displayName')||'').trim();
                  return v || 'Me';
                } catch(_) { return 'Me'; }
              }

              function getTileLabel(cellId){
                try {
                  const hangar = document.getElementById(`hangar-position-${cellId}`);
                  const reg = document.getElementById(`aircraft-${cellId}`);
                  const pos = (hangar && hangar.value || '').trim();
                  const ac = (reg && reg.value || '').trim();
                  if (pos && ac) return `${pos} • ${ac}`;
                  if (pos) return pos;
                  if (ac) return ac;
                } catch(_){}
                return `Tile ${cellId}`;
              }

              function load(){
                try { const raw = localStorage.getItem(KEY); return raw ? (JSON.parse(raw)||[]) : []; } catch(_) { return []; }
              }
              function save(arr){
                try { localStorage.setItem(KEY, JSON.stringify(Array.isArray(arr)?arr:[])); } catch(_){}
              }

              function formatTime(ts){
                try { return new Date(ts).toLocaleString(); } catch(_) { return String(ts); }
              }

              function navigateTo(fieldId, cellId){
                try {
                  // Ensure Planner tab
                  const tab = document.getElementById('tab-planner');
                  if (tab) tab.click();
                  // Locate tile and field
                  let tile = null;
                  if (cellId >= 101) { tile = document.querySelector(`#secondaryHangarGrid .hangar-cell:nth-child(${cellId-100})`); }
                  else { tile = document.querySelector(`#hangarGrid .hangar-cell:nth-child(${cellId})`); }
                  if (tile) {
                    tile.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  }
                  const field = document.getElementById(fieldId);
                  if (field) {
                    try { field.focus({ preventScroll: true }); } catch(_){}
                    const old = field.style.outline;
                    field.style.outline = '2px solid #ff7043';
                    setTimeout(()=>{ field.style.outline = old || ''; }, 1500);
                  }
                } catch(e) {}
              }

              // New helpers for server-backed rendering (Option A)
              function canReadFromServer(){
                try {
                  if (window.sharingManager && typeof window.sharingManager.syncMode === 'string'){
                    return window.sharingManager.syncMode === 'sync' || window.sharingManager.syncMode === 'master';
                  }
                  const readToggle = document.getElementById('readDataToggle');
                  return !!(readToggle && readToggle.checked);
                } catch(_) { return false; }
              }
              function getServerUrl(){
                try {
                  let url = (window.serverSync && typeof window.serverSync.getServerUrl==='function' && window.serverSync.getServerUrl()) ||
                            (window.serverSync && window.serverSync.serverSyncUrl) ||
                            (window.location.origin + '/sync/data.php');
                  if (typeof url !== 'string' || !url.length) url = window.location.origin + '/sync/data.php';
                  return url;
                } catch(_) { return (window.location.origin + '/sync/data.php'); }
              }
              async function fetchServerJson(){
                try {
                  const url = getServerUrl();
                  const res = await fetch(url, { method: 'GET', headers: { 'Accept':'application/json' }, signal: AbortSignal.timeout(5000) });
                  if (!res.ok && res.status !== 404) return null;
                  if (res.status === 404) return { primaryTiles: [], secondaryTiles: [], metadata: {} };
                  const text = await res.text();
                  try { return JSON.parse(text); } catch(_) { return null; }
                } catch(_) { return null; }
              }
              // Temporary suppression of server entries (UX for Clear)
              function serverSuppressed(){ try { const t = parseInt(sessionStorage.getItem('changeLog.suppressServerUntil')||'0',10); return Date.now() < t; } catch(_) { return false; } }
              function suppressServer(ms){ try { sessionStorage.setItem('changeLog.suppressServerUntil', String(Date.now()+ms)); } catch(_){} }
              function clearServerSuppression(){ try { sessionStorage.removeItem('changeLog.suppressServerUntil'); } catch(_){} }
              function chooseFieldForTile(tile){
                const id = parseInt(tile?.tileId || 0, 10);
                let prefix = 'aircraft';
                let fieldId = `aircraft-${id}`;
                let value = (tile?.aircraftId || '').toString();
                if (!value){
                  if (tile?.hangarPosition){ prefix='hangar-position'; fieldId=`hangar-position-${id}`; value=tile.hangarPosition; }
                  else if (tile?.position){ prefix='position'; fieldId=`position-${id}`; value=tile.position; }
                  else if (tile?.notes){ prefix='notes'; fieldId=`notes-${id}`; value=tile.notes; }
                  else if (tile?.status){ prefix='status'; fieldId=`status-${id}`; value=tile.status; }
                  else if (tile?.towStatus){ prefix='tow-status'; fieldId=`tow-status-${id}`; value=tile.towStatus; }
                }
                return { prefix, fieldId, value };
              }
              function buildServerEntries(data, myName){
                try {
                  const tiles = [];
                  if (Array.isArray(data?.primaryTiles)) tiles.push(...data.primaryTiles);
                  if (Array.isArray(data?.secondaryTiles)) tiles.push(...data.secondaryTiles);
                  const entries = [];
                  tiles.forEach(t => {
                    const id = parseInt(t?.tileId || 0, 10);
                    const user = (t?.updatedBy || '').toString().trim();
                    const ts = Date.parse(t?.updatedAt || '') || 0;
                    if (!id || !user || !ts) return;
                    if (myName && user === myName) return; // only other users
                    const pick = chooseFieldForTile(t);
                    entries.push({ ts, user, fieldId: pick.fieldId, prefix: pick.prefix, cellId: id, value: pick.value });
                  });
                  // Sort newest first, cap length for UI sanity
                  entries.sort((a,b)=> b.ts - a.ts);
                  return entries.slice(0, 200);
                } catch(_) { return []; }
              }
              function renderEntries(entryList){
                const list = document.getElementById('changeLogList');
                if (!list) return;
                const suppress = serverSuppressed() && canReadFromServer();
                const items = (entryList||[]).map((e, idx) => {
                  const when = formatTime(e.ts);
                  const desc = `${e.user} • ${FIELD_LABELS[e.prefix]||e.prefix} @ ${getTileLabel(e.cellId)}`;
                  const val = (e.value||'').toString();
                  const prettyVal = val.length > 60 ? (val.slice(0,60)+'…') : val;
                  const id = `goTo_${idx}_${e.cellId}_${e.prefix}`;
                  return `
                    <div class=\"flex items-start justify-between gap-2 py-1 border-b\">
                      <div class=\"text-xs\">
                        <div class=\"font-semibold\" style=\"color:#475569\">${when}</div>
                        <div class=\"\" style=\"color:#64748b\">${desc}</div>
                        ${prettyVal ? `<div class=\"\" style=\"color:#94a3b8\">→ ${prettyVal}</div>`:''}
                      </div>
                      <div>
                        <button id=\"${id}\" class=\"sidebar-btn sidebar-btn-primary\" style=\"min-height:28px; font-size:12px; padding:0 10px;\" title=\"Go to field\">Go</button>
                      </div>
                    </div>`;
                });
                const notice = suppress ? `<div class=\"text-xs\" style=\"margin-bottom:6px; color:#64748b;\">Server updates hidden. <button id=\"changeLogShowServerBtn\" class=\"sidebar-btn sidebar-btn-secondary\" style=\"min-height:22px; font-size:11px; padding:0 8px; margin-left:6px;\">Show</button></div>` : '';
                list.innerHTML = notice + items.join('');
                // Wire buttons
                (entryList||[]).forEach((e, idx) => {
                  const id = `goTo_${idx}_${e.cellId}_${e.prefix}`;
                  const btn = document.getElementById(id);
                  if (btn) btn.addEventListener('click', (ev)=>{ ev.preventDefault(); navigateTo(e.fieldId, e.cellId); });
                });
                // Wire show server button if present
                if (suppress){
                  const showBtn = document.getElementById('changeLogShowServerBtn');
                  if (showBtn) showBtn.addEventListener('click', (e)=>{ e.preventDefault(); clearServerSuppression(); setTimeout(()=>{ try { ChangeLog.render(); } catch(_){} }, 0); });
                }
              }

              async function render(){
                try {
                  const myName = getUserName();
                  if (canReadFromServer() && !serverSuppressed()){
                    const data = await fetchServerJson();
                    if (data){
                      const serverEntries = buildServerEntries(data, myName);
                      if (serverEntries && serverEntries.length){ renderEntries(serverEntries); return; }
                    }
                  }
                  // Fallback: local-only entries from this device (others-only)
                  const entries = load();
                  const onlyOthers = entries.filter(e => (e && typeof e.user === 'string') ? (e.user.trim() !== myName) : true);
                  // keep newest first
                  onlyOthers.sort((a,b)=> (b.ts||0) - (a.ts||0));
                  renderEntries(onlyOthers);
                } catch(_){}
              }

              const ChangeLog = {
                add(fieldId, value){
                  try {
                    // Guard: skip if server/applying data
                    if (window.isApplyingServerData || window.isLoadingServerData) return;
                    const parsed = parseFieldId(fieldId);
                    if (!parsed) return;
                    const user = getUserName();
                    const entry = { ts: Date.now(), user, fieldId, prefix: parsed.prefix, cellId: parsed.cellId, value };
                    const arr = load();
                    arr.push(entry);
                    if (arr.length > MAX_ENTRIES) arr.splice(0, arr.length-MAX_ENTRIES);
                    save(arr);
                    render();
                  } catch(_){}
                },
                render,
                clear(){ try { save([]); if (canReadFromServer()) { suppressServer(5*60*1000); } } finally { render(); } },
              };

              function attachListeners(){
                const root1 = document.getElementById('hangarGrid');
                const root2 = document.getElementById('secondaryHangarGrid');
                const handler = (e)=>{
                  const t = e.target;
                  if (!t || !t.id) return;
                  const info = parseFieldId(t.id);
                  if (!info) return;
                  // Skip disabled (read-only) interactions
                  if (document.body.classList.contains('read-only')) return;
                  // Value source normalization for datetime fields
                  let v = (t.value || '').toString();
                  if ((info.prefix === 'arrival-time' || info.prefix === 'departure-time') && t.dataset && t.dataset.iso) {
                    v = t.dataset.iso;
                  }
                  ChangeLog.add(t.id, v);
                };
                if (root1 && !root1.__logWired){ root1.addEventListener('change', handler); root1.__logWired = true; }
                if (root2 && !root2.__logWired){ root2.addEventListener('change', handler); root2.__logWired = true; }
              }

              function wireClear(){
                const btn = document.getElementById('changeLogClearBtn');
                if (btn && !btn.__wired){ btn.addEventListener('click', (e)=>{ e.preventDefault(); ChangeLog.clear(); }); btn.__wired=true; }
              }

              // Central init
              window.hangarInitQueue = window.hangarInitQueue || [];
              window.hangarInitQueue.push(function(){ try { attachListeners(); wireClear(); ChangeLog.render(); } catch(_){} });
              // Also refresh when server data loads or mode changes
              try { document.addEventListener('serverDataLoaded', ()=>{ try { ChangeLog.render(); } catch(_){} }); } catch(_e){}
              try { document.addEventListener('syncModeChanged', ()=>{ try { ChangeLog.render(); } catch(_){} }); } catch(_e){}
              // Expose for debugging
              window.ChangeLog = ChangeLog;
            })();
            </script>

            <!-- Zeit-Update Script für Info Widget -->
            <script>
				// Zeit-Update Funktionen für Info Widget
				function updateTimeDisplay() {
					const now = new Date();

					// Lokale Zeit formatieren (ohne Sekunden)
					const localTime = now.toLocaleTimeString("de-DE", {
						hour: "2-digit",
						minute: "2-digit",
					});

					// UTC Zeit formatieren (ohne Sekunden)
					const utcTime = now.toUTCString().split(" ")[4].substring(0, 5); // Extrahiere HH:MM

					// DOM Elemente aktualisieren
					const localTimeElement = document.getElementById("local-time");
					const utcTimeElement = document.getElementById("utc-time");

					if (localTimeElement) {
						localTimeElement.textContent = localTime;
					}

					if (utcTimeElement) {
						utcTimeElement.textContent = utcTime;
					}
				}

// DEAKTIVIERT: Master/Read-only Status Update Funktion
				// Diese Funktion wurde durch SharingManager.updateAllSyncDisplays() ersetzt
				function updateSyncModeDisplay() {
					// ⚠️ OBSOLET: Diese Funktion wird nicht mehr verwendet
					// Status-Updates erfolgen jetzt zentral über SharingManager
					console.warn(
						"⚠️ updateSyncModeDisplay() ist obsolet - verwende SharingManager.updateAllSyncDisplays()"
					);
					return;
				}

				// Zeit-Update zur zentralen Initialisierung hinzufügen
				window.hangarInitQueue = window.hangarInitQueue || [];
				window.hangarInitQueue.push(function () {
					// Sofort einmal ausführen
					updateTimeDisplay();
					// ENTFERNT: updateSyncModeDisplay() - wird jetzt zentral von SharingManager verwaltet

					// Dann jede Minute aktualisieren (weniger häufig für Zeit ohne Sekunden)
					setInterval(updateTimeDisplay, 60000);

					// ENTFERNT: Event-Listener für Sync-Toggle
					// Toggle-Events werden jetzt direkt vom SharingManager verwaltet
					// const liveSyncToggle = document.getElementById("liveSyncToggle");
					// if (liveSyncToggle) {
					//     liveSyncToggle.addEventListener("change", updateSyncModeDisplay);
					// }

					console.log(
						"⏰ Zeit-Anzeige im Info Widget initialisiert (Sync-Status wird von SharingManager verwaltet)"
					);
				});
			</script>
		</div>

		<!-- Flight Data Status Display -->
		<!-- Toast container -->
		<div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

		<!-- Ensure theme/toggle stay in sync even on BFCache back-navigation -->
        <script>
            (function(){
                function syncThemeAndToggle(){
                    try {
                        var t = (localStorage.getItem('hangar.theme')||'').toLowerCase();
                        var isDark = false;
                        if (t === 'dark') isDark = true; else if (t === 'light') isDark = false; else {
                            try {
                                var raw = localStorage.getItem('displayOptions');
                                if (raw) {
                                    var parsed = JSON.parse(raw);
                                    if (parsed && parsed.darkMode) isDark = true;
                                }
                            } catch(e) {}
                        }
                        // Apply to DOM
                        document.documentElement.classList.toggle('dark-mode', isDark);
                        if (document.body) document.body.classList.toggle('dark-mode', isDark);
                        // Reflect in toggle if present
                        var toggle = document.getElementById('darkModeToggle');
                        if (toggle) toggle.checked = isDark;
                        // Also align displayOptions state if available (keeps UI consistent after BFCache)
                        try {
                            if (window.displayOptions && window.displayOptions.current) {
                                window.displayOptions.current.darkMode = !!isDark;
                            }
                        } catch (e) { /* noop */ }
                    } catch (e) { /* noop */ }
                }
                // Run on pageshow (covers BFCache), and once after DOM ready as safety
                window.addEventListener('pageshow', syncThemeAndToggle);
                document.addEventListener('DOMContentLoaded', function(){ setTimeout(syncThemeAndToggle, 0); });
            })();
        </script>

		<!-- Persist Export submenu selections across sessions -->
		<script>
			(function () {
				const KEY = "hangarPlanner.exportSettings.v1";

				function readChecked(id) {
					const el = document.getElementById(id);
					return !!(el && el.checked);
				}

				function writeChecked(id, value) {
					const el = document.getElementById(id);
					if (el) el.checked = !!value;
				}

				function loadSettings() {
					try {
						const raw = localStorage.getItem(KEY);
						if (!raw) return null;
						const obj = JSON.parse(raw);
						return obj && typeof obj === "object" ? obj : null;
					} catch (e) {
						console.warn("Export settings parse failed", e);
						return null;
					}
				}

				function saveSettings(settings) {
					try {
						localStorage.setItem(KEY, JSON.stringify(settings));
					} catch (e) {
						console.warn("Export settings save failed", e);
					}
				}

				function collectSettings() {
					return {
						landscapeMode: readChecked("landscapeMode"),
						exportAircraft: readChecked("exportAircraft"),
						exportArrival: readChecked("exportArrival"),
						exportDeparture: readChecked("exportDeparture"),
						exportPosition: readChecked("exportPosition"),
						exportHangarPosition: readChecked("exportHangarPosition"),
						exportStatus: readChecked("exportStatus"),
						exportTowStatus: readChecked("exportTowStatus"),
						exportNotes: readChecked("exportNotes"),
					};
				}

				function applySettings(s) {
					if (!s) return;
					writeChecked("landscapeMode", s.landscapeMode);
					writeChecked("exportAircraft", s.exportAircraft);
					writeChecked("exportArrival", s.exportArrival);
					writeChecked("exportDeparture", s.exportDeparture);
					writeChecked("exportPosition", s.exportPosition);
					writeChecked("exportHangarPosition", s.exportHangarPosition);
					writeChecked("exportStatus", s.exportStatus);
					writeChecked("exportTowStatus", s.exportTowStatus);
					writeChecked("exportNotes", s.exportNotes);
				}

				function attachChangeHandlers() {
					const ids = [
						"landscapeMode",
						"exportAircraft",
						"exportArrival",
						"exportDeparture",
						"exportPosition",
						"exportHangarPosition",
						"exportStatus",
						"exportTowStatus",
						"exportNotes",
					];
					ids.forEach((id) => {
						const el = document.getElementById(id);
						if (el && !el.dataset.exportSettingsListener) {
							el.addEventListener("change", () => saveSettings(collectSettings()));
							el.dataset.exportSettingsListener = "true";
						}
					});
				}

				// Use centralized initialization queue
				window.hangarInitQueue = window.hangarInitQueue || [];
				window.hangarInitQueue.push(function () {
					const saved = loadSettings();
					if (saved) {
						applySettings(saved);
					}
					attachChangeHandlers();
				});

				// Optional: expose helpers for debugging
				window.ExportSettings = {
					load: loadSettings,
					save: saveSettings,
					collect: collectSettings,
					apply: applySettings,
				};
			})();
		</script>

		<script src="js/flight-data-status.js"></script>

            <!-- Minimal fallback: ensure Display Settings defaults and handlers work even if main init didn't run -->
            <script>
            (function(){
                function log(){ try { console.log.apply(console, arguments);} catch(e){} }

                function getPersistedDisplay(){
                    try {
                        if (window.displayOptions && window.displayOptions.current && Object.keys(window.displayOptions.current).length){
                            return { ...window.displayOptions.current };
                        }
                    } catch(e){}
                    try {
                        const raw = localStorage.getItem('displayOptions');
                        if (!raw) return null;
                        const parsed = JSON.parse(raw);
                        if (parsed && typeof parsed === 'object') return parsed;
                    } catch(e){}
                    return null;
                }

                function showPrimaryTiles(count){
                    const grid = document.getElementById('hangarGrid');
                    if (!grid) return;
                    const cells = grid.querySelectorAll('.hangar-cell');
                    cells.forEach((cell, idx) => {
                        if (idx < count){
                            cell.classList.remove('hidden');
                            cell.style.display = '';
                            cell.style.visibility = 'visible';
                        } else {
                            cell.classList.add('hidden');
                            cell.style.display = 'none';
                            cell.style.visibility = 'hidden';
                        }
                    });
                }

                function ensureSecondaryTiles(count, layout){
                    const secGrid = document.getElementById('secondaryHangarGrid');
                    if (!secGrid) return;
                    const current = secGrid.querySelectorAll('.hangar-cell').length;
                    if (typeof window.updateSecondaryTiles === 'function'){
                        window.updateSecondaryTiles(count, layout || 4);
                        return;
                    }
                    if (window.hangarUI && typeof window.hangarUI.updateSecondaryTiles === 'function'){
                        window.hangarUI.updateSecondaryTiles(count, layout || 4);
                        return;
                    }
                    // Manual minimal clone fallback
                    if (current < count){
                        const template = document.querySelector('#hangarGrid .hangar-cell');
                        if (!template) return;
                        for (let i=current; i<count; i++){
                            const cellId = 101 + i;
                            const clone = template.cloneNode(true);
                            if (typeof window.updateCellAttributes === 'function'){
                                window.updateCellAttributes(clone, cellId);
                            }
                            clone.querySelectorAll('input, textarea, select').forEach(el => {
                                if (el.tagName === 'SELECT') el.selectedIndex = 0;
                                else el.value = '';
                            });
                            secGrid.appendChild(clone);
                        }
                    }
                    // Hide extras if more than count exist
                    const cells = secGrid.querySelectorAll('.hangar-cell');
                    cells.forEach((cell, idx) => {
                        if (idx < count){
                            cell.classList.remove('hidden');
                            cell.style.display = '';
                            cell.style.visibility = 'visible';
                        } else {
                            cell.classList.add('hidden');
                            cell.style.display = 'none';
                            cell.style.visibility = 'hidden';
                        }
                    });
                }

                function applyLayoutColumns(layout){
                    const updateClasses = (el) => {
                        if (!el) return;
                        const cls = el.classList;
                        for (let i = 1; i <= 12; i++) { cls.remove(`grid-cols-${i}`); }
                        cls.add(`grid-cols-${layout}`);
                    };
                    const apply = (el) => {
                        if (!el) return;
                        el.style.display = 'grid';
                        try {
                            el.style.setProperty('grid-template-columns', `repeat(${layout}, minmax(345px, 1fr))`, 'important');
                        } catch (e) {
                            el.style.gridTemplateColumns = `repeat(${layout}, minmax(345px, 1fr))`;
                        }
                        updateClasses(el);
                    };
                    apply(document.getElementById('hangarGrid'));
                    apply(document.getElementById('secondaryHangarGrid'));
                    try { console.log(`📐 Layout set to ${layout} columns`); } catch(e){}
                }

                function wireControls(){
                    const darkToggle = document.getElementById('darkModeToggle');
                    if (darkToggle && !darkToggle.__wired){
                        darkToggle.addEventListener('change', function(){
                            if (this.checked){
                                document.body.classList.add('dark-mode');
                                document.documentElement.classList.add('dark-mode');
                                try { localStorage.setItem('hangar.theme','dark'); } catch(e){}
                            } else {
                                document.body.classList.remove('dark-mode');
                                document.documentElement.classList.remove('dark-mode');
                                try { localStorage.setItem('hangar.theme','light'); } catch(e){}
                            }
                        });
                        darkToggle.__wired = true;
                    }

                    const viewToggle = document.getElementById('viewModeToggle');
                    if (viewToggle && !viewToggle.__wired){
                        viewToggle.addEventListener('change', function(){
                            if (this.checked){
                                document.body.classList.add('table-view');
                                document.body.classList.remove('tile-view');
                            } else {
                                document.body.classList.add('tile-view');
                                document.body.classList.remove('table-view');
                            }
                        });
                        viewToggle.__wired = true;
                    }

                    // New: Weather & Time widget toggles (fallback wiring)
                    const weatherToggle = document.getElementById('weatherWidgetToggle');
                    if (weatherToggle && !weatherToggle.__wired){
                        // if persisted exists, sync the checkbox before applying
                        const persisted = getPersistedDisplay();
                        if (persisted && typeof persisted.showWeatherWidget !== 'undefined'){
                            weatherToggle.checked = !!persisted.showWeatherWidget;
                        }
                        const applyWeather = function(){
                            const show = !!weatherToggle.checked;
                            document.body.classList.toggle('hide-weather-widget', !show);
                            var el = document.getElementById('weather-widget');
                            if (el){
                                el.classList.toggle('hidden', !show);
                                el.style.display = show ? '' : 'none';
                                if (show) { el.removeAttribute('hidden'); } else { el.setAttribute('hidden',''); }
                            }
                        };
                        // initial apply
                        applyWeather();
                        weatherToggle.addEventListener('change', applyWeather);
                        weatherToggle.addEventListener('input', applyWeather);
                        weatherToggle.__wired = true;
                    }

                    const timeToggle = document.getElementById('timeWidgetToggle');
                    if (timeToggle && !timeToggle.__wired){
                        const persisted = getPersistedDisplay();
                        if (persisted && typeof persisted.showTimeWidget !== 'undefined'){
                            timeToggle.checked = !!persisted.showTimeWidget;
                        }
                        const applyTime = function(){
                            const show = !!timeToggle.checked;
                            document.body.classList.toggle('hide-time-widget', !show);
                            var el = document.getElementById('time-widget');
                            if (el){
                                el.classList.toggle('hidden', !show);
                                el.style.display = show ? '' : 'none';
                                if (show) { el.removeAttribute('hidden'); } else { el.setAttribute('hidden',''); }
                            }
                        };
                        applyTime();
                        timeToggle.addEventListener('change', applyTime);
                        timeToggle.addEventListener('input', applyTime);
                        timeToggle.__wired = true;
                    }

                    const tilesInput = document.getElementById('tilesCount');
                    if (tilesInput && !tilesInput.__wired){
                        tilesInput.addEventListener('change', function(){
                            const v = parseInt(this.value) || 8;
                            showPrimaryTiles(v);
                        });
                        tilesInput.__wired = true;
                    }

                    const secTilesInput = document.getElementById('secondaryTilesCount');
                    if (secTilesInput && !secTilesInput.__wired){
                        secTilesInput.addEventListener('change', function(){
                            const v = parseInt(this.value) || 4;
                            ensureSecondaryTiles(v, parseInt(document.getElementById('layoutType')?.value||'4'));
                        });
                        secTilesInput.__wired = true;
                    }

                    const layoutSelect = document.getElementById('layoutType');
                    if (layoutSelect && !layoutSelect.__wired){
                        layoutSelect.addEventListener('change', function(){
                            const v = parseInt(this.value) || 4;
                            applyLayoutColumns(v);
                            // reflow secondary grid to match layout
                            const secCnt = parseInt(document.getElementById('secondaryTilesCount')?.value||'4');
                            ensureSecondaryTiles(secCnt, v);
                        });
                        layoutSelect.__wired = true;
                    }
                }

                function fallbackInit(){
                    const persisted = getPersistedDisplay();
                    let primary = 8, secondary = 4, layout = 4, tableView = false;
                    if (persisted){
                        primary = parseInt(persisted.tilesCount) || 8;
                        secondary = parseInt(persisted.secondaryTilesCount) || 4;
                        layout = parseInt(persisted.layout) || 4;
                        tableView = !!persisted.viewMode;
                    }
                    const tilesInput = document.getElementById('tilesCount');
                    if (tilesInput) tilesInput.value = primary;
                    const secTilesInput = document.getElementById('secondaryTilesCount');
                    if (secTilesInput) secTilesInput.value = secondary;
                    const layoutSelect = document.getElementById('layoutType');
                    if (layoutSelect) layoutSelect.value = String(layout);

                    // apply visuals using persisted or defaults
                    showPrimaryTiles(primary);
                    ensureSecondaryTiles(secondary, layout);
                    applyLayoutColumns(layout);

                    // view mode from persisted
                    if (tableView){
                        document.body.classList.add('table-view');
                        document.body.classList.remove('tile-view');
                    } else {
                        document.body.classList.add('tile-view');
                        document.body.classList.remove('table-view');
                    }
                }

                // Run after DOM is ready (and also as a setTimeout safety)
                document.addEventListener('DOMContentLoaded', function(){
                    try { fallbackInit(); wireControls(); log('✅ Fallback display init applied'); } catch(e){ log('Fallback init error', e); }
                });
                setTimeout(function(){ try { fallbackInit(); wireControls(); } catch(e){} }, 800);
                // Ensure settings are re-applied when navigating back via bfcache
                window.addEventListener('pageshow', function(){
                    setTimeout(function(){ try { fallbackInit(); } catch(e){} }, 120);
                });
            })();
            </script>

            <!-- Tabs wiring -->
            <script>
            (function(){
              function saveTab(tab){ try { localStorage.setItem('hangar.activeTab', tab); } catch(e){} }
              function loadTab(){ try { return localStorage.getItem('hangar.activeTab') || 'planner'; } catch(e){ return 'planner'; } }
              function getOrder(){ return ['planner','timetable','database']; }

              function setActiveTab(tab){
                var panels = {
                  planner: document.getElementById('panel-planner'),
                  timetable: document.getElementById('panel-timetable'),
                  database: document.getElementById('panel-database')
                };
					var buttons = document.querySelectorAll('#topTabs .tab-btn[role="tab"]');
                // Toggle buttons (ARIA)
                buttons.forEach(function(btn){
                  var isActive = btn.getAttribute('data-tab') === tab;
                  btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
                });
                // Toggle panels
                Object.keys(panels).forEach(function(k){
                  if (!panels[k]) return;
                  var active = (k === tab);
                  panels[k].classList.toggle('hidden', !active);
                  panels[k].setAttribute('aria-hidden', active ? 'false' : 'true');
                });
                saveTab(tab);
                try {
                  if (tab === 'planner' && window.displayOptions && typeof window.displayOptions.updateUI === 'function'){
                    window.displayOptions.updateUI();
                  }
                  if (tab === 'timetable') {
                    try {
                      var f = document.getElementById('timetableFrame');
                      if (f) {
                        // Always reset to the correct subpage to avoid accidental self-nav
                        f.setAttribute('src', 'timetable.html');
                      }
                    } catch(_e){}
                  }
                  if (tab === 'database') {
                    try {
                      var g = document.getElementById('databaseFrame');
                      if (g) {
                        // Always reset to the correct subpage to avoid accidental self-nav
                        g.setAttribute('src', 'fleet-database.html');
                      }
                    } catch(_e){}
                  }
                } catch(e){}
              }

              function cycleTab(dir, focus){
                var order = getOrder();
                var curr = loadTab();
                var idx = order.indexOf(curr);
                if (idx < 0) idx = 0;
                var next = order[(idx + dir + order.length) % order.length];
                setActiveTab(next);
                if (focus !== false){
                  var btn = document.querySelector('#topTabs .tab-btn[data-tab="'+next+'"][role="tab"]');
                  if (btn) btn.focus();
                }
              }

              function isTypingTarget(el){
                if (!el) return false;
                var tag = el.tagName;
                return el.isContentEditable || tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';
              }

              function wireTabButtons(){
                var container = document.getElementById('topTabs');
                if (!container) return;
                var buttons = container.querySelectorAll('.tab-btn[role="tab"]');
                buttons.forEach(function(btn){
                  if (btn.__wired) return;
                  btn.addEventListener('click', function(){ setActiveTab(btn.getAttribute('data-tab')); });
                  // Arrow key navigation when a tab has focus
                  btn.addEventListener('keydown', function(e){
                    if (e.key === 'ArrowRight'){ e.preventDefault(); cycleTab(1); }
                    else if (e.key === 'ArrowLeft'){ e.preventDefault(); cycleTab(-1); }
                  });
                  btn.__wired = true;
                });
              }

              // Global keyboard shortcuts: Alt+1/2/3 and Alt+ArrowLeft/Right
              document.addEventListener('keydown', function(e){
                if (isTypingTarget(e.target)) return;
                if (e.altKey && !e.ctrlKey && !e.metaKey){
                  if (e.code === 'Digit1' || e.key === '1'){ e.preventDefault(); setActiveTab('planner'); return; }
                  if (e.code === 'Digit2' || e.key === '2'){ e.preventDefault(); setActiveTab('timetable'); return; }
                  if (e.code === 'Digit3' || e.key === '3'){ e.preventDefault(); setActiveTab('database'); return; }
                  if (e.code === 'ArrowRight'){ e.preventDefault(); cycleTab(1, false); return; }
                  if (e.code === 'ArrowLeft'){ e.preventDefault(); cycleTab(-1, false); return; }
                }
              });

              document.addEventListener('DOMContentLoaded', function(){
                try { wireTabButtons(); setActiveTab(loadTab()); } catch(e){}
              });
              window.addEventListener('pageshow', function(){
                try { setActiveTab(loadTab()); } catch(e){}
              });
            })();
            </script>

            <!-- Broadcast theme to iframes on changes and on load -->
            <script>
            (function(){
              function computeDark(){
                try {
                  var t = (localStorage.getItem('hangar.theme')||'').toLowerCase();
                  if (t === 'dark') return true; if (t === 'light') return false;
                  var raw = localStorage.getItem('displayOptions');
                  if (raw) { var parsed = JSON.parse(raw); if (parsed && parsed.darkMode) return true; }
                } catch(e){}
                var toggle = document.getElementById('darkModeToggle');
                if (toggle) return !!toggle.checked;
                return document.documentElement.classList.contains('dark-mode') || document.body.classList.contains('dark-mode');
              }
              function send(){
                var msg = { type: 'theme', dark: !!computeDark() };
                try { var f = document.getElementById('timetableFrame'); if (f && f.contentWindow) f.contentWindow.postMessage(msg, '*'); } catch(e){}
                try { var g = document.getElementById('databaseFrame'); if (g && g.contentWindow) g.contentWindow.postMessage(msg, '*'); } catch(e){}
              }
              document.addEventListener('DOMContentLoaded', function(){
                try { var t = document.getElementById('darkModeToggle'); if (t) t.addEventListener('change', send); } catch(e){}
                setTimeout(send, 250);
              });
              window.addEventListener('pageshow', function(){ setTimeout(send, 0); });
              window.addEventListener('load', function(){ setTimeout(send, 0); });
            })();
            </script>
	</body>
</html>
