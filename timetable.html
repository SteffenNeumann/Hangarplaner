<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timetable - HangarPlanner</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

    <!-- Early apply saved dark mode to avoid flicker and ensure persistence on subpages -->
    <script>
      (function(){
        try {
          var isDark = false;
          try { var t = (localStorage.getItem('hangar.theme')||'').toLowerCase(); if (t==='dark') isDark = true; if (t==='light') isDark = false; } catch(e) {}
          if (!isDark) {
            var raw = localStorage.getItem('displayOptions');
            if (raw) {
              var parsed = JSON.parse(raw);
              if (parsed && parsed.darkMode) { isDark = true; }
            }
          }
          if (isDark) {
            document.documentElement.classList.add('dark-mode');
            var applyBody = function(){ if (document.body) document.body.classList.add('dark-mode'); };
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', applyBody);
            } else {
              applyBody();
            }
          }
        } catch (e) {}
      })();
    </script>

    <!-- Bestehende CSS-Dateien (wie Fleet Database) -->
    <link rel="stylesheet" href="css/hangarplanner-ui.css" />
    <link rel="stylesheet" href="css/info-widget.css" />
    <link rel="stylesheet" href="css/weather-widget.css" />
    <link rel="stylesheet" href="css/userinfo-widget.css" />
    <link rel="stylesheet" href="css/dark-mode-zoom.css" />
    <link rel="stylesheet" href="css/fleet-database.css" />

    <!-- Tailwind Konfiguration (wie Fleet Database) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Inter", "ui-sans-serif"] },
            colors: {
              "industrial-dark": "#2d3748",
              "industrial-medium": "#4a5568",
              "industrial-light": "#718096",
              "industrial-accent": "#ff7043",
            },
          },
        },
      };
    </script>

    <!-- Compact button overrides for small screens -->
    <style>
      @media (max-width: 768px) {
        #showAirportFlightsBtn {
          padding: 6px 10px !important;
          font-size: 0.875rem !important;
          line-height: 1.25rem !important;
        }
      }
    </style>
    <script>
      // Apply saved dark mode on subpage load
      document.addEventListener('DOMContentLoaded', function(){
        try {
          const raw = localStorage.getItem('displayOptions');
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && parsed.darkMode) {
              document.body.classList.add('dark-mode');
            }
          }
        } catch (e) {}
      });
      // Re-assert theme on BFCache return
      (function(){
        function syncTheme(){
          try {
            var t = (localStorage.getItem('hangar.theme')||'').toLowerCase();
            var isDark = false;
            if (t === 'dark') isDark = true; else if (t === 'light') isDark = false; else {
              try {
                var raw = localStorage.getItem('displayOptions');
                if (raw) { var parsed = JSON.parse(raw); if (parsed && parsed.darkMode) isDark = true; }
              } catch(e){}
            }
            document.documentElement.classList.toggle('dark-mode', isDark);
            if (document.body) document.body.classList.toggle('dark-mode', isDark);
          } catch(e){}
        }
        window.addEventListener('pageshow', syncTheme);
      })();
    </script>
  </head>
  <body class="font-sans">
    <div class="flex h-screen">
      <!-- Hauptbereich im gleichen Stil wie Fleet Database -->
      <div class="flex-grow flex flex-col content-container">
        <!-- Header removed when embedded as iframe -->

        <!-- Content container (transparent background to inherit from parent) -->
        <div class="flex-grow p-3 overflow-auto">
          <!-- Airport Flights Controls (im Fleet-Filter-Stil) -->
          <div class="mb-3 bg-gray-50 p-3 rounded-lg fleet-filters-enhanced">
            <h2 id="airportFlightsHeading" class="text-lg font-semibold text-industrial-dark mb-3">Flights on Station MUC</h2>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
              <!-- Airport -->
              <div>
                <label for="airportCodeInput" class="block text-sm font-medium text-gray-800 mb-1 whitespace-nowrap">Airport (IATA)</label>
                <input id="airportCodeInput" type="text" maxlength="3" value="MUC" placeholder="e.g., MUC" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white text-gray-900 uppercase focus:ring-2 focus:ring-industrial-accent focus:border-industrial-accent" style="text-transform: uppercase" />
              </div>
              <!-- Date -->
              <div>
                <label for="flightDateInput" class="block text-sm font-medium text-gray-800 mb-1 whitespace-nowrap">Date</label>
                <input id="flightDateInput" type="date" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white text-gray-900 focus:ring-2 focus:ring-industrial-accent focus:border-industrial-accent" />
              </div>
              <!-- Registration filter -->
              <div>
                <label for="flightRegFilter" class="block text-sm font-medium text-gray-800 mb-1 whitespace-nowrap">Registration</label>
                <input id="flightRegFilter" type="text" placeholder="e.g., D-AIZZ" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white text-gray-900 placeholder-gray-600 focus:ring-2 focus:ring-industrial-accent focus:border-industrial-accent" />
              </div>
              <!-- Flight number filter -->
              <div>
                <label for="flightNumberFilter" class="block text-sm font-medium text-gray-800 mb-1 whitespace-nowrap">Flight number</label>
                <input id="flightNumberFilter" type="text" placeholder="e.g., LH1234" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white text-gray-900 placeholder-gray-600 focus:ring-2 focus:ring-industrial-accent focus:border-industrial-accent" />
              </div>
              <!-- Airline Code (optional) -->
              <div id="operatorFilterContainer">
                <label for="operatorCodeInput" class="block text-sm font-medium text-gray-800 mb-1 whitespace-nowrap">Airline Code (optional)</label>
                <input id="operatorCodeInput" type="text" maxlength="3" value="LH" placeholder="e.g., LH, DLH" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white text-gray-900 uppercase placeholder-gray-600 focus:ring-2 focus:ring-industrial-accent focus:border-industrial-accent" style="text-transform: uppercase" />
              </div>
              <!-- Action -->
              <div class="flex items-end justify-end">
                <button id="showAirportFlightsBtn" class="fleet-action-btn-enhanced fleet-action-btn-primary self-end">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  Reload
                </button>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2">Enter an ICAO/IATA code to filter by airline</p>
            <div class="text-sm text-gray-600 mt-2">Ready to load flight data…</div>
          </div>

          <!-- Host container for dynamic timetable content -->
          <div id="airport-flights-host" class="mt-2"></div>

        </div>
      </div>
    </div>

    <!-- JavaScript-Dateien (wie Fleet Database + Timetable spezifisch) -->
    <script src="js/helpers.js"></script>
    <script src="js/aerodatabox-api.js"></script>
    <script src="js/goflightlabs-api.js"></script>
    <script src="js/flight-registration-lookup.js"></script>
    <script src="js/fleet-database-manager.js"></script>
    <script src="js/airport-flights.js"></script>
    <script src="js/timetable-reload-adapter.js"></script>

    <!-- Simple filter logic (back navigation removed) -->
    <script>
      // Update Heading with selected station
      function updateAirportFlightsHeading(){
        const code = (document.getElementById('airportCodeInput')?.value || '---').toUpperCase();
        const h = document.getElementById('airportFlightsHeading');
        if (h) h.textContent = `Flights on Station ${code}`;
      }
      document.getElementById('airportCodeInput')?.addEventListener('input', updateAirportFlightsHeading);
      // Default date today
      const dateEl = document.getElementById('flightDateInput');
      if (dateEl && !dateEl.value) {
        dateEl.value = new Date().toISOString().split('T')[0];
      }
      updateAirportFlightsHeading();

      // Einfache Client-Filter für Airport Flights Tabellen
      function applyAirportFlightsFilters() {
        const regFilter = (document.getElementById('flightRegFilter')?.value || '').trim().toUpperCase();
        const fnFilter = (document.getElementById('flightNumberFilter')?.value || '').trim().toUpperCase();
        const opFilter = (document.getElementById('operatorCodeInput')?.value || '').trim().toUpperCase();
        const container = document.getElementById('airport-flights-container');
        if (!container) return;
        const rows = container.querySelectorAll('table tbody tr');
        rows.forEach(row => {
          const regCell = row.querySelector('.flight-reg');
          const numCell = row.querySelector('.flight-number');
          const regText = (regCell?.textContent || '').toUpperCase();
          const numText = (numCell?.textContent || '').toUpperCase();
          const airlineIata = (row.dataset.airlineIata || '').toUpperCase();
          const airlineIcao = (row.dataset.airlineIcao || '').toUpperCase();
          const matchesReg = !regFilter || regText.includes(regFilter);
          const matchesNum = !fnFilter || numText.includes(fnFilter);
          const matchesOp = !opFilter || airlineIata.includes(opFilter) || airlineIcao.includes(opFilter) || numText.startsWith(opFilter);
          row.style.display = (matchesReg && matchesNum && matchesOp) ? '' : 'none';
        });
      }
      ['flightRegFilter', 'flightNumberFilter', 'operatorCodeInput'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', applyAirportFlightsFilters);
      });
      const flightsObserver = new MutationObserver(() => applyAirportFlightsFilters());
      const observeTargetInit = () => {
        const target = document.getElementById('airport-flights-container');
        if (target) flightsObserver.observe(target, { childList: true, subtree: true });
      };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', observeTargetInit);
      } else {
        observeTargetInit();
      }

      // Listen for theme broadcasts and storage updates to sync dark mode immediately
      (function(){
        function apply(dark){
          try {
            document.documentElement.classList.toggle('dark-mode', !!dark);
            if (document.body) document.body.classList.toggle('dark-mode', !!dark);
          } catch(e){}
        }
        window.addEventListener('message', function(e){
          try { if (e && e.data && e.data.type === 'theme') apply(!!e.data.dark); } catch(_e){}
        });
        window.addEventListener('storage', function(ev){
          if (!ev) return;
          if (ev.key === 'hangar.theme' || ev.key === 'displayOptions') {
            try {
              var t = (localStorage.getItem('hangar.theme')||'').toLowerCase();
              var isDark = (t === 'dark') || (t !== 'light' && (function(){ try { var raw = localStorage.getItem('displayOptions'); if (raw) { var p = JSON.parse(raw); return !!p.darkMode; } } catch(e){} return false; })());
              apply(isDark);
            } catch(e){}
          }
        });
      })();
    </script>
  </body>
</html>

