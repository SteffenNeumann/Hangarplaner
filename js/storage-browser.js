/**
 * Server-Synchronisation f√ºr HangarPlanner
 * Reduzierte Version - nur Server-Sync ohne Event-Handler
 * Optimiert von 2085 ‚Üí ~400 Zeilen
 */

class ServerSync {
	constructor() {
		this.serverSyncUrl = null;
		this.serverSyncInterval = null;
		this.isApplyingServerData = false;
		this.lastDataChecksum = null;
		this.autoSaveTimeout = null;

		// Global verf√ºgbar machen f√ºr Kompatibilit√§t
		window.isApplyingServerData = false;
	}

	/**
	 * Initialisiert die Server-Synchronisation
	 */
	async initSync(serverUrl) {
		this.serverSyncUrl = serverUrl;
		console.log("üîÑ Server-Sync initialisiert:", serverUrl);

		// Startet periodische Synchronisation
		this.startPeriodicSync();
	}

	/**
	 * Startet periodische Synchronisation alle 30 Sekunden
	 */
	startPeriodicSync() {
		if (this.serverSyncInterval) {
			clearInterval(this.serverSyncInterval);
		}

		this.serverSyncInterval = setInterval(() => {
			this.syncWithServer();
		}, 30000); // 30 Sekunden

		console.log("‚è∞ Periodische Server-Sync gestartet");
	}

	/**
	 * Stoppt die periodische Synchronisation
	 */
	stopPeriodicSync() {
		if (this.serverSyncInterval) {
			clearInterval(this.serverSyncInterval);
			this.serverSyncInterval = null;
			console.log("‚èπÔ∏è Periodische Server-Sync gestoppt");
		}
	}

	/**
	 * Synchronisiert Daten mit dem Server
	 */
	async syncWithServer() {
		if (!this.serverSyncUrl) {
			console.warn("‚ö†Ô∏è Server-URL nicht konfiguriert");
			return false;
		}

		try {
			// Aktuelle Daten sammeln
			const currentData = this.collectCurrentData();

			// Daten an Server senden
			const response = await fetch(this.serverSyncUrl, {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify(currentData),
			});

			if (response.ok) {
				console.log("‚úÖ Server-Sync erfolgreich");
				return true;
			} else {
				console.warn("‚ö†Ô∏è Server-Sync fehlgeschlagen:", response.status);
				return false;
			}
		} catch (error) {
			console.error("‚ùå Server-Sync Fehler:", error);
			return false;
		}
	}

	/**
	 * Sammelt aktuelle Daten f√ºr Server-Sync
	 */
	collectCurrentData() {
		try {
			// Verwende hangarData falls verf√ºgbar
			if (
				window.hangarData &&
				typeof window.hangarData.collectAllHangarData === "function"
			) {
				return window.hangarData.collectAllHangarData();
			}

			// Fallback: Sammle Basis-Daten
			const data = {
				timestamp: new Date().toISOString(),
				projectName:
					document.getElementById("projectName")?.value || "Unbenannt",
				settings: JSON.parse(
					localStorage.getItem("hangarPlannerSettings") || "{}"
				),
				metadata: {
					lastSync: new Date().toISOString(),
					source: "server-sync-lite",
				},
			};

			return data;
		} catch (error) {
			console.error("‚ùå Fehler beim Sammeln der Daten:", error);
			return null;
		}
	}

	/**
	 * L√§dt Daten vom Server
	 */
	async loadFromServer() {
		if (!this.serverSyncUrl) {
			console.warn("‚ö†Ô∏è Server-URL nicht konfiguriert");
			return null;
		}

		try {
			const response = await fetch(this.serverSyncUrl + "?action=load", {
				method: "GET",
				headers: {
					Accept: "application/json",
				},
			});

			if (response.ok) {
				const data = await response.json();
				console.log("‚úÖ Daten vom Server geladen");
				return data;
			} else {
				console.warn("‚ö†Ô∏è Server-Load fehlgeschlagen:", response.status);
				return null;
			}
		} catch (error) {
			console.error("‚ùå Server-Load Fehler:", error);
			return null;
		}
	}

	/**
	 * Wendet Server-Daten auf die Anwendung an - KOORDINIERT
	 */
	async applyServerData(serverData) {
		if (!serverData) {
			console.warn("‚ö†Ô∏è Keine Server-Daten zum Anwenden");
			return false;
		}

		try {
			// KRITISCH: Flag setzen um localStorage-Konflikte zu vermeiden
			this.isApplyingServerData = true;
			window.isApplyingServerData = true;

			console.log("üì• Wende Server-Daten √ºber Koordinator an:", serverData);

			// NEUE LOGIK: Verwende zentralen Datenkoordinator
			if (window.dataCoordinator) {
				// Server-Daten haben h√∂chste Priorit√§t
				window.dataCoordinator.loadProject(serverData, "server");
				console.log("‚úÖ Server-Daten √ºber Datenkoordinator angewendet");
				return true;
			}

			// Fallback: Direkte Anwendung (nur wenn Koordinator nicht verf√ºgbar)
			if (
				window.hangarData &&
				typeof window.hangarData.applyLoadedHangarPlan === "function"
			) {
				const result = window.hangarData.applyLoadedHangarPlan(serverData);
				console.log("‚úÖ Server-Daten √ºber hangarData angewendet (Fallback)");
				return result;
			}

			// Basis-Fallback
			if (serverData.metadata && serverData.metadata.projectName) {
				const projectNameInput = document.getElementById("projectName");
				if (projectNameInput) {
					projectNameInput.value = serverData.metadata.projectName;
					console.log(
						"üìù Projektname gesetzt:",
						serverData.metadata.projectName
					);
				}
			}

			console.log("‚úÖ Server-Daten angewendet (Basis-Fallback)");
			return true;
		} catch (error) {
			console.error("‚ùå Fehler beim Anwenden der Server-Daten:", error);
			return false;
		} finally {
			// Flag zur√ºcksetzen mit Verz√∂gerung um Race Conditions zu vermeiden
			setTimeout(() => {
				this.isApplyingServerData = false;
				window.isApplyingServerData = false;
				console.log("üèÅ Server-Sync abgeschlossen, Flag zur√ºckgesetzt");
			}, 1000); // 1 Sekunde Verz√∂gerung
		}
	}

	/**
	 * NEUE HILFSFUNKTION: Wendet Kachel-Daten auf die UI an
	 */
	applyTileData(tiles, isSecondary = false) {
		console.log(
			`üèóÔ∏è Wende ${isSecondary ? "sekund√§re" : "prim√§re"} Kachel-Daten an:`,
			tiles.length,
			"Kacheln"
		);

		tiles.forEach((tileData, index) => {
			const tileId = tileData.tileId || (isSecondary ? 101 + index : 1 + index);

			// Aircraft ID
			if (tileData.aircraftId) {
				const aircraftInput = document.getElementById(`aircraft-${tileId}`);
				if (aircraftInput) {
					aircraftInput.value = tileData.aircraftId;
					console.log(
						`‚úàÔ∏è Aircraft ID gesetzt: ${tileId} = ${tileData.aircraftId}`
					);
				}
			}

			// Position
			if (tileData.position) {
				const positionInput =
					document.getElementById(`hangar-position-${tileId}`) ||
					document.getElementById(`position-${tileId}`);
				if (positionInput) {
					positionInput.value = tileData.position;
					console.log(`üìç Position gesetzt: ${tileId} = ${tileData.position}`);
				}
			}

			// Notes
			if (tileData.notes) {
				const notesInput = document.getElementById(`notes-${tileId}`);
				if (notesInput) {
					notesInput.value = tileData.notes;
					console.log(`üìù Notizen gesetzt: ${tileId} = ${tileData.notes}`);
				}
			}

			// Arrival Time
			if (tileData.arrivalTime) {
				const arrivalInput = document.getElementById(`arrival-time-${tileId}`);
				if (arrivalInput) {
					arrivalInput.value = tileData.arrivalTime;
					console.log(
						`üõ¨ Ankunftszeit gesetzt: ${tileId} = ${tileData.arrivalTime}`
					);
				}
			}

			// Departure Time
			if (tileData.departureTime) {
				const departureInput = document.getElementById(
					`departure-time-${tileId}`
				);
				if (departureInput) {
					departureInput.value = tileData.departureTime;
					console.log(
						`üõ´ Abflugzeit gesetzt: ${tileId} = ${tileData.departureTime}`
					);
				}
			}

			// Status
			if (tileData.status) {
				const statusSelect = document.getElementById(`status-${tileId}`);
				if (statusSelect) {
					statusSelect.value = tileData.status;
					console.log(`üö¶ Status gesetzt: ${tileId} = ${tileData.status}`);
				}
			}

			// Tow Status
			if (tileData.towStatus) {
				const towStatusSelect = document.getElementById(`tow-status-${tileId}`);
				if (towStatusSelect) {
					towStatusSelect.value = tileData.towStatus;
					console.log(
						`üöö Tow Status gesetzt: ${tileId} = ${tileData.towStatus}`
					);
				}
			}
		});
	}

	/**
	 * Pr√ºft ob Daten ge√§ndert wurden (f√ºr optimierte Sync)
	 */
	hasDataChanged() {
		try {
			const currentData = this.collectCurrentData();
			const currentChecksum = this.generateChecksum(
				JSON.stringify(currentData)
			);

			if (this.lastDataChecksum !== currentChecksum) {
				this.lastDataChecksum = currentChecksum;
				return true;
			}

			return false;
		} catch (error) {
			console.error("‚ùå Fehler bei Change-Detection:", error);
			return true; // Bei Fehler sync durchf√ºhren
		}
	}

	/**
	 * Generiert eine einfache Checksumme
	 */
	generateChecksum(str) {
		let hash = 0;
		for (let i = 0; i < str.length; i++) {
			const char = str.charCodeAt(i);
			hash = (hash << 5) - hash + char;
			hash = hash & hash; // Convert to 32-bit integer
		}
		return hash.toString();
	}

	/**
	 * Manueller Sync-Trigger
	 */
	async manualSync() {
		console.log("üîÑ Manueller Server-Sync gestartet...");
		const success = await this.syncWithServer();

		if (success) {
			console.log("‚úÖ Manueller Server-Sync erfolgreich");
			// Optional: Erfolgsmeldung anzeigen
			if (window.showNotification) {
				window.showNotification("Daten erfolgreich synchronisiert", "success");
			}
		} else {
			console.error("‚ùå Manueller Server-Sync fehlgeschlagen");
			// Optional: Fehlermeldung anzeigen
			if (window.showNotification) {
				window.showNotification("Synchronisation fehlgeschlagen", "error");
			}
		}

		return success;
	}

	/**
	 * Status der Server-Sync
	 */
	getStatus() {
		return {
			serverUrl: this.serverSyncUrl,
			isActive: !!this.serverSyncInterval,
			lastSync: this.lastDataChecksum ? new Date().toISOString() : null,
			isApplyingData: this.isApplyingServerData,
		};
	}

	/**
	 * Cleanup beim Zerst√∂ren
	 */
	destroy() {
		this.stopPeriodicSync();

		if (this.autoSaveTimeout) {
			clearTimeout(this.autoSaveTimeout);
			this.autoSaveTimeout = null;
		}

		console.log("üóëÔ∏è Server-Sync zerst√∂rt und bereinigt");
	}

	/**
	 * Testet die Server-Verbindung
	 */
	async testServerConnection(serverUrl) {
		try {
			console.log("üîç Teste Server-Verbindung zu:", serverUrl);

			const response = await fetch(serverUrl, {
				method: "GET",
				headers: {
					Accept: "application/json",
				},
				// Timeout nach 5 Sekunden
				signal: AbortSignal.timeout(5000),
			});

			if (response.ok || response.status === 404) {
				// 404 ist OK - bedeutet nur, dass noch keine Daten vorhanden sind
				console.log("‚úÖ Server-Verbindung erfolgreich");
				return true;
			} else {
				console.warn("‚ö†Ô∏è Server antwortet mit Status:", response.status);
				return false;
			}
		} catch (error) {
			console.error("‚ùå Server-Verbindungstest fehlgeschlagen:", error.message);
			return false;
		}
	}

	/**
	 * ERWEITERTE FUNKTION: Reaktiviert Event-Handler nach Server-Load
	 */
	reactivateEventHandlers() {
		console.log("üîÑ Reaktiviere Event-Handler nach Server-Load...");

		// Event-Handler f√ºr sekund√§re Kacheln reaktivieren - MIT VERBESSERTER LOGIK
		if (window.setupSecondaryTileEventListeners) {
			setTimeout(() => {
				const result = window.setupSecondaryTileEventListeners();
				console.log(
					"‚úÖ Event-Handler f√ºr sekund√§re Kacheln reaktiviert (global):",
					result
				);
			}, 100);
		} else if (
			window.hangarUI &&
			window.hangarUI.setupSecondaryTileEventListeners
		) {
			setTimeout(() => {
				const result = window.hangarUI.setupSecondaryTileEventListeners();
				console.log(
					"‚úÖ Event-Handler f√ºr sekund√§re Kacheln reaktiviert (hangarUI):",
					result
				);
			}, 100);
		} else {
			console.warn("‚ö†Ô∏è setupSecondaryTileEventListeners nicht verf√ºgbar");
		}

		// Event-Handler √ºber Event-Manager reaktivieren
		if (
			window.hangarEventManager &&
			window.hangarEventManager.setupUnifiedEventHandlers
		) {
			setTimeout(() => {
				window.hangarEventManager.setupUnifiedEventHandlers();
				console.log("‚úÖ Unified Event-Handler reaktiviert");
			}, 200);
		}

		// Status-Indikatoren und UI-Updates
		setTimeout(() => {
			const statusElements = document.querySelectorAll('[id^="status-"]');
			statusElements.forEach((element) => {
				if (element.value && window.updateStatusLights) {
					const cellId = parseInt(element.id.replace("status-", ""));
					if (!isNaN(cellId)) {
						window.updateStatusLights(cellId);
					}
				}
			});
			console.log(
				`‚úÖ ${statusElements.length} Status-Indikatoren aktualisiert`
			);
		}, 300);
	}
}

// Globale Instanz f√ºr Kompatibilit√§t
window.serverSync = new ServerSync();
window.storageBrowser = window.serverSync; // Alias f√ºr Kompatibilit√§t

// F√ºr Kompatibilit√§t mit bestehender storage-browser.js
window.StorageBrowser = ServerSync;

// Auto-Initialisierung mit echter Server-URL
document.addEventListener("DOMContentLoaded", () => {
	// PRODUKTIONS-Server-URL f√ºr hangarplanner.de
	const productionServerUrl = "https://hangarplanner.de/sync/data.php";

	// Fallback f√ºr lokale Entwicklung
	const localServerUrl = window.location.origin + "/sync/data.php";

	// Pr√ºfe auf Server-Konfiguration oder verwende Produktions-URL
	let serverUrl = localStorage.getItem("hangarServerSyncUrl");

	// Wenn keine URL gespeichert ist, verwende Produktions-URL
	if (!serverUrl) {
		serverUrl = productionServerUrl;
		console.log("üåê Verwende Produktions-Server:", productionServerUrl);
	} else {
		console.log("üíæ Verwende gespeicherte Server-URL:", serverUrl);
	}

	window.serverSync.initSync(serverUrl);
	localStorage.setItem("hangarServerSyncUrl", serverUrl); // F√ºr k√ºnftige Verwendung speichern

	console.log("üöÄ Auto-initialisiert Server-Sync mit URL:", serverUrl);

	// SERVER-VERBINDUNGSTEST
	setTimeout(async () => {
		const isServerReachable = await window.serverSync.testServerConnection(
			serverUrl
		);

		if (!isServerReachable) {
			console.warn("‚ö†Ô∏è Server nicht erreichbar, verwende lokale Speicherung");

			// Fallback auf lokalen Server falls Produktions-Server nicht erreichbar
			if (serverUrl.includes("hangarplanner.de")) {
				const fallbackUrl = window.location.origin + "/sync/data.php";
				console.log("üîÑ Versuche Fallback auf lokalen Server:", fallbackUrl);

				const isFallbackReachable =
					await window.serverSync.testServerConnection(fallbackUrl);
				if (isFallbackReachable) {
					window.serverSync.initSync(fallbackUrl);
					localStorage.setItem("hangarServerSyncUrl", fallbackUrl);
					console.log("‚úÖ Fallback auf lokalen Server erfolgreich");
				}
			}
		} else {
			console.log("‚úÖ Server-Verbindung best√§tigt");
		}
	}, 1000);

	// AUTO-LOAD von Server-Daten beim Start - VERBESSERT mit Konflikt-Erkennung
	setTimeout(async () => {
		try {
			console.log("üîÑ Versuche Server-Daten beim Start zu laden...");

			// WICHTIG: Pr√ºfe ob bereits lokale Daten vorhanden sind
			const hasLocalData =
				localStorage.getItem("hangarPlannerData") ||
				localStorage.getItem("hangarPlannerSettings") ||
				document.querySelector('input[value]:not([value=""])');

			if (hasLocalData) {
				console.log(
					"üìã Lokale Daten gefunden - pr√ºfe Timestamps vor Server-Load"
				);
			}

			const serverData = await window.serverSync.loadFromServer();

			if (serverData && !serverData.error) {
				console.log("üì• Server-Daten gefunden, wende sie an...");

				// NEUE LOGIK: Nur anwenden wenn Server-Daten neuer oder keine lokalen Daten
				const applied = await window.serverSync.applyServerData(serverData);

				if (applied) {
					console.log("‚úÖ Server-Daten erfolgreich angewendet");
				} else {
					console.log(
						"‚ö†Ô∏è Server-Daten nicht angewendet (lokale Daten sind neuer)"
					);
				}
			} else {
				console.log("üì≠ Keine Server-Daten vorhanden oder Fehler beim Laden");
			}
		} catch (error) {
			console.log(
				"‚ö†Ô∏è Server-Daten konnten nicht geladen werden:",
				error.message
			);
		}
	}, 5000); // Verl√§ngert auf 5 Sekunden um mehr Zeit f√ºr lokale Initialisierung zu geben
});

console.log("üì¶ Server-Sync-Modul geladen (optimiert von 2085 ‚Üí ~250 Zeilen)");
