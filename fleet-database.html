<!DOCTYPE html>
<html lang="de">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Fleet Database - HangarPlanner</title>

		<!-- Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>
		<!-- Inter font -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

		<!-- Early apply saved dark mode to avoid flicker and ensure persistence on subpages -->
		<script>
			(function(){
				try {
					var isDark = false;
					try { var t = (localStorage.getItem('hangar.theme')||'').toLowerCase(); if (t==='dark') isDark = true; if (t==='light') isDark = false; } catch(e) {}
					if (!isDark) {
						var raw = localStorage.getItem('displayOptions');
						if (raw) {
							var parsed = JSON.parse(raw);
							if (parsed && parsed.darkMode) { isDark = true; }
						}
					}
					if (isDark) {
						document.documentElement.classList.add('dark-mode');
						var applyBody = function(){ if (document.body) document.body.classList.add('dark-mode'); };
						if (document.readyState === 'loading') {
							document.addEventListener('DOMContentLoaded', applyBody);
						} else {
							applyBody();
						}
					}
				} catch (e) {}
			})();
		</script>

		<!-- Bestehende CSS-Dateien -->
		<link rel="stylesheet" href="css/hangarplanner-ui.css" />
		<link rel="stylesheet" href="css/info-widget.css" />
		<link rel="stylesheet" href="css/weather-widget.css" />
		<link rel="stylesheet" href="css/userinfo-widget.css" />
		<link rel="stylesheet" href="css/dark-mode-zoom.css" />
		<link rel="stylesheet" href="css/fleet-database.css" />
		<!-- MUST LOAD LAST: Override Tailwind table hover styles -->
		<link rel="stylesheet" href="css/table-hover-override.css" />

		<!-- Tailwind Konfiguration -->
		<script>
			tailwind.config = {
				theme: {
					extend: {
						fontFamily: { sans: ["Inter", "ui-sans-serif"] },
						colors: {
							"industrial-dark": "#2d3748",
							"industrial-medium": "#4a5568",
							"industrial-light": "#718096",
							"industrial-accent": "#ff7043",
						},
					},
				},
			};
		</script>
		<script>
			// Apply saved dark mode on subpage load
			document.addEventListener('DOMContentLoaded', function(){
				try {
					const raw = localStorage.getItem('displayOptions');
					if (raw) {
						const parsed = JSON.parse(raw);
						if (parsed && parsed.darkMode) {
							document.body.classList.add('dark-mode');
						}
					}
				} catch (e) {}
			});
			// Re-assert theme on BFCache return
			(function(){
				function syncTheme(){
					try {
						var t = (localStorage.getItem('hangar.theme')||'').toLowerCase();
						var isDark = false;
						if (t === 'dark') isDark = true; else if (t === 'light') isDark = false; else {
							try {
								var raw = localStorage.getItem('displayOptions');
								if (raw) { var parsed = JSON.parse(raw); if (parsed && parsed.darkMode) isDark = true; }
							} catch(e){}
						}
						document.documentElement.classList.toggle('dark-mode', isDark);
						if (document.body) document.body.classList.toggle('dark-mode', isDark);
					} catch(e){}
				}
				window.addEventListener('pageshow', syncTheme);
			})();
		</script>
	</head>
	<body class="font-sans">
		<div class="flex h-screen">
			<!-- Hauptbereich mit Flotten-Datenbank -->
			<div class="flex-grow flex flex-col content-container">
				<!-- Header removed when embedded as iframe -->

				<!-- Hauptinhalt (transparent background) -->
				<div class="flex-grow p-3 overflow-auto">
					<!-- Filter und Steuerungsbereich -->
					<div class="mb-6 bg-gray-50 p-4 rounded-lg fleet-filters-enhanced">
						<div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
							<!-- Airline Filter -->
							<div>
								<label
									for="airlineFilter"
									class="block text-sm font-medium text-gray-900 mb-1">
									Airline Filter
								</label>
								<select
									id="airlineFilter"
									class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white text-gray-900 focus:ring-2 focus:ring-industrial-accent focus:border-industrial-accent">
									<option value="all">Alle Airlines</option>
									<option value="CLH">CLH - Lufthansa CityLine</option>
									<option value="LHX">LHX - Lufthansa Private Jet</option>
								</select>
							</div>

							<!-- Flugzeugtyp Filter -->
							<div>
								<label
									for="aircraftTypeFilter"
									class="block text-sm font-medium text-gray-900 mb-1">
									Flugzeugtyp
								</label>
								<select
									id="aircraftTypeFilter"
									class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white text-gray-900 focus:ring-2 focus:ring-industrial-accent focus:border-industrial-accent">
									<option value="all">Alle Typen</option>
								</select>
							</div>

							<!-- Suchfeld -->
							<div>
								<label
									for="searchFilter"
									class="block text-sm font-medium text-gray-900 mb-1">
									Suche (Registrierung/Typ)
								</label>
								<input
									type="text"
									id="searchFilter"
									placeholder="z.B. D-AIZZ, A320"
									class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-industrial-accent focus:border-industrial-accent" />
							</div>

							<!-- Aktionen -->
							<div class="flex space-x-2">
								<button
									id="loadFleetData"
									class="fleet-action-btn-enhanced fleet-action-btn-primary">
									<svg
										class="w-4 h-4"
										fill="none"
										stroke="currentColor"
										viewBox="0 0 24 24">
										<path
											stroke-linecap="round"
											stroke-linejoin="round"
											stroke-width="2"
											d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
									</svg>
									Daten laden
								</button>
								<button
									id="exportFleetData"
									class="fleet-action-btn-enhanced fleet-action-btn-secondary">
									<svg
										class="w-4 h-4"
										fill="none"
										stroke="currentColor"
										viewBox="0 0 24 24">
										<path
											stroke-linecap="round"
											stroke-linejoin="round"
											stroke-width="2"
											d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
									</svg>
									Export
								</button>
							</div>
						</div>
					</div>

					<!-- Status- und Informationsbereich -->
					<div class="mb-4 flex justify-between items-center">
						<div id="fleetStatus" class="text-sm text-gray-600">
							Bereit zum Laden der Flottendaten...
						</div>
						<div id="fleetCount" class="text-sm font-medium text-gray-800">
							0 Flugzeuge geladen
						</div>
					</div>

					<!-- Tabellendarstellung -->
					<div class="bg-white rounded-lg shadow-lg overflow-hidden">
						<div class="overflow-x-auto">
							<table id="fleetTable" class="w-full">
								<thead class="bg-gray-100">
									<tr>
										<th
											class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
											data-sort="airline">
											Airline
											<span class="sort-indicator ml-1">↕</span>
										</th>
										<th
											class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
											data-sort="registration">
											Registrierung
											<span class="sort-indicator ml-1">↕</span>
										</th>
										<th
											class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
											data-sort="aircraftType">
											Flugzeugtyp
											<span class="sort-indicator ml-1">↕</span>
										</th>
										<th
											class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
											data-sort="serial">
											Seriennummer
											<span class="sort-indicator ml-1">↕</span>
										</th>
										<th
											class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
											data-sort="numSeats">
											Sitzplätze
											<span class="sort-indicator ml-1">↕</span>
										</th>
										<th
											class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
											data-sort="manufacturingYear">
											Baujahr
											<span class="sort-indicator ml-1">↕</span>
										</th>
										<th
											class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
											data-sort="firstFlightDate">
											Erstflug
											<span class="sort-indicator ml-1">↕</span>
										</th>
										<th
											class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
											data-sort="deliveryDate">
											Lieferung
											<span class="sort-indicator ml-1">↕</span>
										</th>
										<th
											class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
											data-sort="registrationDate">
											Registrierung
											<span class="sort-indicator ml-1">↕</span>
										</th>
										<th
											class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
											data-sort="ageYears">
											Alter (Jahre)
											<span class="sort-indicator ml-1">↕</span>
										</th>
										<th
											class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Aktionen
										</th>
									</tr>
								</thead>
								<tbody
									id="fleetTableBody"
									class="bg-white divide-y divide-gray-200">
									<!-- Daten werden hier dynamisch eingefügt -->
								</tbody>
							</table>
						</div>

						<!-- Leer-Status -->
						<div id="fleetTableEmpty" class="p-8 text-center text-gray-500">
							<svg
								class="mx-auto h-12 w-12 text-gray-400 mb-4"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24">
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
							</svg>
							<p class="text-base font-medium mb-2">
								Keine Flottendaten verfügbar
							</p>
							<p class="text-sm">
								Klicken Sie auf "Daten laden", um die Flottendaten abzurufen
							</p>
						</div>

						<!-- Loading Indicator -->
						<div id="fleetTableLoading" class="hidden p-8 text-center">
							<div class="flex justify-center items-center">
								<div
									class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mr-3"></div>
								<span class="text-gray-600">Lade Flottendaten...</span>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- JavaScript-Dateien -->
		<script src="js/helpers.js"></script>
		<script src="js/weather-api.js"></script>
		<script src="js/fleet-database-manager.js"></script>
		<script src="js/fleet-database.js"></script>

		<!-- Debug und Zeit-Update Script -->
		<script>
			// Debug-Funktionen für Fleet Database
			window.debugFleetDatabase = function () {
				console.log("🔍 Fleet Database Debug gestartet...");

				// Prüfe Fleet Database Manager
				if (!window.fleetDatabaseManager) {
					console.error("❌ Fleet Database Manager nicht verfügbar");
					return;
				}

				console.log("✅ Fleet Database Manager verfügbar");
				console.log("📊 Manager Zustand:", {
					isInitialized: window.fleetDatabaseManager.isInitialized,
					syncInProgress: window.fleetDatabaseManager.syncInProgress,
					apiEndpoint: window.fleetDatabaseManager.apiEndpoint,
				});

				// Teste Server-Verbindung
				fetch("sync/fleet-database.php?action=status")
					.then((response) => {
						console.log(
							"📡 Server Response:",
							response.status,
							response.statusText
						);
						return response.json();
					})
					.then((data) => {
						console.log("📊 Server-Status:", data);
					})
					.catch((error) => {
						console.error("❌ Server-Fehler:", error);
					});

				// Zeige Cache-Status
				const stats = window.fleetDatabaseManager.getStatistics();
				console.log("💾 Cache-Statistiken:", stats);
			};

			// Debug-Button zu Konsole hinzufügen
			console.log("🛠️ Debug-Funktion verfügbar: debugFleetDatabase()");

			function updateTimeDisplay() {
				const now = new Date();
				const localTime = now.toLocaleTimeString("de-DE", {
					hour: "2-digit",
					minute: "2-digit",
				});
				const utcTime = now.toUTCString().split(" ")[4].substring(0, 5);

				const localTimeElement = document.getElementById("local-time");
				const utcTimeElement = document.getElementById("utc-time");

				if (localTimeElement) {
					localTimeElement.textContent = localTime;
				}
				if (utcTimeElement) {
					utcTimeElement.textContent = utcTime;
				}
			}

			// Listen for theme broadcasts and storage updates to sync dark mode immediately
			(function(){
				function apply(dark){
					try {
						document.documentElement.classList.toggle('dark-mode', !!dark);
						if (document.body) document.body.classList.toggle('dark-mode', !!dark);
					} catch(e){}
				}
				window.addEventListener('message', function(e){
					try { if (e && e.data && e.data.type === 'theme') apply(!!e.data.dark); } catch(_e){}
				});
				window.addEventListener('storage', function(ev){
					if (!ev) return;
					if (ev.key === 'hangar.theme' || ev.key === 'displayOptions') {
						try {
							var t = (localStorage.getItem('hangar.theme')||'').toLowerCase();
							var isDark = (t === 'dark') || (t !== 'light' && (function(){ try { var raw = localStorage.getItem('displayOptions'); if (raw) { var p = JSON.parse(raw); return !!p.darkMode; } } catch(e){} return false; })());
							apply(isDark);
						} catch(e){}
					}
				});
			})();

			// Zeit-Update starten
			updateTimeDisplay();
			setInterval(updateTimeDisplay, 60000);
		</script>
	</body>
</html>
